# Story 6.2: Material Management Enhancement - Brownfield Enhancement

**Epic:** Lead Tracking Dashboard Enhancement
**Story Type:** Brownfield Enhancement
**Estimated Effort:** 5 days
**Priority:** HIGH
**Dependencies:** Story 6.1 (UTM Journey Tracking) must be complete

---

## User Story

**As a** Referrer, Affiliate, or Tax Preparer,
**I want** to easily create and manage promotional materials with automatic QR code generation and tracking,
**So that** I can track which specific materials (posters, flyers, business cards) generate the most leads.

---

## Story Context

### Existing System Integration

**Integrates with:**
- Existing `MarketingLink` model (prisma/schema.prisma:897-944)
- Existing `MarketingCampaign` model (prisma/schema.prisma:476-508)
- Existing `MarketingHub` component (src/components/MarketingHub.tsx)
- Existing marketing page (src/app/dashboard/referrer/marketing/page.tsx)
- Story 6.1 journey tracking (UTM generation)

**Technology:**
- `qrcode` npm package (for QR generation)
- Existing Cloudflare R2/AWS S3 for QR image storage
- Existing Material UI components (Card, Button, etc.)

**Follows pattern:**
- Existing material display pattern from MarketingHub
- Existing API route patterns (GET/POST/PATCH/DELETE)
- Existing file upload pattern from document upload

**Touch points:**
- Material creation form → generates MarketingLink + QR code
- Marketing hub library → displays real materials from database
- Dashboard analytics → shows material performance
- QR code download → stores to R2 bucket

---

## Acceptance Criteria

### Functional Requirements

1. **Material Creation Form**
   - Select material type (QR Poster, QR Flyer, QR Business Card, Email Link, Social Media Link, Digital Ad, SMS Link, Website Referral)
   - Enter campaign name (user-friendly label)
   - Enter location/placement (e.g., "Downtown Coffee Shop - Main St")
   - Optional notes field (distribution details)
   - Generate button creates MarketingLink + unique tracking code

2. **Automatic Tracking Code Generation**
   - Format: `{user_slug}_{material_type}_{random}`
   - Example: `john_qr_poster_x7k9m`
   - Generate full UTM URL: `https://taxgeniuspro.tax/start-filing?utm_source={userId}&utm_medium={materialType}&utm_campaign={campaignName}&utm_content={materialId}&utm_term={location}`

3. **QR Code Generation & Storage**
   - Generate QR code image (300x300px minimum)
   - Upload to R2/S3 storage automatically
   - Store public URL in `MarketingLink.qrCodeImageUrl`
   - Provide download buttons (PNG, SVG, PDF formats)

### Integration Requirements

4. **Existing MarketingHub component** displays real materials from database (not placeholders)
5. **Existing marketing page** shows created materials with performance metrics
6. **Journey tracking (Story 6.1)** captures clicks from generated URLs
7. **No breaking changes** to existing MarketingCampaign or MarketingLink models

### Quality Requirements

8. **Material creation** completes in < 3 seconds (including QR generation)
9. **QR codes** scan successfully on all major devices (iOS, Android)
10. **Material library** loads with pagination (50 items per page)
11. **Tests** cover creation, editing, deletion, QR generation

---

## Technical Notes

### Integration Approach

**Phase 1: Database Schema Enhancement**
- Add `location`, `notes`, `qrCodeImageUrl` fields to `MarketingLink` (if not present)
- Ensure `linkType` enum includes all spec material types

**Phase 2: Material Creation API**
- `POST /api/materials/create` - Creates MarketingLink + generates QR
- Uses existing link-tracking.service pattern
- Integrates with R2/S3 upload utility

**Phase 3: QR Code Generation Service**
- New service: `qr-code.service.ts`
- Uses `qrcode` npm package
- Generates PNG/SVG on demand
- Uploads to storage bucket

**Phase 4: UI Enhancement**
- Update `MarketingHub` to fetch/display real materials
- Add creation modal/form
- Add edit/delete functionality
- Show performance metrics from Story 6.1

### Existing Pattern Reference

```typescript
// Existing pattern (src/lib/services/link-tracking.service.ts:186-223)
export async function getCreatorLinkPerformance(
  creatorId: string,
  limit: number = 10
): Promise<LinkPerformance[]>

// Enhanced pattern (what we're building):
export async function createMaterialWithQR(params: {
  creatorId: string
  materialType: MaterialType
  campaignName: string
  location?: string
  notes?: string
  targetPage?: string
}): Promise<Material>
```

### Key Constraints

- **QR code size:** Optimize for < 50KB per image
- **Storage quota:** Monitor R2 usage, implement cleanup for old materials
- **Material limit:** Max 100 active materials per user (prevent abuse)
- **Performance:** QR generation < 2 seconds

---

## Definition of Done

- [x] Database schema updated with material-specific fields
- [x] Material creation API endpoint working
- [x] QR code generation service implemented
- [x] QR code upload to R2/S3 working
- [x] Material creation form UI complete
- [x] Material library displays real data
- [x] Edit material functionality working
- [x] Delete material functionality working
- [x] Download QR in multiple formats (PNG, SVG, PDF)
- [x] Material performance metrics displayed
- [x] Pagination for material library
- [x] Existing functionality regression tested
- [x] Unit tests for QR generation service
- [x] Integration tests for material CRUD
- [x] Documentation updated with material creation guide

---

## Risk and Compatibility Check

### Primary Risk
**R2/S3 storage costs** if users generate excessive QR codes

### Mitigation
- Implement per-user material limits (100 active max)
- Add material archiving (soft delete) to free up quota
- Compress QR images to < 50KB
- Implement cleanup job for unused materials > 6 months old

### Rollback
- Materials are additional feature, not core functionality
- Can disable creation via feature flag
- Existing MarketingLink records remain intact
- QR storage can be cleaned up independently

### Compatibility Verification
- [x] No breaking changes to existing MarketingLink API
- [x] Existing materials continue to display correctly
- [x] New fields are nullable (backward compatible)
- [x] UI changes are additive (existing pages still work)
- [x] Performance impact minimal (lazy-load QR images)

---

## Implementation Details

### Files to CREATE

```
/src/lib/services/qr-code.service.ts           - New: QR code generation & upload
/src/lib/services/material-management.service.ts - New: Material CRUD operations
/src/app/api/materials/create/route.ts         - New: Material creation endpoint
/src/app/api/materials/[id]/route.ts           - New: Material edit/delete endpoints
/src/app/api/materials/[id]/download/route.ts  - New: QR download endpoint
/src/components/materials/MaterialCreationModal.tsx - New: Creation form modal
/src/components/materials/MaterialCard.tsx      - New: Material display card
/src/components/materials/MaterialLibrary.tsx   - New: Paginated material list
/src/components/materials/QRCodeDownload.tsx    - New: Download options component
```

### Files to UPDATE

```
/prisma/schema.prisma                          - Add material fields to MarketingLink
/src/components/MarketingHub.tsx               - Replace placeholders with real data
/src/app/dashboard/referrer/marketing/page.tsx - Add material creation UI
/src/app/dashboard/affiliate/marketing/page.tsx - Add material creation UI
/src/lib/services/link-tracking.service.ts     - Integrate with material creation
```

### Database Migration

```prisma
// UPDATE existing MarketingLink model (prisma/schema.prisma:897-944)
model MarketingLink {
  // ... existing fields ...

  // NEW: Material-specific fields
  location       String?  // Where material is placed/distributed
  notes          String?  @db.Text // Distribution notes, renewal dates
  qrCodeImageUrl String?  // R2/S3 URL of generated QR code
  qrCodeFormat   String?  @default("PNG") // PNG, SVG, PDF

  // NEW: Material lifecycle
  dateActivated  DateTime? // When material was first distributed
  dateExpired    DateTime? // If material has expiration date
  printCount     Int @default(0) // How many times QR was downloaded

  // Enhanced metadata
  @@index([creatorId, isActive])
  @@index([linkType, isActive])
  @@index([createdAt])
}

// ENHANCE existing LinkType enum
enum LinkType {
  REFERRAL
  LANDING_PAGE
  QR_CODE        // Keep for backward compatibility
  SOCIAL_MEDIA
  EMAIL_CAMPAIGN
  BUSINESS_CARD
  FLYER
  CUSTOM

  // NEW: Specific QR types (matching spec)
  QR_POSTER
  QR_FLYER
  QR_BUSINESS_CARD
  QR_TABLE_TENT
  QR_BANNER
}
```

### API Endpoint: Create Material

**POST /api/materials/create**

Request:
```typescript
{
  materialType: LinkType
  campaignName: string
  location?: string
  notes?: string
  targetPage?: string // Default: "/start-filing"
  customization?: {
    brandColor?: string
    logoUrl?: string
    preparerInfo?: {
      name: string
      phone: string
      photo: string
    }
  }
}
```

Response:
```typescript
{
  material: {
    id: string
    trackingCode: string
    fullUrl: string
    qrCodeUrl: string
    shortUrl?: string
    createdAt: Date
  }
}
```

### QR Code Service

```typescript
// /src/lib/services/qr-code.service.ts

import QRCode from 'qrcode'
import { uploadToR2 } from '@/lib/storage/r2'

export async function generateAndUploadQR(params: {
  url: string
  materialId: string
  format?: 'PNG' | 'SVG'
  size?: number
  brandColor?: string
}): Promise<string> {
  // Generate QR code
  const qrOptions = {
    width: params.size || 300,
    margin: 2,
    color: {
      dark: params.brandColor || '#000000',
      light: '#FFFFFF'
    }
  }

  let qrData: Buffer | string

  if (params.format === 'SVG') {
    qrData = await QRCode.toString(params.url, { ...qrOptions, type: 'svg' })
  } else {
    qrData = await QRCode.toBuffer(params.url, { ...qrOptions, type: 'png' })
  }

  // Upload to R2
  const fileName = `qr-codes/${params.materialId}.${params.format?.toLowerCase() || 'png'}`
  const publicUrl = await uploadToR2(fileName, qrData, {
    contentType: params.format === 'SVG' ? 'image/svg+xml' : 'image/png'
  })

  return publicUrl
}

export async function generateQRPDF(params: {
  qrCodeUrl: string
  materialInfo: {
    campaignName: string
    preparerName?: string
    phone?: string
  }
}): Promise<Buffer> {
  // Generate PDF with QR code + branding
  // Use puppeteer or PDF library
  // Return PDF buffer for download
}
```

### Material Creation UI Flow

```typescript
// Component: MaterialCreationModal

1. User clicks "Create Material" button
2. Modal opens with form:
   - Material Type dropdown
   - Campaign Name input
   - Location input
   - Notes textarea
   - [Optional] Customization options
3. User clicks "Generate"
4. Loading state shows
5. API creates:
   - MarketingLink record
   - Generates unique tracking code
   - Creates UTM URL
   - Generates QR code image
   - Uploads QR to R2
   - Returns material object
6. Success message displays
7. Modal shows:
   - QR code preview
   - Tracking URL (copyable)
   - Download buttons (PNG, SVG, PDF)
   - Performance metrics (0 clicks initially)
8. Material appears in library
```

---

## Testing Strategy

### Unit Tests

```typescript
// /src/lib/services/__tests__/qr-code.test.ts
describe('QR Code Service', () => {
  it('should generate valid QR code PNG')
  it('should generate valid QR code SVG')
  it('should upload QR code to R2')
  it('should handle QR generation errors gracefully')
  it('should compress QR images to < 50KB')
})

// /src/lib/services/__tests__/material-management.test.ts
describe('Material Management Service', () => {
  it('should create material with tracking code')
  it('should generate unique tracking codes')
  it('should enforce material limits per user')
  it('should soft-delete materials')
})
```

### Integration Tests

```typescript
// /src/app/api/__tests__/material-crud.test.ts
describe('Material CRUD API', () => {
  it('should create material with QR code')
  it('should list user materials with pagination')
  it('should update material details')
  it('should delete (archive) material')
  it('should download QR in multiple formats')
})
```

### Manual Test Script

1. Login as Referrer
2. Navigate to Marketing Hub
3. Click "Create Material"
4. Fill form:
   - Type: QR Poster
   - Campaign: "Spring 2025 Downtown"
   - Location: "Atlanta Coffee - Main St"
   - Notes: "Posted on bulletin board"
5. Click "Generate"
6. Verify: QR code appears in < 3 seconds
7. Verify: Can download PNG, SVG, PDF
8. Verify: Tracking URL includes correct UTM params
9. Scan QR with phone → lands on correct page with UTM
10. Verify: Material appears in library with "0 clicks"
11. Click tracking link → verify click tracked (Story 6.1)
12. Verify: Material shows "1 click" after refresh

---

## Success Metrics

Story is complete when:

1. ✅ Material creation flow completes in < 3 seconds
2. ✅ QR codes scan successfully on iOS and Android
3. ✅ 100% of generated QR codes upload to R2/S3
4. ✅ Material library displays all created materials
5. ✅ Performance metrics update in real-time (from Story 6.1)
6. ✅ Edit/delete functionality works without errors
7. ✅ No regression in existing marketing page functionality

---

## Dependencies

**Depends on:**
- Story 6.1 (UTM Journey Tracking) - MUST be complete
- Existing R2/S3 upload utility
- Existing MarketingLink model

**Blocks:**
- Story 6.3 (Admin Analytics) - needs material data
- Story 6.4 (Role Dashboards) - needs material library
- Story 6.5 (Analytics & Reporting) - needs material comparison

---

## Implementation Order (Day-by-Day)

**Day 1: QR Code Service**
- Build `qr-code.service.ts`
- Implement PNG/SVG generation
- Test R2/S3 upload integration

**Day 2: Material Creation API**
- Build `POST /api/materials/create`
- Integrate QR generation
- Build tracking code generation logic

**Day 3: Material CRUD**
- Build edit/delete endpoints
- Build material listing endpoint with pagination
- Implement soft-delete logic

**Day 4: UI Components**
- Build MaterialCreationModal
- Build MaterialCard component
- Build MaterialLibrary with pagination
- Update MarketingHub with real data

**Day 5: Testing & Polish**
- Write unit tests
- Write integration tests
- Manual testing on mobile devices
- Update documentation

---

## Notes

- QR codes should be high-resolution for print (300 DPI minimum)
- Consider adding QR code analytics (scan location via IP geolocation)
- Future enhancement: Batch QR generation for campaigns
- Future enhancement: Template library for different industries

---

**Ready to implement?** This story transforms the placeholder marketing hub into a fully functional material management system with automatic QR code generation and tracking.
