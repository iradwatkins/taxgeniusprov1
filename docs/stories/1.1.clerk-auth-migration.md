# Story 1.1: Clerk Authentication Migration

## Status
Draft

## Story
**As a** platform administrator,
**I want** to migrate from Lucia authentication to Clerk,
**so that** we have a managed, secure authentication system with better user management capabilities and reduced maintenance overhead.

## Acceptance Criteria
1. Clerk.com account is set up and configured for taxgeniuspro.tax domain
2. Clerk SDK is installed and integrated into Next.js 15 App Router
3. All existing authentication routes (/auth/login, /auth/signup, /auth/verify) are updated to use Clerk
4. User sessions are managed via Clerk's JWT tokens
5. Role-based access control (Client, Referrer, Preparer) is implemented using Clerk's user metadata
6. Existing users can continue to access their accounts (migration path for Lucia users)
7. OAuth providers (Google) are configured and functional via Clerk
8. Magic link authentication is available as an alternative to password login
9. All authentication flows work correctly on both desktop and mobile browsers
10. Authentication state is properly managed in the Next.js app (middleware, protected routes)

## Tasks / Subtasks

### Setup & Configuration
- [ ] Create Clerk account and application (AC: 1)
  - [ ] Sign up at clerk.com
  - [ ] Create new application for Tax Genius
  - [ ] Configure application name and settings
  - [ ] Add taxgeniuspro.tax as authorized domain
- [ ] Install Clerk packages (AC: 2)
  - [ ] Run `npm install @clerk/nextjs`
  - [ ] Verify package installation in package.json
- [ ] Configure environment variables (AC: 2)
  - [ ] Add NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY to .env.local
  - [ ] Add CLERK_SECRET_KEY to .env.local
  - [ ] Add NEXT_PUBLIC_CLERK_SIGN_IN_URL=/auth/login
  - [ ] Add NEXT_PUBLIC_CLERK_SIGN_UP_URL=/auth/signup
  - [ ] Update .env.example with Clerk variables

### Integration
- [ ] Set up Clerk providers in Next.js (AC: 2, 10)
  - [ ] Wrap app with ClerkProvider in root layout.tsx
  - [ ] Configure Clerk middleware for protected routes
  - [ ] Test that Clerk loads correctly in browser
- [ ] Configure OAuth providers (AC: 7)
  - [ ] Enable Google OAuth in Clerk dashboard
  - [ ] Configure Google OAuth credentials
  - [ ] Test Google sign-in flow
- [ ] Enable magic link authentication (AC: 8)
  - [ ] Enable email magic links in Clerk dashboard
  - [ ] Configure email sending via Resend integration
  - [ ] Test magic link flow

### Role Management
- [ ] Implement role-based access with Clerk metadata (AC: 5)
  - [ ] Define role structure in Clerk user metadata (publicMetadata.role)
  - [ ] Create role selection UI during signup
  - [ ] Update user metadata on role selection
  - [ ] Create helper functions to get/check user roles
- [ ] Update dashboard routing for role-based access (AC: 5, 10)
  - [ ] Create middleware to check user role
  - [ ] Redirect users to correct dashboard based on role
  - [ ] Protect dashboard routes from unauthorized access

### Authentication Pages
- [ ] Update /auth/login page (AC: 3, 4)
  - [ ] Replace Lucia login with Clerk <SignIn /> component
  - [ ] Customize Clerk appearance to match Tax Genius branding
  - [ ] Test email/password login
  - [ ] Test OAuth login
- [ ] Update /auth/signup page (AC: 3, 4)
  - [ ] Replace Lucia signup with Clerk <SignUp /> component
  - [ ] Add role selection step after signup
  - [ ] Test signup flow end-to-end
- [ ] Update /auth/verify page (AC: 3)
  - [ ] Update email verification flow for Clerk
  - [ ] Handle verification tokens from Clerk
  - [ ] Test email verification process

### User Migration
- [ ] Plan Lucia to Clerk user migration (AC: 6)
  - [ ] Document existing Lucia users in database
  - [ ] Create migration script to import users to Clerk
  - [ ] Test migration with sample users
  - [ ] Plan communication strategy for existing users
- [ ] Implement user migration path (AC: 6)
  - [ ] Create one-time migration endpoint/script
  - [ ] Migrate user emails and hashed passwords (if possible)
  - [ ] Map user roles from Lucia to Clerk metadata
  - [ ] Send password reset emails to migrated users if needed

### Testing & Validation
- [ ] Test all authentication flows (AC: 9)
  - [ ] Email/password signup and login
  - [ ] Google OAuth signup and login
  - [ ] Magic link authentication
  - [ ] Email verification
  - [ ] Password reset flow
- [ ] Test on multiple devices/browsers (AC: 9)
  - [ ] Chrome desktop
  - [ ] Firefox desktop
  - [ ] Safari desktop
  - [ ] Chrome mobile (iOS)
  - [ ] Safari mobile (iOS)
  - [ ] Chrome mobile (Android)
- [ ] Test role-based access (AC: 5)
  - [ ] Client role redirects to /dashboard/client
  - [ ] Preparer role redirects to /dashboard/preparer
  - [ ] Referrer role redirects to /dashboard/referrer
  - [ ] Unauthorized access is blocked

### Cleanup
- [ ] Remove Lucia dependencies
  - [ ] Remove lucia and related packages from package.json
  - [ ] Remove Lucia configuration files
  - [ ] Remove Lucia session management code
  - [ ] Update imports throughout codebase
- [ ] Update documentation
  - [ ] Update tech-stack docs with Clerk
  - [ ] Mark migration complete in migrations/03-clerk-auth.md
  - [ ] Update README with new auth setup instructions

## Dev Notes

### Architecture Context

This story implements Migration 3 from the migration guide. The Tax Genius platform is moving from a custom Lucia-based authentication system to Clerk's managed authentication service.

**Why Clerk?**
- Managed service reduces maintenance burden
- Built-in user management UI
- Excellent Next.js 15 App Router integration
- Comprehensive webhook system for user events
- Better suited for SaaS/multi-tenancy
- Supports multiple auth methods (email/password, OAuth, magic links)

### Current State
- Next.js 15 App Router application
- Existing auth pages at /auth/* (currently using Lucia)
- Role-based dashboards already exist: /dashboard/client, /dashboard/preparer, /dashboard/referrer
- Database: PostgreSQL with Prisma ORM
- Email service: Resend (already configured)

### Technical Implementation Notes

**Clerk Integration Pattern:**
```typescript
// app/layout.tsx
import { ClerkProvider } from '@clerk/nextjs'

export default function RootLayout({ children }) {
  return (
    <ClerkProvider>
      <html lang="en">
        <body>{children}</body>
      </html>
    </ClerkProvider>
  )
}
```

**Middleware for Protected Routes:**
```typescript
// middleware.ts
import { authMiddleware } from "@clerk/nextjs";

export default authMiddleware({
  publicRoutes: ["/", "/about", "/pricing", "/contact"],
  ignoredRoutes: ["/api/webhooks/(.*)"]
});

export const config = {
  matcher: ["/((?!.+\\.[\\w]+$|_next).*)", "/", "/(api|trpc)(.*)"],
};
```

**Role Management:**
```typescript
// lib/auth.ts
import { auth, currentUser } from '@clerk/nextjs';

export async function getUserRole() {
  const user = await currentUser();
  return user?.publicMetadata?.role as 'client' | 'preparer' | 'referrer';
}
```

### File Structure
```
src/
├── app/
│   ├── layout.tsx                 # Add ClerkProvider
│   ├── auth/
│   │   ├── login/page.tsx        # Update with Clerk SignIn
│   │   ├── signup/page.tsx       # Update with Clerk SignUp
│   │   └── verify/page.tsx       # Update verification flow
│   └── dashboard/
│       ├── client/               # Protect with middleware
│       ├── preparer/             # Protect with middleware
│       └── referrer/             # Protect with middleware
├── middleware.ts                  # Create Clerk middleware
└── lib/
    └── auth.ts                    # Create auth helpers
```

### Database Considerations
- Keep existing `users` table in Prisma for application data
- Use Clerk user ID as foreign key reference
- Store Clerk user ID in `users.clerkId` field
- Sync user data via Clerk webhooks

### Migration Strategy
1. Install and configure Clerk alongside Lucia (both work temporarily)
2. Create new users with Clerk
3. Migrate existing Lucia users in batches
4. Once all users migrated, remove Lucia code
5. Monitor for any issues during transition

### Related Documentation
- [Clerk Next.js Documentation](https://clerk.com/docs/quickstarts/nextjs)
- [Migration Guide: Clerk Auth](../migrations/03-clerk-auth.md)
- [Tech Stack: Authentication](../tech-stack/authentication.md)
- [Architecture: Authentication](../architecture/05-authentication-clerk.md)

### Testing

**Testing Standards:**
- **Location:** Tests should be in `__tests__` directories next to the code they test
- **Framework:** Jest with React Testing Library for components
- **E2E:** Playwright for authentication flows
- **Coverage:** Aim for >80% coverage on authentication logic

**Test Files to Create:**
```
src/
├── app/
│   └── auth/
│       ├── __tests__/
│       │   ├── login.test.tsx
│       │   ├── signup.test.tsx
│       │   └── verify.test.tsx
│       └── ...
├── lib/
│   └── __tests__/
│       └── auth.test.ts
└── e2e/
    └── auth/
        ├── login.spec.ts
        ├── signup.spec.ts
        ├── oauth.spec.ts
        └── magic-link.spec.ts
```

**Critical Test Scenarios:**
1. User can sign up with email/password and select role
2. User can log in with email/password
3. User can log in with Google OAuth
4. User can log in with magic link
5. User is redirected to correct dashboard based on role
6. Protected routes are inaccessible without authentication
7. Session persists across page refreshes
8. User can log out successfully

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| Oct 9, 2025 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
