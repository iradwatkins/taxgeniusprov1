# Story 6.1: Complete UTM Journey Tracking - Brownfield Enhancement

**Epic:** Lead Tracking Dashboard Enhancement
**Story Type:** Brownfield Enhancement
**Estimated Effort:** 5 days
**Priority:** CRITICAL (Foundation for all other stories)

---

## User Story

**As a** Tax Genius Pro platform,
**I want** to track the complete customer journey from first click through tax return completion with UTM attribution,
**So that** we can accurately attribute conversions to specific marketing materials and calculate commissions.

---

## Story Context

### Existing System Integration

**Integrates with:**
- Existing `MarketingLink` and `LinkClick` models (prisma/schema.prisma:886-973)
- Existing `link-tracking.service.ts` (src/lib/services/link-tracking.service.ts)
- Existing intake form API (`src/app/api/tax-intake/lead/route.ts`)
- Existing status update API (`src/app/api/submissions/[id]/status/route.ts`)

**Technology:**
- PostgreSQL + Prisma ORM (already in use)
- Next.js API routes (already in use)
- Clerk auth for user attribution (already in use)

**Follows pattern:**
- Existing link tracking pattern (trackLinkClick, recordLinkConversion)
- Existing commission automation pattern (Epic 5 Story 5.2)

**Touch points:**
- Landing pages with UTM parameters
- Intake form submission flow
- Tax return status update flow
- Commission calculation system

---

## Acceptance Criteria

### Functional Requirements

1. **4-Stage Journey Tracking**
   - Capture `clicked_at` when user arrives via marketing link
   - Capture `intake_started_at` when user begins intake form
   - Capture `intake_completed_at` when user submits intake form
   - Capture `tax_return_completed_at` when preparer marks return as FILED

2. **UTM Parameter Persistence**
   - Extract UTM params on first page load: source, medium, campaign, content, term
   - Store in session/cookie for duration of user journey
   - Associate with LinkClick record for full attribution chain
   - Persist through authentication flow

3. **Material Attribution**
   - Link each journey stage to originating MarketingLink via tracking code
   - Support attribution even if user returns days/weeks later
   - Handle multiple touch points (last-touch attribution for MVP)

### Integration Requirements

4. **Existing intake form** continues to work unchanged
5. **Existing commission system** triggers on `tax_return_completed_at`
6. **Existing link tracking** enhanced with journey stages (not replaced)
7. No breaking changes to existing MarketingLink or LinkClick APIs

### Quality Requirements

8. **Journey stages** tracked with < 100ms overhead per stage
9. **UTM persistence** maintained through 30-day cookie expiration
10. **Database migrations** applied without data loss
11. **Tests** cover all 4 journey stages and UTM extraction

---

## Technical Notes

### Integration Approach

**Phase 1: Database Schema Enhancement**
- Extend `LinkClick` model with journey stage timestamps
- Add UTM term field for location tracking
- Add material ID foreign key for direct attribution
- Migration strategy: Add nullable fields, backfill where possible

**Phase 2: UTM Capture Middleware**
- Create Next.js middleware to extract UTM params from URL
- Store in encrypted cookie (httpOnly, secure, 30-day expiration)
- Retrieve UTM params on subsequent requests

**Phase 3: Journey Stage Tracking**
- Hook into existing `trackLinkClick` on landing page load
- Hook into intake form API to capture `intake_started_at`
- Hook into submission API to capture `intake_completed_at`
- Hook into status update API to capture `tax_return_completed_at`

**Phase 4: Analytics Aggregation**
- Update `MarketingLink` cached counters (intakeStarts, intakeCompletes, returnsFiled)
- Calculate conversion rates at each stage
- Enable funnel drop-off analysis

### Existing Pattern Reference

```typescript
// Current pattern (src/lib/services/link-tracking.service.ts:42-90)
export async function trackLinkClick(params: {
  linkCode: string
  ipAddress?: string
  // ... existing params
})

// Enhanced pattern (what we're building):
export async function trackJourneyStage(params: {
  trackingCode: string
  stage: 'CLICKED' | 'INTAKE_STARTED' | 'INTAKE_COMPLETED' | 'RETURN_FILED'
  userId?: string
  metadata?: Record<string, any>
})
```

### Key Constraints

- **Cookie size limit:** Keep UTM data < 4KB
- **Session expiration:** 30-day attribution window
- **Performance:** Journey tracking adds < 100ms latency
- **Privacy:** No PII in cookies, only tracking codes

---

## Definition of Done

- [x] Database schema extended with journey stage fields
- [x] Prisma migration created and tested
- [x] UTM extraction middleware implemented
- [x] Cookie-based UTM persistence working
- [x] Stage 1: Click tracking enhanced (already mostly works)
- [x] Stage 2: Intake start tracking added
- [x] Stage 3: Intake complete tracking added
- [x] Stage 4: Return filed tracking added
- [x] Cached counters on MarketingLink updating correctly
- [x] Conversion rates calculating accurately
- [x] Existing functionality regression tested (no breaks)
- [x] Unit tests for journey tracking service
- [x] Integration tests for full funnel flow
- [x] Documentation updated with UTM tracking guide

---

## Risk and Compatibility Check

### Primary Risk
**UTM attribution loss** if cookies are cleared or user switches devices

### Mitigation
- 30-day cookie expiration gives reasonable attribution window
- Store trackingCode in session + cookie for redundancy
- For logged-in users, store last known UTM in profile metadata
- Accept that some attribution will be lost (industry standard)

### Rollback
- Migration is additive only (nullable fields)
- Can disable journey tracking via feature flag
- Existing link tracking continues to work independently
- No data loss if rollback needed

### Compatibility Verification
- [x] No breaking changes to existing MarketingLink API
- [x] LinkClick records remain backward compatible
- [x] Existing commission triggers still fire correctly
- [x] Database changes are additive only (no column removal)
- [x] UI changes are progressive enhancement only
- [x] Performance impact < 100ms per request

---

## Implementation Details

### Files to CREATE

```
/src/middleware/utm-tracking.ts          - New: UTM extraction middleware
/src/lib/services/journey-tracking.ts    - New: Journey stage tracking service
/src/lib/utils/utm-parser.ts             - New: UTM parameter utilities
/src/lib/utils/cookie-manager.ts         - New: Encrypted cookie helper
```

### Files to UPDATE

```
/prisma/schema.prisma                            - Add journey stage fields
/src/lib/services/link-tracking.service.ts       - Enhance with journey stages
/src/app/api/tax-intake/lead/route.ts            - Hook intake start tracking
/src/app/api/submissions/route.ts                - Hook intake complete tracking
/src/app/api/submissions/[id]/status/route.ts    - Hook return filed tracking
/src/middleware.ts                                - Add UTM extraction
```

### Database Migration

```prisma
// ADD to existing LinkClick model (prisma/schema.prisma:946-973)
model LinkClick {
  // ... existing fields ...

  // NEW: Journey stage timestamps
  intakeStartedAt      DateTime?
  intakeCompletedAt    DateTime?
  taxReturnCompletedAt DateTime?

  // NEW: Enhanced UTM tracking
  utmTerm              String?   // Location/placement

  // NEW: Direct material attribution
  materialId           String?   // For backward compatibility

  // Enhanced indexes
  @@index([linkId, clickedAt])
  @@index([converted, signedUp])
  @@index([materialId])
}

// UPDATE existing MarketingLink model (prisma/schema.prisma:897-944)
model MarketingLink {
  // ... existing fields ...

  // NEW: Journey stage counters (cached for performance)
  intakeStarts    Int @default(0)
  intakeCompletes Int @default(0)
  returnsFiled    Int @default(0)

  // NEW: Conversion rate caching
  intakeConversionRate    Float? // (intakeStarts / clicks) * 100
  completeConversionRate  Float? // (intakeCompletes / clicks) * 100
  filedConversionRate     Float? // (returnsFiled / clicks) * 100
}
```

### API Endpoint Enhancements

**POST /api/tracking/journey-stage** (NEW)
```typescript
{
  trackingCode: string     // From cookie or URL param
  stage: 'INTAKE_STARTED' | 'INTAKE_COMPLETED' | 'RETURN_FILED'
  userId?: string          // If authenticated
  metadata?: {
    formFields?: number    // For intake tracking
    returnAmount?: number  // For commission calculation
  }
}
```

Response:
```typescript
{
  success: boolean
  journeyStage: string
  attribution: {
    materialId: string
    materialType: string
    creatorId: string
  }
}
```

### UTM Cookie Structure

```typescript
// Encrypted cookie: __tgp_utm
{
  source: string       // utm_source (user_id or campaign)
  medium: string       // utm_medium (material type)
  campaign: string     // utm_campaign (campaign name)
  content: string      // utm_content (material ID)
  term: string         // utm_term (location)
  firstTouch: number   // Timestamp of first click
  lastTouch: number    // Timestamp of last interaction
  trackingCode: string // Unique code for this journey
}
```

---

## Testing Strategy

### Unit Tests

```typescript
// /src/lib/services/__tests__/journey-tracking.test.ts
describe('Journey Tracking Service', () => {
  it('should track intake start with UTM attribution')
  it('should track intake completion and update counters')
  it('should track return filed and trigger commission')
  it('should handle missing UTM gracefully')
  it('should calculate conversion rates correctly')
})
```

### Integration Tests

```typescript
// /src/app/api/__tests__/journey-flow.test.ts
describe('Full Journey Flow', () => {
  it('should attribute intake to marketing link via UTM')
  it('should maintain attribution through authentication')
  it('should update all journey stages in sequence')
  it('should trigger commission on return filed')
})
```

### Manual Test Script

1. Visit: `https://taxgeniuspro.tax/start-filing?utm_source=ref_001&utm_medium=qr_poster&utm_campaign=spring_2025&utm_content=poster_123&utm_term=atlanta_coffee`
2. Verify: Cookie `__tgp_utm` is set with correct values
3. Start intake form → Verify: `intake_started_at` recorded in database
4. Complete intake form → Verify: `intake_completed_at` recorded
5. Admin marks return FILED → Verify: `tax_return_completed_at` recorded
6. Check: MarketingLink counters updated correctly
7. Check: Commission created with correct attribution

---

## Success Metrics

Story is complete when:

1. ✅ 100% of link clicks tracked with UTM parameters
2. ✅ 90%+ of intake starts attributed to marketing links
3. ✅ 85%+ of intake completes attributed (some cookie loss expected)
4. ✅ 95%+ of returns filed attributed (authenticated users)
5. ✅ Journey stage tracking adds < 100ms latency
6. ✅ No regression in existing link tracking functionality
7. ✅ Conversion funnel queries return accurate data

---

## Dependencies

**Depends on:**
- None (this is the foundation story)

**Blocks:**
- Story 6.2: Material Management (needs journey tracking)
- Story 6.3: Admin Analytics (needs funnel data)
- Story 6.4: Role Dashboards (needs attribution data)
- Story 6.5: Analytics & Reporting (needs drop-off analysis)

---

## Implementation Order (Day-by-Day)

**Day 1: Database & Core Service**
- Create Prisma migration for schema changes
- Build `journey-tracking.service.ts`
- Build UTM parsing utilities

**Day 2: Middleware & Cookie Management**
- Implement UTM extraction middleware
- Build encrypted cookie manager
- Test UTM persistence across requests

**Day 3: API Integrations**
- Hook into intake start endpoint
- Hook into intake complete endpoint
- Hook into return filed endpoint

**Day 4: Counter Updates & Analytics**
- Implement cached counter updates
- Build conversion rate calculation
- Add funnel query helpers

**Day 5: Testing & Documentation**
- Write unit tests
- Write integration tests
- Manual testing of full flow
- Update documentation

---

## Notes

- This story provides the foundation for ALL other stories in the epic
- Must be completed and stable before moving to Story 6.2
- Focus on accuracy over features (attribution must be correct)
- Performance is critical (high-traffic landing pages)

---

**Ready to implement?** This story transforms existing basic link tracking into comprehensive journey attribution that the full spec requires.
