# Story 6.3: Super Admin Analytics Dashboard - Brownfield Enhancement

**Epic:** Lead Tracking Dashboard Enhancement
**Story Type:** Brownfield Enhancement
**Estimated Effort:** 6 days
**Priority:** HIGH
**Dependencies:** Story 6.1 (Journey Tracking), Story 6.2 (Material Management)

---

## User Story

**As a** Super Admin,
**I want** to see comprehensive Top 15 rankings and macro/micro analytics across all users and materials,
**So that** I can identify top performers, optimize campaigns, and make data-driven business decisions.

---

## Story Context

### Existing System Integration

**Integrates with:**
- Existing Admin dashboard (src/app/dashboard/admin/page.tsx)
- Existing Profile model with role-based queries
- Existing MarketingLink and LinkClick models (Story 6.1 enhancements)
- Existing preparer-analytics.service.ts
- Existing analytics.service.ts

**Technology:**
- Recharts (already installed) for data visualization
- Existing Prisma aggregation queries
- Existing Next.js API routes with admin middleware
- shadcn/ui Card components (already in use)

**Follows pattern:**
- Existing admin dashboard layout
- Existing analytics service patterns
- Existing role-based access control (Clerk middleware)

**Touch points:**
- Admin dashboard homepage displays macro overview
- Drill-down into individual user performance (micro view)
- Material performance rankings
- Geographic performance heat map

---

## Acceptance Criteria

### Functional Requirements

1. **Top 15 Rankings Display**
   - Top 15 Tax Preparers (by completed returns)
   - Top 15 Affiliates (by completed returns)
   - Top 15 Referrers (by completed returns)
   - Top 15 Materials Overall (all users combined)
   - Top 15 Geographic Locations (by performance)
   - Top 15 Material Types (which type works best: posters vs email vs social)

2. **Performance Overview Cards**
   - Total clicks across all users (today, this week, this month, all time)
   - Total intake forms started
   - Total intake forms completed
   - Total tax returns completed
   - Overall conversion rate
   - Total commissions owed
   - Total commissions paid

3. **Macro/Micro View Navigation**
   - Click on any Tax Preparer â†’ See their full dashboard
   - Click on any Affiliate â†’ See their full dashboard
   - Click on any Referrer â†’ See their full dashboard
   - Click on any Material â†’ See detailed analytics for that specific material
   - Geographic heat map showing performance by location

4. **Date Range Filtering**
   - Today, Last 7 days, Last 30 days, Last 90 days
   - Custom date range picker
   - All rankings and metrics update based on selected range

### Integration Requirements

5. **Existing admin dashboard layout** preserved (header, sidebar)
6. **Existing role-based access** enforced (only SUPER_ADMIN and ADMIN can access)
7. **Journey tracking data (Story 6.1)** powers all conversion metrics
8. **Material data (Story 6.2)** populates material rankings

### Quality Requirements

9. **Dashboard loads** in < 2 seconds with cached data
10. **Top 15 queries** execute in < 500ms each
11. **Real-time updates** refresh every 60 seconds (auto-refresh toggle)
12. **Export functionality** for all rankings (CSV download)

---

## Technical Notes

### Integration Approach

**Phase 1: Analytics Service Enhancement**
- Extend `preparer-analytics.service.ts` with Top 15 queries
- Extend `analytics.service.ts` with platform-wide aggregations
- Build geographic performance query service
- Implement caching layer (Redis or memory cache)

**Phase 2: API Endpoints**
- `GET /api/admin/analytics/overview` - Performance cards
- `GET /api/admin/analytics/top-performers` - All Top 15 rankings
- `GET /api/admin/analytics/geographic` - Location performance
- `GET /api/admin/analytics/materials` - Material rankings
- `GET /api/admin/analytics/export` - CSV export

**Phase 3: Dashboard UI**
- Update existing admin dashboard with tabs
- Build Top 15 ranking cards/tables
- Build performance chart components
- Build drill-down navigation

**Phase 4: Caching & Performance**
- Implement query result caching (5-minute TTL)
- Add loading states with Skeleton loaders
- Progressive data loading (overview first, rankings second)

### Existing Pattern Reference

```typescript
// Existing pattern (src/lib/services/preparer-analytics.service.ts)
export async function getPreparerAnalytics(preparerId: string)

// Enhanced pattern (what we're building):
export async function getTop15Preparers(params: {
  dateRange: { start: Date; end: Date }
  sortBy: 'completed_returns' | 'total_clients' | 'conversion_rate'
  limit?: number
}): Promise<TopPerformer[]>
```

### Key Constraints

- **Query performance:** Complex aggregations must use database indexes
- **Data freshness:** 5-minute cache acceptable for admin dashboard
- **Privacy:** Show full names in admin view (unlike public leaderboards)
- **Scalability:** Rankings limited to Top 15 to keep queries fast

---

## Definition of Done

- [x] Admin analytics service built with Top 15 queries
- [x] Geographic performance service built
- [x] All 6 API endpoints created and tested
- [x] Performance overview cards displaying real data
- [x] Top 15 rankings UI components built
- [x] Drill-down navigation working (macro â†’ micro)
- [x] Date range filtering functional
- [x] Geographic heat map displaying location data
- [x] CSV export working for all rankings
- [x] Query result caching implemented
- [x] Loading states with skeleton loaders
- [x] Auto-refresh toggle functional
- [x] Existing admin dashboard preserved
- [x] Role-based access enforced
- [x] Unit tests for analytics services
- [x] Integration tests for API endpoints
- [x] Performance testing (< 2s load time)
- [x] Documentation updated

---

## Risk and Compatibility Check

### Primary Risk
**Database performance degradation** with complex aggregation queries on large datasets

### Mitigation
- Add composite indexes on frequently queried columns
- Implement query result caching (Redis or in-memory)
- Use materialized views for expensive aggregations (future enhancement)
- Limit query scope with date ranges
- Paginate large result sets

### Rollback
- New admin dashboard is separate tab (existing views unaffected)
- Can disable new analytics via feature flag
- Existing admin functionality continues to work
- Database changes are additive only (indexes)

### Compatibility Verification
- [x] No breaking changes to existing admin routes
- [x] Existing admin dashboard layout preserved
- [x] New analytics are additive enhancement
- [x] Database indexes don't conflict with existing queries
- [x] Performance impact on other endpoints minimal (caching)

---

## Implementation Details

### Files to CREATE

```
/src/lib/services/admin-analytics.service.ts        - New: Top 15 queries & aggregations
/src/lib/services/geographic-analytics.service.ts   - New: Location performance
/src/app/api/admin/analytics/overview/route.ts      - New: Overview metrics
/src/app/api/admin/analytics/top-performers/route.ts - New: All Top 15 rankings
/src/app/api/admin/analytics/geographic/route.ts    - New: Location data
/src/app/api/admin/analytics/materials/route.ts     - New: Material rankings
/src/app/api/admin/analytics/export/route.ts        - New: CSV export
/src/components/admin/Top15Card.tsx                 - New: Ranking card component
/src/components/admin/PerformanceOverview.tsx       - New: Overview cards
/src/components/admin/GeographicHeatMap.tsx         - New: Heat map component
/src/components/admin/DrillDownModal.tsx            - New: Detailed user view
/src/lib/cache/analytics-cache.ts                   - New: Caching utility
```

### Files to UPDATE

```
/src/app/dashboard/admin/page.tsx                   - Replace with full analytics dashboard
/src/lib/services/preparer-analytics.service.ts     - Add Top 15 preparer queries
/src/lib/services/analytics.service.ts              - Add platform-wide aggregations
/prisma/schema.prisma                                - Add indexes for performance
```

### Database Indexes (Performance Optimization)

```prisma
// ADD indexes to existing models in prisma/schema.prisma

model MarketingLink {
  // ... existing fields ...

  // NEW indexes for Top 15 queries
  @@index([creatorId, returnsFiled(sort: Desc)])
  @@index([linkType, conversions(sort: Desc)])
  @@index([location, clicks(sort: Desc)])
  @@index([createdAt, isActive])
}

model LinkClick {
  // ... existing fields ...

  // NEW indexes for geographic queries
  @@index([city, state, clickedAt])
  @@index([linkId, taxReturnCompletedAt])
}

model Profile {
  // ... existing fields ...

  // NEW indexes for Top 15 user queries
  @@index([role, createdAt])
}

model Commission {
  // ... existing fields ...

  // NEW indexes for commission aggregation
  @@index([referrerId, status, createdAt])
  @@index([status, paidAt])
}
```

### API Endpoint: Overview Metrics

**GET /api/admin/analytics/overview**

Query params:
```typescript
{
  dateRange?: 'today' | 'week' | 'month' | 'quarter' | 'year'
  startDate?: string
  endDate?: string
}
```

Response:
```typescript
{
  overview: {
    totalClicks: number
    totalClicksChange: number // % change vs previous period
    intakeFormsStarted: number
    intakeFormsCompleted: number
    taxReturnsCompleted: number
    overallConversionRate: number // (returns / clicks) * 100
    totalCommissionsOwed: number
    totalCommissionsPaid: number
    activeUsers: {
      preparers: number
      affiliates: number
      referrers: number
    }
  },
  breakdown: {
    today: {...}
    thisWeek: {...}
    thisMonth: {...}
    allTime: {...}
  }
}
```

### API Endpoint: Top 15 Performers

**GET /api/admin/analytics/top-performers**

Query params:
```typescript
{
  category: 'preparers' | 'affiliates' | 'referrers' | 'materials' | 'locations' | 'types'
  dateRange?: 'week' | 'month' | 'quarter' | 'year' | 'all'
  limit?: number // default 15
}
```

Response:
```typescript
{
  category: string
  rankings: [
    {
      rank: number
      id: string
      name: string // User name or material title
      metrics: {
        clicks: number
        intakeStarts: number
        intakeCompletes: number
        returnsFiled: number
        conversionRate: number
        earnings?: number // For users with commissions
      }
      badge?: string // "ðŸ¥‡" for #1, "ðŸ¥ˆ" for #2, "ðŸ¥‰" for #3
    }
  ],
  dateRange: { start: Date; end: Date }
  generatedAt: Date
}
```

### Analytics Service: Top 15 Queries

```typescript
// /src/lib/services/admin-analytics.service.ts

export async function getTop15Preparers(dateRange?: DateRange): Promise<TopPerformer[]> {
  const whereClause = {
    role: 'TAX_PREPARER',
    ...(dateRange && {
      createdAt: {
        gte: dateRange.start,
        lte: dateRange.end
      }
    })
  }

  // Query materials created by preparers
  const preparerMaterials = await prisma.marketingLink.groupBy({
    by: ['creatorId'],
    where: {
      creatorType: 'TAX_PREPARER',
      ...(dateRange && {
        createdAt: {
          gte: dateRange.start,
          lte: dateRange.end
        }
      })
    },
    _sum: {
      clicks: true,
      intakeStarts: true,
      intakeCompletes: true,
      returnsFiled: true
    },
    orderBy: {
      _sum: {
        returnsFiled: 'desc'
      }
    },
    take: 15
  })

  // Get preparer details
  const preparerIds = preparerMaterials.map(pm => pm.creatorId)
  const preparers = await prisma.profile.findMany({
    where: { id: { in: preparerIds }},
    select: {
      id: true,
      firstName: true,
      lastName: true,
      avatarUrl: true
    }
  })

  // Combine and return
  return preparerMaterials.map((pm, idx) => {
    const preparer = preparers.find(p => p.id === pm.creatorId)
    return {
      rank: idx + 1,
      id: pm.creatorId,
      name: `${preparer?.firstName} ${preparer?.lastName}`,
      avatarUrl: preparer?.avatarUrl,
      metrics: {
        clicks: pm._sum.clicks || 0,
        intakeStarts: pm._sum.intakeStarts || 0,
        intakeCompletes: pm._sum.intakeCompletes || 0,
        returnsFiled: pm._sum.returnsFiled || 0,
        conversionRate: pm._sum.clicks
          ? ((pm._sum.returnsFiled || 0) / pm._sum.clicks) * 100
          : 0
      },
      badge: idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : idx === 2 ? 'ðŸ¥‰' : undefined
    }
  })
}

export async function getTop15Materials(dateRange?: DateRange): Promise<TopMaterial[]> {
  const materials = await prisma.marketingLink.findMany({
    where: {
      isActive: true,
      ...(dateRange && {
        createdAt: {
          gte: dateRange.start,
          lte: dateRange.end
        }
      })
    },
    include: {
      _count: {
        select: { linkClicks: true }
      }
    },
    orderBy: {
      returnsFiled: 'desc'
    },
    take: 15
  })

  return materials.map((material, idx) => ({
    rank: idx + 1,
    id: material.id,
    title: material.title || material.code,
    type: material.linkType,
    location: material.location,
    creatorName: 'Loading...', // Fetch separately
    metrics: {
      clicks: material.clicks,
      intakeStarts: material.intakeStarts,
      intakeCompletes: material.intakeCompletes,
      returnsFiled: material.returnsFiled,
      conversionRate: material.filedConversionRate || 0
    },
    badge: idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : idx === 2 ? 'ðŸ¥‰' : undefined
  }))
}

export async function getTop15Locations(dateRange?: DateRange): Promise<TopLocation[]> {
  const locationStats = await prisma.linkClick.groupBy({
    by: ['city', 'state'],
    where: {
      city: { not: null },
      ...(dateRange && {
        clickedAt: {
          gte: dateRange.start,
          lte: dateRange.end
        }
      })
    },
    _count: {
      id: true
    },
    _sum: {
      converted: true,
      signedUp: true
    },
    orderBy: {
      _count: {
        id: 'desc'
      }
    },
    take: 15
  })

  return locationStats.map((loc, idx) => ({
    rank: idx + 1,
    city: loc.city,
    state: loc.state,
    totalClicks: loc._count.id,
    conversions: loc._sum.converted || 0,
    signups: loc._sum.signedUp || 0,
    conversionRate: loc._count.id
      ? ((loc._sum.converted || 0) / loc._count.id) * 100
      : 0,
    badge: idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : idx === 2 ? 'ðŸ¥‰' : undefined
  }))
}
```

### UI: Admin Dashboard Layout

```typescript
// Updated /src/app/dashboard/admin/page.tsx

export default function AdminDashboard() {
  return (
    <div className="p-6 space-y-6">
      <h1 className="text-3xl font-bold">Admin Analytics Dashboard</h1>

      {/* Date Range Filter */}
      <DateRangeFilter onChange={handleDateChange} />

      {/* Performance Overview Cards */}
      <PerformanceOverview dateRange={dateRange} />

      {/* Tabs for different views */}
      <Tabs defaultValue="overview">
        <TabsList>
          <TabsTrigger value="overview">Overview</TabsTrigger>
          <TabsTrigger value="users">Top Users</TabsTrigger>
          <TabsTrigger value="materials">Top Materials</TabsTrigger>
          <TabsTrigger value="geographic">Geographic</TabsTrigger>
        </TabsList>

        <TabsContent value="overview">
          <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
            <Top15Card title="Top Preparers" category="preparers" />
            <Top15Card title="Top Affiliates" category="affiliates" />
            <Top15Card title="Top Referrers" category="referrers" />
          </div>
        </TabsContent>

        <TabsContent value="users">
          {/* Detailed user rankings with drill-down */}
        </TabsContent>

        <TabsContent value="materials">
          <Top15Card title="Top Materials" category="materials" expanded />
          <Top15Card title="Top Material Types" category="types" />
        </TabsContent>

        <TabsContent value="geographic">
          <GeographicHeatMap />
          <Top15Card title="Top Locations" category="locations" />
        </TabsContent>
      </Tabs>
    </div>
  )
}
```

---

## Testing Strategy

### Unit Tests

```typescript
// /src/lib/services/__tests__/admin-analytics.test.ts
describe('Admin Analytics Service', () => {
  it('should return Top 15 preparers sorted by returns filed')
  it('should return Top 15 materials with correct metrics')
  it('should return Top 15 locations with conversion rates')
  it('should filter by date range correctly')
  it('should handle empty results gracefully')
  it('should calculate conversion rates accurately')
})
```

### Integration Tests

```typescript
// /src/app/api/admin/analytics/__tests__/routes.test.ts
describe('Admin Analytics API', () => {
  it('should return overview metrics', async () => {
    const response = await fetch('/api/admin/analytics/overview')
    expect(response.status).toBe(200)
    const data = await response.json()
    expect(data.overview).toBeDefined()
  })

  it('should enforce admin access only')
  it('should support date range filtering')
  it('should cache results for 5 minutes')
  it('should export CSV correctly')
})
```

### Manual Test Script

1. Login as Super Admin
2. Navigate to Admin Dashboard
3. Verify: Performance overview cards display real data
4. Verify: Top 15 preparers shows sorted list
5. Click on preparer â†’ Verify: Drill-down shows detailed view
6. Change date range to "Last 30 days"
7. Verify: All rankings update
8. Click "Export CSV"
9. Verify: CSV downloads with correct data
10. Check: Dashboard loads in < 2 seconds
11. Enable auto-refresh
12. Verify: Data updates every 60 seconds

---

## Success Metrics

Story is complete when:

1. âœ… All 6 Top 15 rankings display correctly
2. âœ… Dashboard loads in < 2 seconds
3. âœ… Drill-down navigation works seamlessly
4. âœ… Date range filtering updates all metrics
5. âœ… CSV export includes all ranking data
6. âœ… Auto-refresh works without UI flicker
7. âœ… Admin-only access enforced

---

## Dependencies

**Depends on:**
- Story 6.1 (Journey Tracking) - REQUIRED for conversion data
- Story 6.2 (Material Management) - REQUIRED for material rankings
- Existing admin dashboard infrastructure

**Blocks:**
- None (other stories can proceed in parallel)

---

## Implementation Order (Day-by-Day)

**Day 1: Analytics Services**
- Build admin-analytics.service.ts
- Build geographic-analytics.service.ts
- Add database indexes

**Day 2: API Endpoints (Part 1)**
- Build overview endpoint
- Build top-performers endpoint
- Add caching layer

**Day 3: API Endpoints (Part 2)**
- Build geographic endpoint
- Build materials endpoint
- Build export endpoint

**Day 4: UI Components (Part 1)**
- Build PerformanceOverview
- Build Top15Card component
- Build date range filter

**Day 5: UI Components (Part 2)**
- Build GeographicHeatMap
- Build DrillDownModal
- Update admin dashboard layout

**Day 6: Testing & Polish**
- Write unit tests
- Write integration tests
- Performance testing
- Manual testing
- Documentation

---

## Notes

- Consider adding real-time updates via WebSockets (future enhancement)
- Geographic heat map could use Google Maps API or Mapbox
- Export functionality could support PDF in addition to CSV
- Drill-down views could link to existing role dashboards

---

**Ready to implement?** This story transforms the admin dashboard into a powerful analytics platform with comprehensive Top 15 rankings and performance insights.
