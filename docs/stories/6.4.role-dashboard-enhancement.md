# Story 6.4: Role Dashboard Enhancement - Brownfield Enhancement

**Epic:** Lead Tracking Dashboard Enhancement
**Story Type:** Brownfield Enhancement
**Estimated Effort:** 6 days
**Priority:** HIGH
**Dependencies:** Story 6.1 (Journey Tracking), Story 6.2 (Material Management)

---

## User Story

**As a** Referrer, Affiliate, or Tax Preparer,
**I want** to see my Top 15 performing materials, conversion funnel, and source breakdown,
**So that** I can optimize my marketing efforts and focus on what works best.

---

## Story Context

### Existing System Integration

**Integrates with:**
- Existing Referrer dashboard (src/app/dashboard/referrer/page.tsx)
- Existing Affiliate dashboard (src/app/dashboard/affiliate/page.tsx)
- Existing Tax Preparer dashboard (src/app/dashboard/tax-preparer/page.tsx)
- Existing `useReferrerData` hooks (src/hooks/useReferrerData.ts)
- Journey tracking data (Story 6.1)
- Material data (Story 6.2)

**Technology:**
- React Query (already in use) for data fetching
- Recharts for visualization
- Existing StatCard components
- shadcn/ui Table components

**Follows pattern:**
- Existing dashboard layout with tabs
- Existing stat card display pattern
- Existing analytics API patterns

**Touch points:**
- Dashboard overview displays Top 15 my materials
- Performance trends show conversion funnel
- Source breakdown shows lead attribution
- Material management links to Story 6.2 creation flow

---

## Acceptance Criteria

### Functional Requirements - Referrer Dashboard

1. **Top 15 My Materials Table**
   - Material Name/Campaign
   - Material Type (poster, email, social, etc.)
   - Location Placed
   - Total Clicks
   - Intake Started
   - Intake Completed
   - Tax Returns Done
   - Conversion Rate %
   - Last Click Date
   - Status (Active/Paused)

2. **Source Breakdown**
   - Leads from my own materials
   - Total earnings breakdown by material type
   - Best performing channels (QR codes vs email vs social)

3. **Performance Trends**
   - Line graph showing clicks and conversions over time
   - Selectable time period (7d, 30d, 90d, all time)

4. **Conversion Funnel Visualization**
   - Click â†’ Intake Started â†’ Intake Completed â†’ Tax Return Filed
   - Show drop-off rates at each stage
   - Calculate overall conversion rate

### Functional Requirements - Affiliate Dashboard

5. **Top 15 My Campaigns Table**
   - Campaign Name
   - Material Type
   - Location/Channel
   - Total Clicks
   - Intake Completed
   - Tax Returns Done
   - Conversion Rate %
   - Commission Earned ($)
   - Commission Status (Pending/Paid)

6. **Financial Summary**
   - Earnings by month (bar chart)
   - Payment history table
   - Pending payments breakdown
   - ROI per material

### Functional Requirements - Tax Preparer Dashboard

7. **Client Source Tracking**
   - Clients from my own materials
   - Clients from my assigned referrers
   - Clients from direct website
   - Client acquisition cost per channel

8. **Material Performance**
   - My Top 10 materials (subset for preparers)
   - Best performing referrer partnerships
   - Conversion rates by source

### Integration Requirements

9. **Existing dashboard layouts** preserved (tabs, navigation)
10. **Existing StatCard components** enhanced with real data
11. **Journey tracking (Story 6.1)** provides conversion funnel data
12. **Material data (Story 6.2)** populates material tables

### Quality Requirements

13. **Dashboards load** in < 2 seconds
14. **Top 15 tables** sortable by any column
15. **Real-time updates** via React Query (30-second stale time)
16. **Responsive design** works on mobile, tablet, desktop

---

## Technical Notes

### Integration Approach

**Phase 1: API Enhancements**
- Enhance `/api/referrers/stats` with Top 15 materials query
- Enhance `/api/referrers/activity` with funnel data
- Create `/api/materials/my-performance` endpoint
- Create `/api/analytics/funnel/:userId` endpoint

**Phase 2: React Query Hooks**
- Update `useReferrerStats` hook with new data structure
- Create `useMyMaterials` hook
- Create `useConversionFunnel` hook
- Create `useSourceBreakdown` hook

**Phase 3: Dashboard UI Updates**
- Update Referrer dashboard with Top 15 table
- Update Affiliate dashboard with campaigns table
- Update Tax Preparer dashboard with source tracking
- Build reusable FunnelChart component

**Phase 4: Performance Optimization**
- Implement pagination for material tables (50 per page)
- Add table sorting and filtering
- Lazy-load charts (only render when tab active)

### Existing Pattern Reference

```typescript
// Current hook pattern (src/hooks/useReferrerData.ts)
export function useReferrerStats() {
  return useQuery({
    queryKey: ['referrer-stats'],
    queryFn: async () => {
      const response = await fetch('/api/referrers/stats')
      return response.json()
    }
  })
}

// Enhanced pattern (what we're building):
export function useMyTopMaterials(limit: number = 15) {
  return useQuery({
    queryKey: ['my-materials', limit],
    queryFn: async () => {
      const response = await fetch(`/api/materials/my-performance?limit=${limit}`)
      return response.json()
    },
    staleTime: 30000 // 30 seconds
  })
}
```

### Key Constraints

- **Table performance:** Limit to 50 rows per page, use virtual scrolling for large datasets
- **Data freshness:** 30-second stale time acceptable (not real-time)
- **Privacy:** Users only see their own data (no cross-user access)
- **Mobile UX:** Tables must be responsive, consider card view on mobile

---

## Definition of Done

- [x] Referrer dashboard displays Top 15 materials table
- [x] Affiliate dashboard displays campaign performance
- [x] Tax Preparer dashboard displays client sources
- [x] Conversion funnel component built and working
- [x] Source breakdown charts built
- [x] Performance trends line graphs working
- [x] All tables sortable and filterable
- [x] Pagination implemented (50 per page)
- [x] Date range filtering functional
- [x] React Query hooks optimized
- [x] Mobile responsive design verified
- [x] Existing dashboard functionality preserved
- [x] Loading states with skeleton loaders
- [x] Error states with retry logic
- [x] Unit tests for hooks
- [x] Integration tests for API endpoints
- [x] Manual testing on all role dashboards
- [x] Documentation updated

---

## Risk and Compatibility Check

### Primary Risk
**Performance degradation** with large material datasets (100+ materials per user)

### Mitigation
- Implement pagination (50 items per page)
- Add sorting/filtering on backend (not client-side)
- Cache query results with React Query
- Use virtual scrolling for very large tables
- Consider materialized views for complex queries

### Rollback
- Dashboard updates are UI-only (no schema changes)
- Can revert to placeholder dashboards via feature flag
- Existing dashboard tabs remain functional
- No data loss if rollback needed

### Compatibility Verification
- [x] No breaking changes to existing dashboard routes
- [x] Existing StatCard components remain functional
- [x] New features are additive enhancements
- [x] Mobile layouts preserved
- [x] Existing navigation and tabs work unchanged

---

## Implementation Details

### Files to CREATE

```
/src/hooks/useMyMaterials.ts                   - New: Top materials hook
/src/hooks/useConversionFunnel.ts              - New: Funnel data hook
/src/hooks/useSourceBreakdown.ts               - New: Source attribution hook
/src/components/analytics/ConversionFunnel.tsx - New: Funnel visualization
/src/components/analytics/SourceBreakdown.tsx  - New: Source pie/bar chart
/src/components/analytics/MaterialsTable.tsx   - New: Top 15 materials table
/src/components/analytics/PerformanceTrends.tsx - New: Trend line chart
/src/app/api/materials/my-performance/route.ts - New: User material performance
/src/app/api/analytics/funnel/[userId]/route.ts - New: Conversion funnel data
/src/app/api/analytics/source-breakdown/route.ts - New: Lead source attribution
```

### Files to UPDATE

```
/src/app/dashboard/referrer/page.tsx           - Add Top 15 table + funnel
/src/app/dashboard/affiliate/page.tsx          - Add campaign performance
/src/app/dashboard/tax-preparer/page.tsx       - Add client source tracking
/src/hooks/useReferrerData.ts                  - Enhance with new endpoints
/src/app/api/referrers/stats/route.ts          - Add Top 15 materials query
/src/app/api/referrers/activity/route.ts       - Add funnel stage details
/src/components/StatCard.tsx                    - Add onClick drill-down
```

### API Endpoint: My Material Performance

**GET /api/materials/my-performance**

Query params:
```typescript
{
  limit?: number // default 15
  sortBy?: 'clicks' | 'conversions' | 'conversion_rate'
  sortOrder?: 'asc' | 'desc'
  dateRange?: 'week' | 'month' | 'quarter' | 'year' | 'all'
  page?: number // pagination
  pageSize?: number // default 50
}
```

Response:
```typescript
{
  materials: [
    {
      id: string
      title: string
      type: LinkType
      location: string
      campaignName: string
      metrics: {
        clicks: number
        intakeStarts: number
        intakeCompletes: number
        returnsFiled: number
        conversionRate: number // (returnsFiled / clicks) * 100
      },
      lastActivity: Date
      status: 'ACTIVE' | 'PAUSED'
      earnings?: number // For affiliates/referrers
    }
  ],
  pagination: {
    total: number
    page: number
    pageSize: number
    totalPages: number
  }
}
```

### API Endpoint: Conversion Funnel

**GET /api/analytics/funnel/[userId]**

Query params:
```typescript
{
  dateRange?: 'week' | 'month' | 'quarter' | 'year' | 'all'
  materialId?: string // Filter by specific material
}
```

Response:
```typescript
{
  funnel: {
    stage1_clicks: number
    stage2_intakeStarts: number
    stage3_intakeCompletes: number
    stage4_returnsFiled: number
    dropoff: {
      clickToStart: number // % who clicked but didn't start
      startToComplete: number // % who started but didn't complete
      completeToFiled: number // % who completed but return not filed
    },
    conversionRates: {
      clickToStart: number // %
      startToComplete: number // %
      completeToFiled: number // %
      overallConversion: number // (returnsFiled / clicks) * 100
    }
  },
  dateRange: { start: Date; end: Date }
}
```

### React Query Hook: useMyTopMaterials

```typescript
// /src/hooks/useMyMaterials.ts

import { useQuery } from '@tanstack/react-query'
import { useAuth } from '@clerk/nextjs'

export interface MaterialPerformance {
  id: string
  title: string
  type: string
  location: string
  clicks: number
  intakeStarts: number
  intakeCompletes: number
  returnsFiled: number
  conversionRate: number
  lastActivity: Date
  status: 'ACTIVE' | 'PAUSED'
  earnings?: number
}

export function useMyTopMaterials(options?: {
  limit?: number
  sortBy?: string
  dateRange?: string
}) {
  const { userId } = useAuth()

  return useQuery({
    queryKey: ['my-materials', userId, options],
    queryFn: async (): Promise<MaterialPerformance[]> => {
      const params = new URLSearchParams({
        limit: options?.limit?.toString() || '15',
        sortBy: options?.sortBy || 'returnsFiled',
        sortOrder: 'desc',
        dateRange: options?.dateRange || 'all'
      })

      const response = await fetch(`/api/materials/my-performance?${params}`)
      if (!response.ok) throw new Error('Failed to fetch materials')

      const data = await response.json()
      return data.materials
    },
    staleTime: 30000, // 30 seconds
    enabled: !!userId
  })
}

export function useConversionFunnel(materialId?: string) {
  const { userId } = useAuth()

  return useQuery({
    queryKey: ['conversion-funnel', userId, materialId],
    queryFn: async () => {
      const params = new URLSearchParams()
      if (materialId) params.set('materialId', materialId)

      const response = await fetch(`/api/analytics/funnel/${userId}?${params}`)
      if (!response.ok) throw new Error('Failed to fetch funnel')

      return response.json()
    },
    staleTime: 60000, // 1 minute
    enabled: !!userId
  })
}
```

### Component: MaterialsTable

```typescript
// /src/components/analytics/MaterialsTable.tsx

import { useState } from 'react'
import { useMyTopMaterials } from '@/hooks/useMyMaterials'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { ArrowUpDown, Download, Eye } from 'lucide-react'

export function MaterialsTable() {
  const [sortBy, setSortBy] = useState('returnsFiled')
  const { data: materials, isLoading } = useMyTopMaterials({ sortBy })

  if (isLoading) return <TableSkeleton />

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h3 className="text-lg font-semibold">My Top 15 Materials</h3>
        <Button variant="outline" size="sm">
          <Download className="w-4 h-4 mr-2" />
          Export CSV
        </Button>
      </div>

      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Material Name</TableHead>
            <TableHead>Type</TableHead>
            <TableHead>Location</TableHead>
            <TableHead className="text-right">
              <Button variant="ghost" size="sm" onClick={() => setSortBy('clicks')}>
                Clicks <ArrowUpDown className="w-3 h-3 ml-1" />
              </Button>
            </TableHead>
            <TableHead className="text-right">Intake Started</TableHead>
            <TableHead className="text-right">Intake Completed</TableHead>
            <TableHead className="text-right">
              <Button variant="ghost" size="sm" onClick={() => setSortBy('returnsFiled')}>
                Returns Filed <ArrowUpDown className="w-3 h-3 ml-1" />
              </Button>
            </TableHead>
            <TableHead className="text-right">
              <Button variant="ghost" size="sm" onClick={() => setSortBy('conversionRate')}>
                Conv. Rate <ArrowUpDown className="w-3 h-3 ml-1" />
              </Button>
            </TableHead>
            <TableHead>Status</TableHead>
            <TableHead>Actions</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {materials?.map((material, idx) => (
            <TableRow key={material.id}>
              <TableCell className="font-medium">
                {idx < 3 && (
                  <span className="mr-2">
                    {idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                  </span>
                )}
                {material.title}
              </TableCell>
              <TableCell>
                <Badge variant="outline">{formatMaterialType(material.type)}</Badge>
              </TableCell>
              <TableCell className="text-sm text-muted-foreground">
                {material.location || 'Not specified'}
              </TableCell>
              <TableCell className="text-right font-mono">
                {material.clicks.toLocaleString()}
              </TableCell>
              <TableCell className="text-right font-mono">
                {material.intakeStarts.toLocaleString()}
              </TableCell>
              <TableCell className="text-right font-mono">
                {material.intakeCompletes.toLocaleString()}
              </TableCell>
              <TableCell className="text-right font-mono font-semibold">
                {material.returnsFiled.toLocaleString()}
              </TableCell>
              <TableCell className="text-right">
                <Badge variant={material.conversionRate > 10 ? 'default' : 'secondary'}>
                  {material.conversionRate.toFixed(1)}%
                </Badge>
              </TableCell>
              <TableCell>
                <Badge variant={material.status === 'ACTIVE' ? 'default' : 'secondary'}>
                  {material.status}
                </Badge>
              </TableCell>
              <TableCell>
                <Button variant="ghost" size="sm">
                  <Eye className="w-4 h-4" />
                </Button>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  )
}

function formatMaterialType(type: string): string {
  return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
}
```

### Component: Conversion Funnel

```typescript
// /src/components/analytics/ConversionFunnel.tsx

import { useConversionFunnel } from '@/hooks/useMyMaterials'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { ArrowRight, TrendingDown } from 'lucide-react'

export function ConversionFunnel({ materialId }: { materialId?: string }) {
  const { data, isLoading } = useConversionFunnel(materialId)

  if (isLoading) return <FunnelSkeleton />

  const funnel = data?.funnel

  return (
    <Card>
      <CardHeader>
        <CardTitle>Conversion Funnel</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {/* Stage 1: Clicks */}
          <FunnelStage
            label="Clicked Link"
            count={funnel?.stage1_clicks || 0}
            percentage={100}
            isFirst
          />

          <FunnelDropoff
            rate={funnel?.dropoff.clickToStart || 0}
            label="Drop-off"
          />

          {/* Stage 2: Intake Started */}
          <FunnelStage
            label="Started Intake Form"
            count={funnel?.stage2_intakeStarts || 0}
            percentage={funnel?.conversionRates.clickToStart || 0}
          />

          <FunnelDropoff
            rate={funnel?.dropoff.startToComplete || 0}
            label="Drop-off"
          />

          {/* Stage 3: Intake Completed */}
          <FunnelStage
            label="Completed Intake Form"
            count={funnel?.stage3_intakeCompletes || 0}
            percentage={funnel?.conversionRates.startToComplete || 0}
          />

          <FunnelDropoff
            rate={funnel?.dropoff.completeToFiled || 0}
            label="Drop-off"
          />

          {/* Stage 4: Return Filed */}
          <FunnelStage
            label="Tax Return Filed"
            count={funnel?.stage4_returnsFiled || 0}
            percentage={funnel?.conversionRates.completeToFiled || 0}
            isLast
          />

          {/* Overall Conversion */}
          <div className="pt-4 border-t">
            <div className="flex justify-between items-center">
              <span className="text-sm font-medium">Overall Conversion Rate:</span>
              <span className="text-2xl font-bold text-primary">
                {funnel?.conversionRates.overallConversion.toFixed(1)}%
              </span>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  )
}

function FunnelStage({ label, count, percentage, isFirst, isLast }: {
  label: string
  count: number
  percentage: number
  isFirst?: boolean
  isLast?: boolean
}) {
  const widthPercentage = isFirst ? 100 : percentage

  return (
    <div className="space-y-2">
      <div className="flex justify-between items-center">
        <span className="text-sm font-medium">{label}</span>
        <span className="text-sm text-muted-foreground">
          {count.toLocaleString()} ({percentage.toFixed(1)}%)
        </span>
      </div>
      <div className="h-12 bg-primary/20 rounded-lg flex items-center justify-center relative overflow-hidden">
        <div
          className="absolute left-0 top-0 h-full bg-primary transition-all duration-500"
          style={{ width: `${widthPercentage}%` }}
        />
        <span className="relative z-10 font-semibold text-primary-foreground">
          {count.toLocaleString()}
        </span>
      </div>
    </div>
  )
}

function FunnelDropoff({ rate, label }: { rate: number; label: string }) {
  return (
    <div className="flex items-center justify-center text-xs text-muted-foreground">
      <TrendingDown className="w-3 h-3 mr-1" />
      <span>{rate.toFixed(1)}% {label}</span>
    </div>
  )
}
```

### Updated Dashboard: Referrer

```typescript
// UPDATE /src/app/dashboard/referrer/page.tsx

export default function ReferrerDashboard() {
  // ... existing code ...

  return (
    <div className="container mx-auto p-6 space-y-6">
      {/* Existing header and stats */}

      <Tabs value={selectedTab} onValueChange={setSelectedTab}>
        <TabsList>
          <TabsTrigger value="overview">Overview</TabsTrigger>
          <TabsTrigger value="materials">My Materials</TabsTrigger> {/* NEW */}
          <TabsTrigger value="analytics">Analytics</TabsTrigger>    {/* ENHANCED */}
          {/* ... existing tabs ... */}
        </TabsList>

        <TabsContent value="overview">
          {/* Existing overview content */}

          {/* NEW: Top 5 Materials Preview */}
          <Card>
            <CardHeader>
              <CardTitle>Top 5 Performing Materials</CardTitle>
              <CardDescription>Your best performing materials this month</CardDescription>
            </CardHeader>
            <CardContent>
              <MaterialsTable limit={5} />
              <Button
                variant="link"
                onClick={() => setSelectedTab('materials')}
                className="mt-2"
              >
                View All Materials â†’
              </Button>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="materials">
          {/* NEW: Full Top 15 Materials Table */}
          <MaterialsTable />
        </TabsContent>

        <TabsContent value="analytics">
          <div className="grid gap-4 md:grid-cols-2">
            {/* NEW: Conversion Funnel */}
            <ConversionFunnel />

            {/* NEW: Source Breakdown */}
            <SourceBreakdown />
          </div>

          {/* NEW: Performance Trends */}
          <PerformanceTrends />
        </TabsContent>

        {/* ... existing tabs ... */}
      </Tabs>
    </div>
  )
}
```

---

## Testing Strategy

### Unit Tests

```typescript
// /src/hooks/__tests__/useMyMaterials.test.ts
describe('useMyTopMaterials', () => {
  it('should fetch user materials')
  it('should handle sorting correctly')
  it('should respect limit parameter')
  it('should cache results for 30 seconds')
})

// /src/components/analytics/__tests__/MaterialsTable.test.tsx
describe('MaterialsTable', () => {
  it('should render materials in sorted order')
  it('should show loading state')
  it('should handle empty state')
  it('should allow sorting by any column')
})
```

### Integration Tests

```typescript
// /src/app/api/materials/__tests__/my-performance.test.ts
describe('GET /api/materials/my-performance', () => {
  it('should return user materials only')
  it('should enforce authentication')
  it('should support pagination')
  it('should sort correctly')
  it('should filter by date range')
})
```

### Manual Test Script

**Referrer Dashboard:**
1. Login as Referrer
2. Navigate to Dashboard
3. Verify: Top 5 materials preview shows on overview tab
4. Click "My Materials" tab
5. Verify: Full Top 15 table displays
6. Click column headers to sort
7. Verify: Sorting works correctly
8. Click "Analytics" tab
9. Verify: Conversion funnel displays
10. Verify: Source breakdown chart displays

**Affiliate Dashboard:**
1. Login as Affiliate
2. Navigate to Dashboard
3. Verify: Campaign performance table shows
4. Verify: Earnings data displays correctly
5. Verify: Commission status shows (Pending/Paid)

**Tax Preparer Dashboard:**
1. Login as Tax Preparer
2. Navigate to Dashboard
3. Verify: Client source breakdown shows
4. Verify: Referrer partnership performance displays

---

## Success Metrics

Story is complete when:

1. âœ… All 3 role dashboards display Top 15 materials/campaigns
2. âœ… Conversion funnel visualizes 4-stage journey
3. âœ… Source breakdown shows lead attribution
4. âœ… Tables are sortable and filterable
5. âœ… Dashboards load in < 2 seconds
6. âœ… Mobile responsive design verified
7. âœ… Existing functionality preserved

---

## Dependencies

**Depends on:**
- Story 6.1 (Journey Tracking) - REQUIRED
- Story 6.2 (Material Management) - REQUIRED
- Existing dashboard infrastructure

**Blocks:**
- Story 6.5 (Analytics & Reporting) - Optional dependency

---

## Implementation Order (Day-by-Day)

**Day 1: API Endpoints**
- Build my-performance endpoint
- Build funnel endpoint
- Build source-breakdown endpoint

**Day 2: React Query Hooks**
- Build useMyTopMaterials hook
- Build useConversionFunnel hook
- Build useSourceBreakdown hook

**Day 3: Reusable Components**
- Build MaterialsTable component
- Build ConversionFunnel component
- Build SourceBreakdown component

**Day 4: Dashboard Updates (Referrer + Affiliate)**
- Update Referrer dashboard
- Update Affiliate dashboard

**Day 5: Dashboard Updates (Tax Preparer)**
- Update Tax Preparer dashboard
- Mobile responsive fixes

**Day 6: Testing & Polish**
- Unit tests
- Integration tests
- Manual testing
- Documentation

---

## Notes

- Focus on performance (pagination, lazy loading)
- Ensure mobile-first design
- Consider adding export functionality for all tables
- Future enhancement: Material comparison tool

---

**Ready to implement?** This story brings real analytics to all user dashboards, replacing placeholder data with actionable insights from the journey tracking system.
