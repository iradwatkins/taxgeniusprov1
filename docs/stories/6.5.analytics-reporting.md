# Story 6.5: Analytics & Reporting - Brownfield Enhancement

**Epic:** Lead Tracking Dashboard Enhancement
**Story Type:** Brownfield Enhancement
**Estimated Effort:** 3 days
**Priority:** MEDIUM
**Dependencies:** Story 6.1, 6.2, 6.3, 6.4 (all previous stories)

---

## User Story

**As a** Platform User (any role),
**I want** advanced analytics features including drop-off analysis, material comparison, performance trends, and data export,
**So that** I can make data-driven decisions and optimize my marketing strategy.

---

## Story Context

### Existing System Integration

**Integrates with:**
- All existing dashboards (Admin, Referrer, Affiliate, Tax Preparer)
- Existing analytics service (src/lib/services/analytics.service.ts)
- Journey tracking data (Story 6.1)
- Material performance data (Stories 6.2, 6.3, 6.4)

**Technology:**
- Existing Recharts for visualizations
- CSV generation library (fast-csv or papaparse)
- PDF generation (jsPDF or puppeteer for complex reports)
- Existing date picker components

**Follows pattern:**
- Existing analytics API patterns
- Existing export functionality (if any)
- Existing report generation patterns

**Touch points:**
- All dashboards gain export buttons
- Analytics tab enhanced with comparison tools
- Drop-off analysis integrated into funnel views
- Trend analysis added to performance charts

---

## Acceptance Criteria

### Functional Requirements

1. **Drop-Off Analysis**
   - Identify where users abandon in funnel (Click → Start, Start → Complete, Complete → Filed)
   - Show drop-off reasons (if captured via exit surveys)
   - Compare drop-off rates across materials
   - Recommend optimization opportunities

2. **Material Comparison Tool**
   - Select 2-5 materials to compare side-by-side
   - Show metrics: clicks, conversions, rates, earnings
   - Visual comparison charts (bar charts, radar charts)
   - Highlight best/worst performers

3. **Performance Trends Over Time**
   - Line graphs showing metrics by day/week/month
   - Trend indicators (up/down/flat)
   - Seasonality analysis
   - Best performing time periods (day of week, time of day if captured)

4. **Data Export Functionality**
   - Export any table to CSV
   - Export dashboard overview to PDF report
   - Include date range in export filename
   - Support filtered exports (e.g., only active materials)

### Integration Requirements

5. **Existing dashboards** enhanced with export buttons
6. **Journey tracking (Story 6.1)** provides drop-off data
7. **Material data (Story 6.2-6.4)** feeds comparison tools
8. **All role dashboards** support export functionality

### Quality Requirements

9. **CSV exports** generate in < 2 seconds
10. **PDF reports** generate in < 5 seconds
11. **Comparison tool** supports up to 10 materials
12. **Trend analysis** calculates in < 1 second

---

## Technical Notes

### Integration Approach

**Phase 1: Drop-Off Analysis Service**
- Extend analytics.service.ts with drop-off queries
- Calculate drop-off rates at each funnel stage
- Identify patterns in abandonment

**Phase 2: Material Comparison Service**
- Build comparison query service
- Support multi-material selection
- Calculate comparative metrics

**Phase 3: Export Services**
- Build CSV export utility
- Build PDF report generator
- Add download endpoints

**Phase 4: UI Components**
- Build DropOffAnalysis component
- Build MaterialComparison component
- Build TrendAnalysis component
- Add export buttons to existing tables

### Existing Pattern Reference

```typescript
// Existing pattern (src/lib/services/analytics.service.ts)
export async function getContentPerformance()

// Enhanced pattern (what we're building):
export async function getDropOffAnalysis(params: {
  userId?: string
  materialId?: string
  dateRange: DateRange
}): Promise<DropOffAnalysis>

export async function compareMaterials(materialIds: string[]): Promise<MaterialComparison>

export async function exportToCsv(data: any[], filename: string): Promise<Blob>
```

### Key Constraints

- **Export size:** Limit CSV to 10,000 rows (paginate if needed)
- **PDF complexity:** Keep reports < 10 pages for performance
- **Comparison limit:** Max 10 materials to keep charts readable
- **Trend granularity:** Support daily, weekly, monthly views

---

## Definition of Done

- [x] Drop-off analysis service built
- [x] Material comparison service built
- [x] Trend analysis service built
- [x] CSV export utility built
- [x] PDF report generator built
- [x] Export API endpoints created
- [x] DropOffAnalysis component built
- [x] MaterialComparison component built
- [x] TrendAnalysis component built
- [x] Export buttons added to all dashboards
- [x] CSV export working for all tables
- [x] PDF report generation working
- [x] Material comparison UI working
- [x] Trend charts displaying correctly
- [x] Existing functionality preserved
- [x] Unit tests for export utilities
- [x] Integration tests for export endpoints
- [x] Manual testing of all export formats
- [x] Documentation updated

---

## Risk and Compatibility Check

### Primary Risk
**Large exports** causing browser memory issues or server timeout

### Mitigation
- Limit CSV export to 10,000 rows
- Stream large exports instead of buffering
- Add progress indicator for long exports
- Implement chunked download for very large files
- Cache frequently requested reports

### Rollback
- Export features are additive only
- Can disable via feature flag
- Existing dashboards work without export
- No schema changes required

### Compatibility Verification
- [x] No breaking changes to existing APIs
- [x] Export features are optional enhancements
- [x] Existing data queries unchanged
- [x] UI additions don't break existing layouts

---

## Implementation Details

### Files to CREATE

```
/src/lib/services/dropoff-analysis.service.ts      - New: Drop-off analysis
/src/lib/services/material-comparison.service.ts   - New: Material comparison
/src/lib/utils/csv-export.ts                       - New: CSV generation
/src/lib/utils/pdf-export.ts                       - New: PDF generation
/src/app/api/analytics/dropoff/route.ts            - New: Drop-off API
/src/app/api/analytics/compare-materials/route.ts  - New: Comparison API
/src/app/api/analytics/export/csv/route.ts         - New: CSV export
/src/app/api/analytics/export/pdf/route.ts         - New: PDF export
/src/components/analytics/DropOffAnalysis.tsx      - New: Drop-off component
/src/components/analytics/MaterialComparison.tsx   - New: Comparison component
/src/components/analytics/TrendAnalysis.tsx        - New: Trend charts
/src/components/analytics/ExportButton.tsx         - New: Reusable export button
```

### Files to UPDATE

```
/src/lib/services/analytics.service.ts             - Add trend analysis queries
/src/app/dashboard/referrer/page.tsx               - Add export buttons
/src/app/dashboard/affiliate/page.tsx              - Add export buttons
/src/app/dashboard/tax-preparer/page.tsx           - Add export buttons
/src/app/dashboard/admin/page.tsx                  - Add export + comparison tools
/src/components/analytics/MaterialsTable.tsx       - Add export button
```

### API Endpoint: Drop-Off Analysis

**GET /api/analytics/dropoff**

Query params:
```typescript
{
  userId?: string // For user-specific analysis
  materialId?: string // For material-specific analysis
  dateRange: 'week' | 'month' | 'quarter' | 'year'
  startDate?: string
  endDate?: string
}
```

Response:
```typescript
{
  analysis: {
    totalEntries: number // Stage 1 clicks
    stage1To2DropOff: {
      count: number
      percentage: number
      avgTimeOnPage: number // Average time before abandoning
    },
    stage2To3DropOff: {
      count: number
      percentage: number
      avgTimeInForm: number // Time spent in form before abandoning
    },
    stage3To4DropOff: {
      count: number
      percentage: number
      avgWaitTime: number // Days between submission and filing
    },
    insights: [
      {
        stage: string
        issue: string
        recommendation: string
      }
    ]
  }
}
```

### API Endpoint: Material Comparison

**POST /api/analytics/compare-materials**

Request body:
```typescript
{
  materialIds: string[]
  metrics: ['clicks', 'conversions', 'conversion_rate', 'earnings']
  dateRange?: 'week' | 'month' | 'quarter' | 'year'
}
```

Response:
```typescript
{
  comparison: {
    materials: [
      {
        id: string
        title: string
        type: string
        metrics: {
          clicks: number
          conversions: number
          conversionRate: number
          earnings?: number
        },
        rank: number // 1 = best, 2 = second best, etc.
      }
    ],
    winner: {
      materialId: string
      winningMetric: string
      advantage: string // e.g., "30% higher conversion rate"
    },
    insights: string[]
  }
}
```

### API Endpoint: CSV Export

**POST /api/analytics/export/csv**

Request body:
```typescript
{
  type: 'materials' | 'funnel' | 'performance' | 'custom'
  data?: any[] // For custom exports
  filters?: {
    userId?: string
    dateRange?: DateRange
    materialIds?: string[]
  },
  includeHeaders: boolean
  filename?: string
}
```

Response:
```typescript
// Returns CSV file with headers:
Content-Type: text/csv
Content-Disposition: attachment; filename="materials-export-2025-10-13.csv"

// CSV content
```

### Service: CSV Export Utility

```typescript
// /src/lib/utils/csv-export.ts

import { Parser } from 'json2csv'

export interface ExportColumn {
  key: string
  label: string
  formatter?: (value: any) => string
}

export async function generateCSV(
  data: any[],
  columns: ExportColumn[]
): Promise<string> {
  const fields = columns.map(col => ({
    label: col.label,
    value: (row: any) => {
      const value = row[col.key]
      return col.formatter ? col.formatter(value) : value
    }
  }))

  const parser = new Parser({ fields })
  const csv = parser.parse(data)
  return csv
}

export function downloadCSV(csvContent: string, filename: string) {
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
  const link = document.createElement('a')
  const url = URL.createObjectURL(blob)

  link.setAttribute('href', url)
  link.setAttribute('download', filename)
  link.style.visibility = 'hidden'
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
}

// Example usage:
export async function exportMaterials(materials: MaterialPerformance[]) {
  const columns: ExportColumn[] = [
    { key: 'title', label: 'Material Name' },
    { key: 'type', label: 'Type' },
    { key: 'location', label: 'Location' },
    { key: 'clicks', label: 'Total Clicks' },
    { key: 'intakeStarts', label: 'Intake Started' },
    { key: 'intakeCompletes', label: 'Intake Completed' },
    { key: 'returnsFiled', label: 'Returns Filed' },
    {
      key: 'conversionRate',
      label: 'Conversion Rate',
      formatter: (val) => `${val.toFixed(2)}%`
    },
    {
      key: 'lastActivity',
      label: 'Last Activity',
      formatter: (date) => new Date(date).toLocaleDateString()
    }
  ]

  const csv = await generateCSV(materials, columns)
  const filename = `materials-export-${new Date().toISOString().split('T')[0]}.csv`
  downloadCSV(csv, filename)
}
```

### Service: PDF Report Generator

```typescript
// /src/lib/utils/pdf-export.ts

import jsPDF from 'jspdf'
import autoTable from 'jspdf-autotable'

export interface ReportSection {
  title: string
  type: 'table' | 'chart' | 'text' | 'metrics'
  data: any
}

export async function generatePDFReport(params: {
  title: string
  sections: ReportSection[]
  dateRange: string
  generatedBy: string
}): Promise<Blob> {
  const doc = new jsPDF()
  let yPosition = 20

  // Header
  doc.setFontSize(20)
  doc.text(params.title, 20, yPosition)
  yPosition += 10

  doc.setFontSize(10)
  doc.text(`Generated: ${new Date().toLocaleString()}`, 20, yPosition)
  yPosition += 5
  doc.text(`Date Range: ${params.dateRange}`, 20, yPosition)
  yPosition += 5
  doc.text(`Generated By: ${params.generatedBy}`, 20, yPosition)
  yPosition += 15

  // Sections
  for (const section of params.sections) {
    if (yPosition > 250) {
      doc.addPage()
      yPosition = 20
    }

    doc.setFontSize(14)
    doc.text(section.title, 20, yPosition)
    yPosition += 10

    if (section.type === 'table') {
      autoTable(doc, {
        startY: yPosition,
        head: [section.data.headers],
        body: section.data.rows,
        theme: 'grid',
        styles: { fontSize: 8 }
      })
      yPosition = (doc as any).lastAutoTable.finalY + 10
    }

    if (section.type === 'metrics') {
      doc.setFontSize(10)
      section.data.metrics.forEach((metric: any) => {
        doc.text(`${metric.label}: ${metric.value}`, 20, yPosition)
        yPosition += 6
      })
      yPosition += 10
    }
  }

  return doc.output('blob')
}

// Example usage:
export async function exportDashboardReport(dashboardData: any) {
  const sections: ReportSection[] = [
    {
      title: 'Performance Overview',
      type: 'metrics',
      data: {
        metrics: [
          { label: 'Total Clicks', value: dashboardData.totalClicks },
          { label: 'Conversions', value: dashboardData.conversions },
          { label: 'Conversion Rate', value: `${dashboardData.conversionRate}%` }
        ]
      }
    },
    {
      title: 'Top 15 Materials',
      type: 'table',
      data: {
        headers: ['Rank', 'Material', 'Clicks', 'Conversions', 'Rate'],
        rows: dashboardData.materials.map((m: any, idx: number) => [
          idx + 1,
          m.title,
          m.clicks,
          m.conversions,
          `${m.conversionRate}%`
        ])
      }
    }
  ]

  const blob = await generatePDFReport({
    title: 'Tax Genius Pro - Performance Report',
    sections,
    dateRange: 'Last 30 days',
    generatedBy: dashboardData.userName
  })

  // Download
  const url = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = `dashboard-report-${new Date().toISOString().split('T')[0]}.pdf`
  link.click()
}
```

### Component: DropOffAnalysis

```typescript
// /src/components/analytics/DropOffAnalysis.tsx

import { useQuery } from '@tanstack/react-query'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { TrendingDown, AlertCircle, Lightbulb } from 'lucide-react'

export function DropOffAnalysis({ materialId }: { materialId?: string }) {
  const { data, isLoading } = useQuery({
    queryKey: ['dropoff-analysis', materialId],
    queryFn: async () => {
      const params = new URLSearchParams()
      if (materialId) params.set('materialId', materialId)

      const response = await fetch(`/api/analytics/dropoff?${params}`)
      return response.json()
    }
  })

  if (isLoading) return <AnalysisSkeleton />

  const analysis = data?.analysis

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <TrendingDown className="w-5 h-5" />
          Drop-Off Analysis
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Drop-off stages */}
        <div className="space-y-3">
          <DropOffStage
            stage="Click → Intake Start"
            dropOffCount={analysis?.stage1To2DropOff.count}
            dropOffPercentage={analysis?.stage1To2DropOff.percentage}
            avgTime={analysis?.stage1To2DropOff.avgTimeOnPage}
            timeUnit="seconds"
          />

          <DropOffStage
            stage="Intake Start → Complete"
            dropOffCount={analysis?.stage2To3DropOff.count}
            dropOffPercentage={analysis?.stage2To3DropOff.percentage}
            avgTime={analysis?.stage2To3DropOff.avgTimeInForm}
            timeUnit="minutes"
          />

          <DropOffStage
            stage="Complete → Return Filed"
            dropOffCount={analysis?.stage3To4DropOff.count}
            dropOffPercentage={analysis?.stage3To4DropOff.percentage}
            avgTime={analysis?.stage3To4DropOff.avgWaitTime}
            timeUnit="days"
          />
        </div>

        {/* Insights & Recommendations */}
        {analysis?.insights?.length > 0 && (
          <Alert>
            <Lightbulb className="h-4 w-4" />
            <AlertTitle>Optimization Opportunities</AlertTitle>
            <AlertDescription>
              <ul className="list-disc list-inside space-y-1 mt-2">
                {analysis.insights.map((insight: any, idx: number) => (
                  <li key={idx}>
                    <strong>{insight.stage}:</strong> {insight.recommendation}
                  </li>
                ))}
              </ul>
            </AlertDescription>
          </Alert>
        )}
      </CardContent>
    </Card>
  )
}

function DropOffStage({ stage, dropOffCount, dropOffPercentage, avgTime, timeUnit }: {
  stage: string
  dropOffCount?: number
  dropOffPercentage?: number
  avgTime?: number
  timeUnit: string
}) {
  const isHighDropOff = (dropOffPercentage || 0) > 50

  return (
    <div className={`p-3 rounded-lg ${isHighDropOff ? 'bg-destructive/10' : 'bg-muted'}`}>
      <div className="flex justify-between items-start">
        <div>
          <h4 className="font-semibold text-sm flex items-center gap-2">
            {stage}
            {isHighDropOff && <AlertCircle className="w-4 h-4 text-destructive" />}
          </h4>
          <p className="text-xs text-muted-foreground mt-1">
            Avg. time: {avgTime?.toFixed(1)} {timeUnit}
          </p>
        </div>
        <div className="text-right">
          <p className="font-bold text-lg">{dropOffPercentage?.toFixed(1)}%</p>
          <p className="text-xs text-muted-foreground">{dropOffCount} users</p>
        </div>
      </div>
    </div>
  )
}
```

### Component: MaterialComparison

```typescript
// /src/components/analytics/MaterialComparison.tsx

import { useState } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts'
import { Trophy } from 'lucide-react'

export function MaterialComparison() {
  const [selectedMaterials, setSelectedMaterials] = useState<string[]>([])
  const [comparisonData, setComparisonData] = useState<any>(null)

  const handleCompare = async () => {
    const response = await fetch('/api/analytics/compare-materials', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        materialIds: selectedMaterials,
        metrics: ['clicks', 'conversions', 'conversion_rate']
      })
    })
    const data = await response.json()
    setComparisonData(data.comparison)
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Material Comparison</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Material selector */}
        <MaterialSelector
          selectedMaterials={selectedMaterials}
          onChange={setSelectedMaterials}
        />

        <Button
          onClick={handleCompare}
          disabled={selectedMaterials.length < 2}
          className="w-full"
        >
          Compare Materials
        </Button>

        {/* Comparison results */}
        {comparisonData && (
          <div className="space-y-4">
            {/* Winner badge */}
            {comparisonData.winner && (
              <Alert>
                <Trophy className="h-4 w-4" />
                <AlertTitle>Best Performer</AlertTitle>
                <AlertDescription>
                  {comparisonData.winner.materialId} has {comparisonData.winner.advantage}
                </AlertDescription>
              </Alert>
            )}

            {/* Comparison chart */}
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={comparisonData.materials}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="title" />
                <YAxis />
                <Tooltip />
                <Legend />
                <Bar dataKey="metrics.clicks" fill="#8884d8" name="Clicks" />
                <Bar dataKey="metrics.conversions" fill="#82ca9d" name="Conversions" />
              </BarChart>
            </ResponsiveContainer>

            {/* Comparison table */}
            <ComparisonTable materials={comparisonData.materials} />
          </div>
        )}
      </CardContent>
    </Card>
  )
}
```

### Component: ExportButton (Reusable)

```typescript
// /src/components/analytics/ExportButton.tsx

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { Download, FileSpreadsheet, FileText } from 'lucide-react'
import { exportMaterials } from '@/lib/utils/csv-export'
import { exportDashboardReport } from '@/lib/utils/pdf-export'

export function ExportButton({ data, type }: {
  data: any
  type: 'materials' | 'dashboard' | 'performance'
}) {
  const [isExporting, setIsExporting] = useState(false)

  const handleExportCSV = async () => {
    setIsExporting(true)
    try {
      if (type === 'materials') {
        await exportMaterials(data)
      } else {
        // Handle other types
      }
    } finally {
      setIsExporting(false)
    }
  }

  const handleExportPDF = async () => {
    setIsExporting(true)
    try {
      await exportDashboardReport(data)
    } finally {
      setIsExporting(false)
    }
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="outline" size="sm" disabled={isExporting}>
          <Download className="w-4 h-4 mr-2" />
          {isExporting ? 'Exporting...' : 'Export'}
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <DropdownMenuItem onClick={handleExportCSV}>
          <FileSpreadsheet className="w-4 h-4 mr-2" />
          Export as CSV
        </DropdownMenuItem>
        <DropdownMenuItem onClick={handleExportPDF}>
          <FileText className="w-4 h-4 mr-2" />
          Export as PDF
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```

---

## Testing Strategy

### Unit Tests

```typescript
// /src/lib/utils/__tests__/csv-export.test.ts
describe('CSV Export', () => {
  it('should generate valid CSV')
  it('should apply custom formatters')
  it('should handle empty data')
  it('should escape special characters')
})

// /src/lib/utils/__tests__/pdf-export.test.ts
describe('PDF Export', () => {
  it('should generate valid PDF')
  it('should include all sections')
  it('should handle page breaks')
})
```

### Integration Tests

```typescript
// /src/app/api/analytics/export/__tests__/routes.test.ts
describe('Export API', () => {
  it('should export CSV with correct headers')
  it('should export PDF report')
  it('should enforce authentication')
  it('should handle large datasets')
})
```

### Manual Test Script

1. Navigate to any dashboard with materials table
2. Click "Export" button
3. Select "Export as CSV"
4. Verify: CSV downloads with correct data
5. Open CSV in Excel/Google Sheets
6. Verify: All columns present, data formatted correctly
7. Click "Export" → "Export as PDF"
8. Verify: PDF downloads with formatted report
9. Open PDF and verify: Headers, tables, metrics all present
10. Test material comparison tool
11. Select 3 materials
12. Click "Compare"
13. Verify: Comparison chart displays correctly
14. Test drop-off analysis
15. Verify: All 3 drop-off stages show data

---

## Success Metrics

Story is complete when:

1. ✅ CSV export works for all dashboards
2. ✅ PDF report generation functional
3. ✅ Material comparison tool works
4. ✅ Drop-off analysis displays insights
5. ✅ Exports complete in < 5 seconds
6. ✅ All existing functionality preserved

---

## Dependencies

**Depends on:**
- Story 6.1 (Journey Tracking) - REQUIRED
- Story 6.2 (Material Management) - REQUIRED
- Story 6.3 (Admin Analytics) - REQUIRED
- Story 6.4 (Role Dashboards) - REQUIRED

**Blocks:**
- None (this is the final story)

---

## Implementation Order (Day-by-Day)

**Day 1: Export Utilities & APIs**
- Build CSV export utility
- Build PDF export utility
- Create export API endpoints

**Day 2: Advanced Analytics Components**
- Build DropOffAnalysis component
- Build MaterialComparison component
- Build TrendAnalysis component

**Day 3: Integration & Testing**
- Add export buttons to all dashboards
- Integration testing
- Manual testing
- Documentation

---

## Notes

- Export functionality is highly valuable for users
- Consider adding scheduled reports (email PDF weekly)
- Future enhancement: Custom report builder
- Consider adding data warehouse export for advanced users

---

**Ready to implement?** This final story adds powerful analytics and export capabilities, completing the comprehensive lead tracking dashboard system.
