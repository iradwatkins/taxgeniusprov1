// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ Authentication & Users ============

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  hashedPassword String?
  emailVerified  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  sessions      Session[]
  profile       Profile?
  oauthAccounts OAuthAccount[]
  magicLinks    MagicLink[]

  // CRM Relations (Epic 7)
  crmContact     CRMContact?
  crmInteractions CRMInteraction[]

  @@map("users")
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model OAuthAccount {
  providerId     String
  providerUserId String
  userId         String
  user           User   @relation(references: [id], fields: [userId], onDelete: Cascade)

  @@id([providerId, providerUserId])
  @@index([userId])
  @@map("oauth_accounts")
}

model MagicLink {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@map("magic_links")
}

// ============ User Profiles ============

enum UserRole {
  SUPER_ADMIN
  ADMIN
  LEAD          // Default role for new signups (pending admin approval)
  CLIENT        // User who has completed tax preparation with Tax Genius
  TAX_PREPARER  // Tax professional
  AFFILIATE     // Referrer working for Tax Genius (hasn't done taxes with us)
}

model Profile {
  id          String   @id @default(cuid())
  userId      String?  @unique // Lucia auth user ID (legacy)
  user        User?    @relation(references: [id], fields: [userId], onDelete: Cascade)
  clerkUserId String?  @unique // Clerk user ID (current)
  role        UserRole
  firstName   String?
  lastName    String?
  phone       String?
  vanitySlug  String?  @unique // For referrers: TaxGenius.com/YourName
  avatarUrl   String?
  bio         String?
  companyName String? // For preparers
  licenseNo   String? // For preparers
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Universal Tracking System (Auto-generated on signup)
  trackingCode        String?  @unique // Auto-generated unique code (e.g., "TGP-123456")
  customTrackingCode  String?  @unique // One-time customizable vanity code
  trackingCodeChanged Boolean  @default(false) // Enforce one-time change rule
  trackingCodeQRUrl   String?  @db.Text // Pre-generated QR code data URL

  // Short Link System (NEW - Epic 6)
  shortLinkUsername        String?  @unique // Username for short links (e.g., "irawatkins")
  shortLinkUsernameChanged Boolean  @default(false) // One-time change enforcement

  // Affiliate Bonding (NEW - Epic 6)
  affiliateBondedToPreparerId String? // For affiliates: which preparer they're bonded to

  // Booking Preferences (For Tax Preparers)
  bookingEnabled              Boolean @default(true) // Master toggle for all booking
  allowPhoneBookings          Boolean @default(true) // Allow phone call appointments
  allowVideoBookings          Boolean @default(true) // Allow video call appointments
  allowInPersonBookings       Boolean @default(true) // Allow in-person appointments
  requireApprovalForBookings  Boolean @default(false) // Require manual approval for all bookings
  customBookingMessage        String? @db.Text // Custom message shown on booking page
  bookingCalendarColor        String? // Hex color for calendar display (#3B82F6)

  // Encrypted sensitive data
  ssn         String? // Encrypted
  dateOfBirth String? // Encrypted
  address     Json? // Encrypted JSON
  bankDetails Json? // Encrypted JSON for commission payments

  // Relations
  referrerReferrals   Referral[]           @relation("ReferrerReferrals")
  clientReferrals     Referral[]           @relation("ClientReferrals")
  preparerClients     ClientPreparer[]     @relation("PreparerClients")
  clientPreparers     ClientPreparer[]     @relation("ClientPreparers")
  notifications       Notification[]
  contestParticipant  ContestParticipant[]
  documents           Document[]
  taxReturns          TaxReturn[]
  payments            Payment[]
  commissions         Commission[]
  payoutRequests      PayoutRequest[]      @relation("PayoutRequests")
  orders              Order[]
  subscriptions       Subscription[]
  campaigns           MarketingCampaign[]
  affiliateBondings   AffiliateBonding[]   @relation("AffiliateBondings")
  preparerBondings    AffiliateBonding[]   @relation("PreparerBondings")
  taxIntakeLeads      TaxIntakeLead[]      // Leads converted to this profile
  folders             Folder[]             @relation("OwnedFolders") // File manager folders
  fileOperations      FileOperation[]      // File operation audit trail

  // Support Ticket Relations
  createdTickets      SupportTicket[]      @relation("TicketCreator") // Tickets created by this user
  assignedTickets     SupportTicket[]      @relation("TicketAssignee") // Tickets assigned to this preparer
  ticketMessages      TicketMessage[]      @relation("TicketMessageSender") // Messages sent in tickets
  savedReplies        SavedReply[]         @relation("SavedReplyCreator") // Saved reply templates
  createdWorkflows    TicketWorkflow[]     @relation("WorkflowCreator") // Workflows created by this user
  timeEntries         TicketTimeEntry[]    @relation("TimeEntryPreparer") // Time tracking entries
  settingsUpdates     SystemSettings[]     @relation("SettingsUpdater") // Settings updated by this user

  @@index([role])
  @@index([vanitySlug])
  @@index([clerkUserId])
  @@index([trackingCode])
  @@index([customTrackingCode])
  @@index([shortLinkUsername])
  @@index([affiliateBondedToPreparerId])
  @@map("profiles")
}

// ============ Referral System ============

enum ReferralStatus {
  PENDING
  ACTIVE
  COMPLETED
  INACTIVE
}

model Referral {
  id               String         @id @default(cuid())
  referrerId       String
  referrer         Profile        @relation("ReferrerReferrals", references: [id], fields: [referrerId], onDelete: Cascade)
  clientId         String
  client           Profile        @relation("ClientReferrals", references: [id], fields: [clientId], onDelete: Cascade)
  referralCode     String         @unique
  signupDate       DateTime       @default(now())
  status           ReferralStatus @default(PENDING)
  returnFiledDate  DateTime?
  commissionEarned Decimal        @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  analytics   ReferralAnalytics[]
  commissions Commission[]

  @@index([referrerId])
  @@index([clientId])
  @@index([referralCode])
  @@map("referrals")
}

enum AnalyticsEventType {
  LINK_CLICK
  SIGNUP
  RETURN_FILED
  COMMISSION_EARNED
}

model ReferralAnalytics {
  id             String             @id @default(cuid())
  referralId     String?
  referral       Referral?          @relation(references: [id], fields: [referralId], onDelete: Cascade)
  eventType      AnalyticsEventType
  eventDate      DateTime           @default(now())
  ipAddress      String?
  userAgent      String?
  referralSource String?
  metadata       Json?
  createdAt      DateTime           @default(now())

  @@index([referralId])
  @@index([eventType])
  @@map("referral_analytics")
}

// ============ Contest System ============

enum ContestType {
  MOST_REFERRALS
  MOST_RETURNS
  HIGHEST_EARNINGS
}

model Contest {
  id               String      @id @default(cuid())
  title            String
  description      String?
  startDate        DateTime
  endDate          DateTime
  contestType      ContestType
  prizeDescription String?
  rules            Json?
  isActive         Boolean     @default(true)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Relations
  participants ContestParticipant[]
  leaderboard  ContestLeaderboard[]

  @@index([isActive])
  @@index([startDate, endDate])
  @@map("contests")
}

model ContestParticipant {
  id        String   @id @default(cuid())
  contestId String
  contest   Contest  @relation(references: [id], fields: [contestId], onDelete: Cascade)
  profileId String
  profile   Profile  @relation(references: [id], fields: [profileId], onDelete: Cascade)
  score     Decimal  @default(0)
  rank      Int?
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([contestId, profileId])
  @@index([contestId])
  @@index([profileId])
  @@map("contest_participants")
}

model ContestLeaderboard {
  id             String   @id @default(cuid())
  contestId      String
  contest        Contest  @relation(references: [id], fields: [contestId], onDelete: Cascade)
  rank           Int
  profileId      String
  score          Decimal
  lastCalculated DateTime @default(now())

  @@unique([contestId, rank])
  @@index([contestId])
  @@map("contest_leaderboards")
}

// ============ Landing Pages (Epic 4) ============

model LandingPage {
  id              String   @id @default(cuid())
  slug            String   @unique
  city            String
  state           String?
  headline        String
  bodyContent     String   @db.Text
  metaTitle       String
  metaDescription String
  qaAccordion     Json // Array of {question: string, answer: string}
  generatedBy     String? // Clerk user ID of admin who generated
  version         Int      @default(1)
  isPublished     Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
  @@index([isPublished])
  @@index([city])
  @@map("landing_pages")
}

// ============ Marketing Materials ============

enum MaterialType {
  IMAGE
  TEXT
  VIDEO
  TEMPLATE
}

model MarketingMaterial {
  id           String       @id @default(cuid())
  title        String
  description  String?
  materialType MaterialType
  imageUrl     String?
  adCopy       String?      @db.Text
  templateHtml String?      @db.Text
  tags         String[]
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([isActive])
  @@index([materialType])
  @@map("marketing_materials")
}

// ============ Notifications ============

enum NotificationType {
  TRIP_REWARD
  CONTEST_WIN
  MILESTONE
  GENERAL
  PAYMENT_RECEIVED
  RETURN_STATUS
  NEW_MESSAGE
}

model Notification {
  id          String           @id @default(cuid())
  profileId   String
  profile     Profile          @relation(references: [id], fields: [profileId], onDelete: Cascade)
  type        NotificationType
  title       String
  message     String           @db.Text
  actionUrl   String?
  actionLabel String?
  isRead      Boolean          @default(false)
  isActioned  Boolean          @default(false)
  metadata    Json?
  createdAt   DateTime         @default(now())
  readAt      DateTime?
  actionedAt  DateTime?

  @@index([profileId])
  @@index([isRead])
  @@index([type])
  @@map("notifications")
}

// ============ Tax Preparation ============

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

model PreparerApplication {
  id              String            @id @default(cuid())
  firstName       String
  middleName      String?
  lastName        String
  email           String            @unique
  phone           String
  languages       String
  smsConsent      Boolean           @default(false)
  experienceLevel String? // "NEW" | "INTERMEDIATE" | "SEASONED"
  taxSoftware     String[]          @default([]) // Array of tax software used
  status          ApplicationStatus @default(PENDING)
  interviewDate   DateTime?
  notes           String?           @db.Text
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([email])
  @@index([status])
  @@map("preparer_applications")
}

enum ReferrerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model ReferrerApplication {
  id           String         @id @default(cuid())
  firstName    String
  lastName     String
  email        String         @unique
  phone        String
  referralCode String         @unique
  status       ReferrerStatus @default(ACTIVE)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([email])
  @@index([referralCode])
  @@index([status])
  @@map("referrer_applications")
}

model ClientPreparer {
  id         String   @id @default(cuid())
  clientId   String
  client     Profile  @relation("ClientPreparers", references: [id], fields: [clientId], onDelete: Cascade)
  preparerId String
  preparer   Profile  @relation("PreparerClients", references: [id], fields: [preparerId], onDelete: Cascade)
  assignedAt DateTime @default(now())
  isActive   Boolean  @default(true)

  @@unique([clientId, preparerId])
  @@index([clientId])
  @@index([preparerId])
  @@map("client_preparers")
}

// ============ Affiliate Bonding System (NEW - Epic 6) ============

model AffiliateBonding {
  id          String   @id @default(cuid())
  affiliateId String
  affiliate   Profile  @relation("AffiliateBondings", references: [id], fields: [affiliateId], onDelete: Cascade)
  preparerId  String
  preparer    Profile  @relation("PreparerBondings", references: [id], fields: [preparerId], onDelete: Cascade)
  bondedAt    DateTime @default(now())
  isActive    Boolean  @default(true)

  // Tax preparer's custom commission structure for this affiliate
  commissionStructure Json? // Example: {"tier1": {"count": 5, "rate": 50}, "tier2": {"count": 10, "rate": 75}}

  @@unique([affiliateId, preparerId])
  @@index([affiliateId, isActive])
  @@index([preparerId, isActive])
  @@map("affiliate_bondings")
}

enum TaxReturnStatus {
  DRAFT
  IN_REVIEW
  FILED
  ACCEPTED
  REJECTED
  AMENDED
}

model TaxReturn {
  id           String          @id @default(cuid())
  profileId    String
  profile      Profile         @relation(references: [id], fields: [profileId], onDelete: Cascade)
  taxYear      Int
  status       TaxReturnStatus @default(DRAFT)
  filedDate    DateTime?
  acceptedDate DateTime?
  refundAmount Decimal?
  oweAmount    Decimal?
  formData     Json            @db.JsonB // Encrypted tax form data
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  documents      Document[]
  payments       Payment[]
  sourceLead     TaxIntakeLead[] // If created from intake lead

  @@unique([profileId, taxYear])
  @@index([profileId])
  @@index([status])
  @@map("tax_returns")
}

// ============ Store & Marketing ============

model Product {
  id           String   @id @default(cuid())
  type         String   // "LANDING_PAGE", "MARKETING_MATERIAL", "EMAIL_ADDRESS", "DIGITAL_ASSET"
  name         String
  description  String?  @db.Text
  category     String?  // Product category for organization

  // Pricing
  price        Decimal  @db.Decimal(10, 2)
  recurring    Boolean  @default(false)
  interval     String?  // "MONTHLY", "6_MONTHS", "12_MONTHS"

  // Access control
  availableFor String[] // ["TAX_PREPARER", "AFFILIATE"]

  imageUrl     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  subscriptions Subscription[]

  @@index([type])
  @@index([isActive])
  @@index([category])
  @@map("products")
}

model Subscription {
  id          String   @id @default(cuid())
  profileId   String
  profile     Profile  @relation(references: [id], fields: [profileId], onDelete: Cascade)
  productId   String
  product     Product  @relation(references: [id], fields: [productId], onDelete: Cascade)

  status      String   // "ACTIVE", "CANCELLED", "EXPIRED"
  startDate   DateTime @default(now())
  endDate     DateTime?

  stripeSubId String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([profileId])
  @@index([status])
  @@map("subscriptions")
}

model MarketingCampaign {
  id            String   @id @default(cuid())
  creatorId     String
  creator       Profile  @relation(references: [id], fields: [creatorId], onDelete: Cascade)

  name          String
  type          String   // "QR_CODE", "SOCIAL_POST", "EMAIL", "LANDING_PAGE", "BUSINESS_CARD", "FLYER"

  // Customization (for tax preparers)
  isCustomized  Boolean  @default(false)
  customName    String?
  customPhoto   String?
  customPhone   String?
  customLicense String?

  // Tracking
  trackingCode  String   @unique
  landingUrl    String?
  qrCodeUrl     String?

  // Analytics
  views         Int      @default(0)
  clicks        Int      @default(0)
  signups       Int      @default(0)
  conversions   Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([creatorId])
  @@index([trackingCode])
  @@map("marketing_campaigns")
}

// ============ Documents ============

enum DocumentType {
  W2
  FORM_1099
  RECEIPT
  TAX_RETURN
  OTHER
}

enum DocumentStatus {
  PENDING        // Uploaded, waiting for review
  REVIEWED       // Reviewed by preparer
  APPROVED       // Approved for filing
  REJECTED       // Rejected, needs reupload
  PROCESSING     // Being processed
}

model Document {
  id          String          @id @default(cuid())
  profileId   String
  profile     Profile         @relation(references: [id], fields: [profileId], onDelete: Cascade)
  taxReturnId String?
  taxReturn   TaxReturn?      @relation(references: [id], fields: [taxReturnId], onDelete: Cascade)
  type        DocumentType
  fileName    String
  fileUrl     String          // R2 storage URL
  fileSize    Int
  mimeType    String
  isEncrypted Boolean         @default(true)
  metadata    Json?

  // Tax year and status tracking
  taxYear     Int             // Tax year this document belongs to (2024, 2023, etc.)
  status      DocumentStatus  @default(PENDING)

  // Review information (for tax preparers)
  reviewedBy  String?         // Profile ID of preparer who reviewed
  reviewedAt  DateTime?       // When document was reviewed
  reviewNotes String?         @db.Text // Review notes from preparer

  // File Manager enhancements
  folderId    String?         // Folder this document belongs to
  folder      Folder?         @relation(references: [id], fields: [folderId], onDelete: SetNull)
  sharedWith  String[]        // Array of profile IDs who have access
  tags        String[]        // Tags for organization
  version     Int             @default(1) // Version number for versioning
  isDeleted   Boolean         @default(false) // Soft delete flag
  deletedAt   DateTime?       // When document was deleted
  deletedBy   String?         // Who deleted it

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([profileId])
  @@index([taxReturnId])
  @@index([taxYear])
  @@index([status])
  @@index([reviewedBy])
  @@index([folderId])
  @@index([isDeleted])
  @@map("documents")
}

// Folder model for hierarchical file organization
model Folder {
  id          String   @id @default(cuid())
  name        String
  description String?

  // Hierarchical structure
  parentId    String?
  parent      Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Folder[] @relation("FolderHierarchy")

  // Ownership
  ownerId     String   // Profile ID of owner (client)
  owner       Profile  @relation("OwnedFolders", fields: [ownerId], references: [id], onDelete: Cascade)

  // Path for quick lookups (e.g., "/2024/receipts")
  path        String
  level       Int      @default(0) // Depth in hierarchy (0 = root)

  // Permissions (JSON structure for flexible permissions)
  // Example: { "tax_preparer": ["read", "write"], "client": ["read"] }
  permissions Json?

  // Documents in this folder
  documents   Document[]

  // Soft delete
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  deletedBy   String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ownerId])
  @@index([parentId])
  @@index([path])
  @@index([isDeleted])
  @@map("folders")
}

// File operation audit trail
enum FileOperationType {
  UPLOAD
  DOWNLOAD
  DELETE
  RENAME
  MOVE
  COPY
  SHARE
  FOLDER_CREATE
  FOLDER_DELETE
  FOLDER_RENAME
  PERMISSION_CHANGE
}

model FileOperation {
  id            String            @id @default(cuid())
  operation     FileOperationType

  // Who performed the operation
  performedBy   String            // Profile ID
  performer     Profile           @relation(fields: [performedBy], references: [id], onDelete: Cascade)

  // Target of operation
  documentId    String?           // If operation was on a document
  folderId      String?           // If operation was on a folder

  // Operation details (JSON)
  // Examples:
  // - MOVE: { "from": "/2024", "to": "/2023" }
  // - RENAME: { "oldName": "doc.pdf", "newName": "document.pdf" }
  // - SHARE: { "sharedWith": ["profile_id_1", "profile_id_2"] }
  details       Json?

  // IP address for security
  ipAddress     String?
  userAgent     String?

  timestamp     DateTime          @default(now())

  @@index([performedBy])
  @@index([documentId])
  @@index([folderId])
  @@index([operation])
  @@index([timestamp])
  @@map("file_operations")
}

// ============ Payments & Commissions ============

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentType {
  TAX_PREP_FEE
  COMMISSION
  REFUND
}

model Payment {
  id              String        @id @default(cuid())
  profileId       String
  profile         Profile       @relation(references: [id], fields: [profileId], onDelete: Cascade)
  taxReturnId     String?
  taxReturn       TaxReturn?    @relation(references: [id], fields: [taxReturnId], onDelete: SetNull)
  amount          Decimal
  type            PaymentType
  status          PaymentStatus @default(PENDING)
  squarePaymentId String?       @unique
  squareOrderId   String?
  metadata        Json?
  processedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([profileId])
  @@index([status])
  @@index([squarePaymentId])
  @@map("payments")
}

model Commission {
  id         String        @id @default(cuid())
  referrerId String
  referrer   Profile       @relation(references: [id], fields: [referrerId], onDelete: Cascade)
  referralId String
  referral   Referral      @relation(references: [id], fields: [referralId], onDelete: Cascade)
  amount     Decimal

  // Rate Locking (NEW - Epic 6)
  rateAtCreation   Decimal?  @db.Decimal(5, 2) // Commission rate when lead was created
  calculatedAmount Decimal?  @db.Decimal(10, 2) // Auto-calculated commission

  status     PaymentStatus @default(PENDING)
  paidAt     DateTime?
  paymentRef String? // Reference to payment transaction
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@index([referrerId])
  @@index([referralId])
  @@index([status])
  @@index([createdAt])
  @@map("commissions")
}

// Payout Request Model (Epic 5 - Story 5.2)
model PayoutRequest {
  id            String   @id @default(cuid())
  referrerId    String
  referrer      Profile  @relation("PayoutRequests", fields: [referrerId], references: [id], onDelete: Cascade)
  amount        Decimal  @db.Decimal(10, 2)
  commissionIds String[] // Array of commission IDs included in this payout
  status        String   @default("PENDING") // PENDING, APPROVED, PAID, REJECTED
  paymentMethod String   @default("BANK_TRANSFER") // BANK_TRANSFER, PAYPAL, SQUARE_CASH, etc.
  notes         String?  @db.Text
  requestedAt   DateTime @default(now())
  processedAt   DateTime?
  paymentRef    String? // Reference to payment transaction
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([referrerId])
  @@index([status])
  @@index([requestedAt])
  @@map("payout_requests")
}

// ============ Chat/Messages ============

model ChatRoom {
  id        String   @id @default(cuid())
  name      String?
  isGroup   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  participants ChatParticipant[]
  messages     ChatMessage[]

  @@map("chat_rooms")
}

model ChatParticipant {
  id         String   @id @default(cuid())
  roomId     String
  room       ChatRoom @relation(references: [id], fields: [roomId], onDelete: Cascade)
  profileId  String
  joinedAt   DateTime @default(now())
  lastReadAt DateTime @default(now())

  @@unique([roomId, profileId])
  @@index([roomId])
  @@index([profileId])
  @@map("chat_participants")
}

model ChatMessage {
  id        String    @id @default(cuid())
  roomId    String
  room      ChatRoom  @relation(references: [id], fields: [roomId], onDelete: Cascade)
  senderId  String
  content   String    @db.Text
  metadata  Json? // For attachments, etc.
  createdAt DateTime  @default(now())
  editedAt  DateTime?
  deletedAt DateTime?

  @@index([roomId])
  @@index([senderId])
  @@map("chat_messages")
}

// ============ Support Ticket System ============

enum TicketStatus {
  OPEN               // Newly created ticket
  IN_PROGRESS        // Preparer is working on it
  WAITING_CLIENT     // Waiting for client response
  WAITING_PREPARER   // Waiting for preparer response
  RESOLVED           // Issue resolved, awaiting confirmation
  CLOSED             // Ticket closed
  ARCHIVED           // Archived for historical reference
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model SupportTicket {
  id             String         @id @default(cuid())
  ticketNumber   String         @unique // Auto-generated: TGP-TICKET-12345
  title          String
  description    String         @db.Text
  status         TicketStatus   @default(OPEN)
  priority       TicketPriority @default(NORMAL)

  // Relationships
  creatorId      String // Client who created the ticket
  creator        Profile        @relation("TicketCreator", references: [id], fields: [creatorId], onDelete: Cascade)

  assignedToId   String? // Tax preparer assigned (auto-assigned via ClientPreparer)
  assignedTo     Profile?       @relation("TicketAssignee", references: [id], fields: [assignedToId], onDelete: SetNull)

  // Metadata
  tags           String[] // Categories: tax-deduction, filing-status, deadline, etc.
  customFields   Json? // Flexible additional data

  // Tracking
  firstResponseAt   DateTime? // When preparer first responded
  resolvedAt        DateTime? // When ticket was resolved
  closedAt          DateTime? // When ticket was closed
  lastActivityAt    DateTime  @default(now()) // Last message or update

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  messages       TicketMessage[]
  timeEntries    TicketTimeEntry[]
  workflowLogs   TicketWorkflowLog[]

  @@index([creatorId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([ticketNumber])
  @@index([lastActivityAt])
  @@map("support_tickets")
}

model TicketMessage {
  id              String        @id @default(cuid())
  ticketId        String
  ticket          SupportTicket @relation(references: [id], fields: [ticketId], onDelete: Cascade)

  senderId        String // Who sent this message
  senderProfile   Profile       @relation("TicketMessageSender", references: [id], fields: [senderId], onDelete: Cascade)

  content         String        @db.Text
  isInternal      Boolean       @default(false) // Internal notes (preparer-only)
  isAIGenerated   Boolean       @default(false) // AI-suggested response

  // Attachments
  attachments     Json? // Array of file URLs and metadata

  // Metadata
  metadata        Json? // Additional data (email headers, etc.)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  editedAt        DateTime?
  deletedAt       DateTime?

  @@index([ticketId])
  @@index([senderId])
  @@index([createdAt])
  @@map("ticket_messages")
}

model SavedReply {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text // Supports variables: {{client_name}}, {{ticket_number}}, etc.
  category    String? // tax-deduction, filing-status, deadline, general

  // Ownership
  createdById String
  createdBy   Profile  @relation("SavedReplyCreator", references: [id], fields: [createdById], onDelete: Cascade)

  isGlobal    Boolean  @default(false) // Available to all preparers or just creator

  // Usage tracking
  usageCount  Int      @default(0)
  lastUsedAt  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdById])
  @@index([category])
  @@index([isGlobal])
  @@map("saved_replies")
}

enum WorkflowTrigger {
  TICKET_CREATED           // When a new ticket is created
  TICKET_UPDATED           // When ticket status/priority changes
  TICKET_IDLE              // When no activity for X hours
  CLIENT_RESPONSE          // When client sends a message
  PREPARER_RESPONSE        // When preparer responds
  TICKET_ASSIGNED          // When ticket is assigned
  TICKET_UNASSIGNED        // When ticket is unassigned
}

enum WorkflowActionType {
  ASSIGN_PREPARER          // Auto-assign to preparer
  SEND_NOTIFICATION        // Send email/slack/sms
  ADD_TAG                  // Add tag to ticket
  CHANGE_STATUS            // Update ticket status
  CHANGE_PRIORITY          // Update ticket priority
  SEND_SAVED_REPLY         // Send pre-written response
  AUTO_CLOSE               // Close the ticket
  CREATE_TASK              // Create follow-up task
}

model TicketWorkflow {
  id             String          @id @default(cuid())
  name           String
  description    String?         @db.Text

  trigger        WorkflowTrigger
  isActive       Boolean         @default(true)
  priority       Int             @default(0) // Execution order

  // Conditions (JSON)
  conditions     Json? // { status: "OPEN", priority: "HIGH", tags: ["urgent"] }

  // Actions (JSON array)
  actions        Json // [{ type: "SEND_NOTIFICATION", config: {...} }]

  // Tracking
  lastTriggeredAt DateTime?
  triggerCount    Int            @default(0)

  createdById    String
  createdBy      Profile        @relation("WorkflowCreator", references: [id], fields: [createdById], onDelete: Cascade)

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  logs           TicketWorkflowLog[]

  @@index([trigger])
  @@index([isActive])
  @@index([priority])
  @@map("ticket_workflows")
}

model TicketWorkflowLog {
  id            String        @id @default(cuid())
  workflowId    String
  workflow      TicketWorkflow @relation(references: [id], fields: [workflowId], onDelete: Cascade)

  ticketId      String
  ticket        SupportTicket @relation(references: [id], fields: [ticketId], onDelete: Cascade)

  action        String // Action type executed
  result        String // success, failed, skipped
  details       Json? // Execution details

  executedAt    DateTime      @default(now())

  @@index([workflowId])
  @@index([ticketId])
  @@index([executedAt])
  @@map("ticket_workflow_logs")
}

model TicketTimeEntry {
  id              String        @id @default(cuid())
  ticketId        String
  ticket          SupportTicket @relation(references: [id], fields: [ticketId], onDelete: Cascade)

  preparerId      String // Tax preparer tracking time
  preparer        Profile       @relation("TimeEntryPreparer", references: [id], fields: [preparerId], onDelete: Cascade)

  startedAt       DateTime
  endedAt         DateTime?
  durationMinutes Int           @default(0) // Calculated duration

  isBillable      Boolean       @default(true)
  billableMinutes Int           @default(0)

  notes           String?       @db.Text
  isManual        Boolean       @default(false) // Manual entry vs timer

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([ticketId])
  @@index([preparerId])
  @@index([startedAt])
  @@map("ticket_time_entries")
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique // e.g., "support_system_enabled", "ai_enabled"
  value     String   @db.Text // JSON-encoded value
  category  String // support, notifications, integrations, security

  description String? @db.Text

  updatedById String?
  updatedBy   Profile? @relation("SettingsUpdater", references: [id], fields: [updatedById], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([category])
  @@map("system_settings")
}

// ============ Lead Generation ============

enum LeadType {
  CUSTOMER
  TAX_PREPARER
  AFFILIATE
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  DISQUALIFIED
}

model Lead {
  id        String     @id @default(cuid())
  type      LeadType
  status    LeadStatus @default(NEW)

  // Basic contact info (all types)
  firstName String
  lastName  String
  email     String
  phone     String

  // Customer-specific fields
  taxSituation    String? @db.Text
  estimatedIncome String?

  // Tax Preparer-specific fields
  ptin          String?
  certification String?
  experience    String?

  // Affiliate-specific fields
  marketingExperience String?
  audience            String?

  // Common optional fields
  message String? @db.Text

  // Metadata
  source        String? // URL/page where lead was captured
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  ipAddress     String?
  userAgent     String?

  // Attribution & Commission Locking (NEW - Epic 6)
  referrerUsername         String? // Username of referrer who brought this lead
  referrerType             String? // TAX_PREPARER, AFFILIATE, CLIENT, ADMIN
  commissionRate           Decimal?  @db.Decimal(5, 2) // Locked rate at lead creation
  commissionRateLockedAt   DateTime? // When rate was locked
  attributionMethod        String? // "cookie", "email_match", "phone_match", "direct"
  attributionCookieId      String? // Cookie ID used for attribution
  attributionConfidence    Int      @default(100) // 0-100 confidence score

  // Assignment & Follow-up tracking
  assignedPreparerId String? // Which preparer is handling this lead
  contactRequested   Boolean  @default(false) // Did they request a call/appointment?
  contactMethod      String? // "CALL", "APPOINTMENT", "EMAIL"
  lastContactedAt    DateTime? // When preparer last reached out
  contactNotes       String?  @db.Text // Notes from contact attempts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([email])
  @@index([createdAt])
  @@index([assignedPreparerId])
  @@index([contactRequested])
  @@index([referrerUsername])
  @@index([commissionRateLockedAt])
  @@index([attributionMethod])
  @@map("leads")
}

// ============ E-commerce / Store ============
// (Product model moved to Store & Marketing section above)

enum OrderStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Order {
  id              String      @id @default(cuid())
  userId          String
  profile         Profile     @relation(fields: [userId], references: [clerkUserId], onDelete: Cascade)
  stripeSessionId String      @unique
  items           Json // Array of { productId, name, quantity, price }
  total           Decimal     @db.Decimal(10, 2)
  status          OrderStatus @default(PENDING)
  email           String
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

// ============ Tax Intake Form Leads ============

model TaxIntakeLead {
  id            String   @id @default(cuid())

  // Personal Information
  first_name    String
  middle_name   String?
  last_name     String
  email         String   @unique
  phone         String
  country_code  String   @default("+1")

  // Address
  address_line_1 String?
  address_line_2 String?
  city           String?
  state          String?
  zip_code       String?

  // Full form data (JSON for remaining fields)
  full_form_data Json?    @db.JsonB

  // Tracking
  completed      Boolean  @default(false)

  // Attribution (NEW - Epic 6)
  referrerUsername  String? // Username who referred this intake
  referrerType      String? // TAX_PREPARER, AFFILIATE, CLIENT, ADMIN
  attributionMethod String? // "cookie", "email_match", "phone_match", "direct"

  // Assignment & Follow-up tracking
  assignedPreparerId String? // Which preparer is handling this intake
  contactRequested   Boolean  @default(false) // Did they request a call/appointment?
  contactMethod      String? // "CALL", "APPOINTMENT", "EMAIL"
  lastContactedAt    DateTime? // When preparer last reached out
  contactNotes       String?  @db.Text // Notes from contact attempts

  // Lead-to-Client Conversion (NEW - Auto-conversion)
  profileId         String?   // Link to Profile when user signs up
  profile           Profile?  @relation(fields: [profileId], references: [id], onDelete: SetNull)
  convertedToClient Boolean   @default(false) // Has this lead been converted to a client?
  taxReturnId       String?   // Track created TaxReturn
  taxReturn         TaxReturn? @relation(fields: [taxReturnId], references: [id], onDelete: SetNull)
  convertedAt       DateTime? // When conversion happened

  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  @@index([email])
  @@index([completed])
  @@index([created_at])
  @@index([assignedPreparerId])
  @@index([contactRequested])
  @@index([referrerUsername])
  @@index([attributionMethod])
  @@index([profileId])
  @@index([convertedToClient])
  @@index([taxReturnId])
  @@map("tax_intake_leads")
}

// ============ Page Analytics & Performance Tracking ============

model PageAnalytics {
  id             String   @id @default(cuid())
  path           String   // "/start-filing", "/services", etc
  views          Int      @default(0)
  uniqueVisitors Int      @default(0)
  bounceRate     Float?   // Percentage (0-100)
  avgTimeOnPage  Int?     // seconds
  conversions    Int      @default(0) // leads/signups from this page
  source         String?  // "organic", "direct", "referral", "social", "paid"
  referrer       String?  // Full referrer URL
  date           DateTime @default(now())
  createdAt      DateTime @default(now())

  @@index([path, date])
  @@index([date])
  @@index([source])
  @@map("page_analytics")
}

model ContentPerformance {
  id              String   @id @default(cuid())
  landingPageId   String?  // FK to LandingPage
  contentType     String   // "ai_generated", "manual", "template"
  title           String?  // Page/content title for identification
  views           Int      @default(0)
  clicks          Int      @default(0)
  conversions     Int      @default(0)
  ctr             Float?   // click-through rate (percentage)
  conversionRate  Float?   // conversion rate (percentage)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([landingPageId])
  @@index([contentType])
  @@index([createdAt])
  @@map("content_performance")
}

// ============ Client Intake Tracking ============

model ClientIntake {
  id        String   @id @default(cuid())

  // Client information
  firstName String
  lastName  String
  email     String
  phone     String

  // Assignment
  assignedPreparerId String? // Which preparer received this intake
  referredBy         String? // Referrer ID if came from referral link
  sourceLink         String? // Marketing link that brought them here

  // Form data
  formData  Json     @db.JsonB // Complete intake form data

  // Status tracking
  status    String   @default("SUBMITTED") // SUBMITTED, CONTACTED, IN_PROGRESS, COMPLETED

  // Conversion tracking
  convertedToClient Boolean  @default(false)
  convertedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assignedPreparerId])
  @@index([referredBy])
  @@index([status])
  @@index([createdAt])
  @@map("client_intakes")
}

// ============ Marketing Link Tracking ============

enum LinkType {
  REFERRAL
  LANDING_PAGE
  QR_CODE        // Keep for backward compatibility
  SOCIAL_MEDIA
  EMAIL_CAMPAIGN
  BUSINESS_CARD
  FLYER
  CUSTOM

  // NEW: Specific QR types (Epic 6 - Story 6.2)
  QR_POSTER
  QR_FLYER
  QR_BUSINESS_CARD
  QR_TABLE_TENT
  QR_BANNER
  DIGITAL_AD
  SMS_LINK
  WEBSITE_REFERRAL
}

model MarketingLink {
  id          String   @id @default(cuid())

  // Link ownership
  creatorId   String // Profile ID of preparer/referrer who created link
  creatorType String // "TAX_PREPARER", "REFERRER", "AFFILIATE", "ADMIN"

  // Link details
  linkType    LinkType
  code        String   @unique // Unique tracking code (e.g., "atlanta-taxes-john")
  url         String   // Full URL with tracking
  shortUrl    String?  // Shortened URL if applicable

  // Metadata
  title       String?  // Human-readable title ("John's Atlanta Flyer")
  description String?  @db.Text
  campaign    String?  // Campaign name for grouping

  // Destination
  targetPage  String   // Where the link goes ("/start-filing", "/services", etc)

  // Analytics (cached counts for performance)
  clicks      Int      @default(0)
  uniqueClicks Int     @default(0)
  conversions Int      @default(0) // Intake forms submitted
  signups     Int      @default(0) // Account creations
  returns     Int      @default(0) // Returns filed

  // NEW: Journey stage counters (Epic 6)
  intakeStarts    Int @default(0)
  intakeCompletes Int @default(0)
  returnsFiled    Int @default(0)

  // Performance metrics (calculated)
  conversionRate Float? // (conversions / clicks) * 100
  signupRate     Float? // (signups / clicks) * 100

  // NEW: Conversion rate caching (Epic 6)
  intakeConversionRate   Float? // (intakeStarts / clicks) * 100
  completeConversionRate Float? // (intakeCompletes / clicks) * 100
  filedConversionRate    Float? // (returnsFiled / clicks) * 100

  // NEW: Material-specific fields (Epic 6 - Story 6.2)
  location       String?  // Where material is placed/distributed
  notes          String?  @db.Text // Distribution notes, renewal dates
  qrCodeImageUrl String?  // Base64 data URL or storage URL of generated QR code
  qrCodeFormat   String?  @default("PNG") // PNG, SVG, PDF

  // NEW: Material lifecycle (Epic 6 - Story 6.2)
  dateActivated  DateTime? // When material was first distributed
  dateExpired    DateTime? // If material has expiration date
  printCount     Int @default(0) // How many times QR was downloaded

  // Status
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  linkClicks  LinkClick[]

  @@index([creatorId])
  @@index([code])
  @@index([linkType])
  @@index([isActive])
  @@index([createdAt])
  @@index([creatorId, isActive])
  @@index([linkType, isActive])
  // NEW: Performance indexes for Top 15 queries (Epic 6 - Story 6.3)
  @@index([creatorType, isActive, returnsFiled(sort: Desc)])
  @@index([isActive, returnsFiled(sort: Desc)])
  @@index([createdAt, isActive])
  @@map("marketing_links")
}

model LinkClick {
  id        String   @id @default(cuid())

  linkId    String
  link      MarketingLink @relation(references: [id], fields: [linkId], onDelete: Cascade)

  // Click metadata
  ipAddress String?
  userAgent String?
  referrer  String?  // Where they came from before clicking

  // Location (if tracked)
  city      String?
  state     String?
  country   String?

  // Conversion tracking
  converted Boolean  @default(false) // Did they submit intake form?
  signedUp  Boolean  @default(false) // Did they create account?
  clientId  String? // Profile ID if they converted

  clickedAt DateTime @default(now())

  // NEW: Journey stage timestamps (Epic 6)
  intakeStartedAt      DateTime?
  intakeCompletedAt    DateTime?
  taxReturnCompletedAt DateTime?

  // NEW: Enhanced UTM tracking (Epic 6)
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?

  // NEW: Cross-device attribution (Epic 6)
  userEmail              String? // Email entered in form (for device-agnostic attribution)
  userPhone              String? // Phone entered in form (for device-agnostic attribution)
  attributionConfidence  Int     @default(100) // 0-100 confidence score

  @@index([linkId])
  @@index([clickedAt])
  @@index([converted])
  @@index([intakeStartedAt])
  @@index([intakeCompletedAt])
  @@index([taxReturnCompletedAt])
  @@index([userEmail])
  @@index([userPhone])
  // NEW: Performance indexes for Top 15 Locations query (Epic 6 - Story 6.3)
  @@index([city, state, clickedAt])
  @@index([clickedAt, city, state])
  @@map("link_clicks")
}

// ============ Appointment Management ============

enum AppointmentStatus {
  REQUESTED      // Client requested appointment
  PENDING_APPROVAL // Waiting for preparer to approve
  SCHEDULED      // Preparer scheduled it
  CONFIRMED      // Client confirmed
  COMPLETED      // Appointment happened
  CANCELLED      // Cancelled by either party
  NO_SHOW        // Client didn't show up
  RESCHEDULED    // Moved to different time
}

enum AppointmentType {
  PHONE_CALL
  VIDEO_CALL
  IN_PERSON
  CONSULTATION
  FOLLOW_UP
}

// Service offerings for bookings
model BookingService {
  id          String   @id @default(cuid())
  preparerId  String?  // Null = available for all preparers

  name        String   // "Initial Consultation", "Document Review", etc
  slug        String   @unique // URL-friendly identifier
  description String?  @db.Text
  duration    Int      // Duration in minutes
  price       Decimal? @db.Decimal(10, 2) // Price in dollars

  // Settings
  requiresDeposit Boolean @default(false)
  depositAmount   Decimal? @db.Decimal(10, 2)
  requiresApproval Boolean @default(false) // Manual confirmation required
  bufferAfter     Int     @default(15) // Minutes buffer after appointment

  // Availability
  isActive    Boolean  @default(true)
  seasonalOnly Boolean @default(false) // Only available during tax season
  availableFrom DateTime?
  availableUntil DateTime?

  // Display
  color       String?  // Hex color for calendar display
  icon        String?  // Icon identifier
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([preparerId])
  @@index([isActive])
  @@map("booking_services")
}

// Preparer availability schedule
model PreparerAvailability {
  id         String   @id @default(cuid())
  preparerId String

  // Weekly recurring schedule
  dayOfWeek  Int      // 0 = Sunday, 1 = Monday, etc
  startTime  String   // "09:00" in 24-hour format
  endTime    String   // "17:00" in 24-hour format

  // Service restrictions
  serviceIds String[] // Empty = all services allowed

  // Override periods (vacations, tax season crunch, etc)
  isOverride Boolean  @default(false)
  overrideFrom DateTime?
  overrideUntil DateTime?
  overrideLabel String? // "Vacation", "Tax Season Hours", etc

  // Settings
  isActive   Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([preparerId, dayOfWeek])
  @@index([isOverride, overrideFrom, overrideUntil])
  @@map("preparer_availability")
}

model Appointment {
  id          String            @id @default(cuid())

  // Who
  clientId    String // Profile ID or Lead ID
  clientName  String // For quick display
  clientEmail String
  clientPhone String

  preparerId  String // Profile ID of assigned preparer

  // Service details
  serviceId   String? // Reference to BookingService
  type        AppointmentType
  status      AppointmentStatus @default(REQUESTED)

  // When
  requestedAt DateTime          @default(now()) // When client requested
  scheduledFor DateTime?        // When it's scheduled
  scheduledEnd DateTime?        // End time (calculated from duration)
  duration    Int?              // Minutes
  timezone    String?           // Client timezone

  // Details
  subject     String?           // "Initial Consultation", "Tax Review", etc
  notes       String?           @db.Text // Preparer notes
  clientNotes String?           @db.Text // What client said in request
  intakeData  Json?             // Structured intake form responses

  // Meeting details
  meetingLink String?           // Zoom/Google Meet link
  meetingPassword String?       // Meeting password if applicable
  location    String?           // Physical address if in-person

  // Payment
  paymentRequired Boolean       @default(false)
  paymentAmount   Decimal?      @db.Decimal(10, 2)
  paymentStatus   String?       // "pending", "paid", "refunded"
  stripePaymentId String?

  // Reminders sent
  reminder48hSent Boolean       @default(false)
  reminder24hSent Boolean       @default(false)
  reminder1hSent  Boolean       @default(false)
  reminderSentAt  DateTime?

  // SMS notifications
  smsReminderSent Boolean       @default(false)
  smsConfirmationSent Boolean   @default(false)

  // Completion
  completedAt DateTime?
  outcomeNotes String?          @db.Text // What happened in meeting

  // Cancellation
  cancelledAt DateTime?
  cancelledBy String? // "client" or "preparer"
  cancellationReason String?

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([preparerId])
  @@index([clientId])
  @@index([serviceId])
  @@index([status])
  @@index([scheduledFor])
  @@index([createdAt])
  @@map("appointments")
}

// ============ Follow-Up Log ============

enum FollowUpMethod {
  PHONE_CALL
  EMAIL
  TEXT_MESSAGE
  IN_PERSON
  VIDEO_CALL
}

enum FollowUpOutcome {
  CONNECTED     // Reached them
  NO_ANSWER     // No answer, left voicemail
  LEFT_MESSAGE  // Left voicemail/message
  EMAIL_SENT    // Email sent
  SCHEDULED     // Scheduled appointment
  CONVERTED     // They became a client
  NOT_INTERESTED // They declined
  UNREACHABLE   // Can't reach them
}

model FollowUpLog {
  id        String          @id @default(cuid())

  // Who
  clientId  String // Lead ID or Profile ID
  preparerId String // Who made the contact attempt

  // What happened
  method    FollowUpMethod
  outcome   FollowUpOutcome

  // Details
  notes     String?         @db.Text // What was discussed
  duration  Int?            // Minutes (for calls/meetings)

  // Next action
  nextFollowUp DateTime?    // When to follow up again
  nextAction   String?      // What to do next

  contactedAt DateTime      @default(now())
  createdAt   DateTime      @default(now())

  @@index([clientId])
  @@index([preparerId])
  @@index([contactedAt])
  @@index([nextFollowUp])
  @@map("follow_up_logs")
}

// ============ CRM System (Epic 7) ============

enum ContactType {
  CLIENT
  LEAD
  AFFILIATE
  PREPARER
}

enum PipelineStage {
  NEW
  CONTACTED
  QUALIFIED
  DOCUMENTS
  FILED
  CLOSED
  LOST
}

enum InteractionType {
  EMAIL
  PHONE_CALL
  MEETING
  NOTE
  OTHER
}

enum Direction {
  INBOUND
  OUTBOUND
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  CANCELLED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
}

enum EmailActivityStatus {
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}

// CRM Contact (extends existing User/Client/Preparer/Affiliate)
model CRMContact {
  id                String    @id @default(cuid())
  userId            String?   @unique  // FK to User table (legacy Lucia) - nullable for leads without users
  clerkUserId       String?   @unique  // FK to Clerk user (current)
  contactType       ContactType        // CLIENT | LEAD | AFFILIATE | PREPARER

  // Contact metadata
  firstName         String
  lastName          String
  email             String    @unique
  phone             String?
  company           String?

  // Tax-specific fields
  filingStatus      String?   // Single, Married, etc.
  dependents        Int?
  previousYearAGI   Float?
  taxYear           Int?

  // CRM lifecycle
  stage             PipelineStage @default(NEW)
  stageEnteredAt    DateTime  @default(now())
  source            String?   // utm_source, referral code, etc.

  // Assignment
  assignedPreparerId String?
  assignedAt        DateTime?

  // Lead Attribution (Epic 6 integration)
  referrerUsername         String? // Username of referrer who brought this lead
  referrerType             String? // TAX_PREPARER, AFFILIATE, CLIENT, ADMIN
  commissionRate           Decimal?  @db.Decimal(5, 2) // Locked rate at lead creation
  commissionRateLockedAt   DateTime? // When rate was locked
  attributionMethod        String? // "cookie", "email_match", "phone_match", "direct"
  attributionConfidence    Int      @default(100) // 0-100 confidence score

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastContactedAt   DateTime?

  // Lead scoring
  leadScore         Int       @default(0) // 0-100 lead score (auto-calculated)
  lastScoredAt      DateTime?

  // Relations
  user              User?     @relation(fields: [userId], references: [id])
  interactions      CRMInteraction[]
  stageHistory      CRMStageHistory[]
  tags              CRMContactTag[]
  tasks             CRMTask[]
  emailActivities   CRMEmailActivity[]
  leadScores        CRMLeadScore[]

  @@index([email])
  @@index([userId])
  @@index([clerkUserId])
  @@index([assignedPreparerId])
  @@index([stage])
  @@index([contactType])
  @@index([lastContactedAt])
  @@index([referrerUsername])
  @@index([leadScore])
  @@map("crm_contacts")
}

// CRM Interaction (phone, email, meeting, note)
model CRMInteraction {
  id                String    @id @default(cuid())
  contactId         String
  userId            String?   // Who logged this interaction (legacy Lucia)
  clerkUserId       String?   // Who logged this interaction (current Clerk)

  // Interaction details
  type              InteractionType
  direction         Direction @default(OUTBOUND) // INBOUND | OUTBOUND
  subject           String?
  body              String?   @db.Text
  duration          Int?      // minutes (for calls/meetings)

  // Email-specific (for Resend sync)
  emailId           String?   @unique // Resend email ID
  emailThreadId     String?   // For Gmail-style threading
  emailTo           String[]
  emailCc           String[]
  emailBcc          String[]

  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  occurredAt        DateTime  @default(now()) // When interaction happened

  // Attachments
  attachments       Json?     // Array of MinIO file keys

  // Relations
  contact           CRMContact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user              User?     @relation(fields: [userId], references: [id])

  @@index([contactId, occurredAt(sort: Desc)])
  @@index([emailThreadId])
  @@index([type])
  @@index([userId])
  @@index([clerkUserId])
  @@map("crm_interactions")
}

// Stage history tracking (for reporting)
model CRMStageHistory {
  id                String    @id @default(cuid())
  contactId         String
  fromStage         PipelineStage?
  toStage           PipelineStage
  changedBy         String?   // userId (legacy Lucia)
  changedByClerk    String?   // clerkUserId (current)
  reason            String?   @db.Text
  createdAt         DateTime  @default(now())

  contact           CRMContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId, createdAt(sort: Desc)])
  @@index([changedByClerk])
  @@map("crm_stage_history")
}

// CRM Tags (for contact segmentation)
model CRMTag {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "High Priority", "VIP", "Needs Follow-up"
  slug        String   @unique // e.g., "high-priority"
  color       String?  // Hex color for UI badges
  description String?  @db.Text
  createdBy   String?  // clerkUserId who created this tag
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  contacts    CRMContactTag[]

  @@map("crm_tags")
}

// CRM Contact Tags (many-to-many relationship)
model CRMContactTag {
  id         String   @id @default(cuid())
  contactId  String
  tagId      String
  addedBy    String?  // clerkUserId who added this tag
  addedAt    DateTime @default(now())

  // Relations
  contact    CRMContact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag        CRMTag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([contactId, tagId])
  @@index([contactId])
  @@index([tagId])
  @@map("crm_contact_tags")
}

// CRM Tasks (todo items per contact)
model CRMTask {
  id          String      @id @default(cuid())
  contactId   String
  title       String
  description String?     @db.Text
  dueDate     DateTime?
  priority    TaskPriority @default(MEDIUM) // LOW, MEDIUM, HIGH, URGENT
  status      TaskStatus   @default(TODO)   // TODO, IN_PROGRESS, DONE, CANCELLED

  // Assignment
  assignedTo  String?     // clerkUserId assigned to this task
  createdBy   String?     // clerkUserId who created this task
  completedBy String?     // clerkUserId who completed this task
  completedAt DateTime?

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  contact     CRMContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId])
  @@index([assignedTo])
  @@index([dueDate])
  @@index([status])
  @@map("crm_tasks")
}

// CRM Email Campaigns
model CRMEmailCampaign {
  id            String         @id @default(cuid())
  name          String
  subject       String
  fromName      String?
  fromEmail     String?
  replyTo       String?

  // Campaign content
  htmlBody      String         @db.Text
  plainTextBody String?        @db.Text
  templateId    String?        // Reference to email template if using one

  // Campaign settings
  status        CampaignStatus @default(DRAFT) // DRAFT, SCHEDULED, SENDING, SENT, PAUSED
  scheduledAt   DateTime?
  sentAt        DateTime?

  // Targeting
  segmentRules  Json?          // JSON rules for who receives this (e.g., stage, tags, etc.)
  recipientCount Int           @default(0)

  // Performance metrics
  sentCount     Int            @default(0)
  openedCount   Int            @default(0)
  clickedCount  Int            @default(0)
  bouncedCount  Int            @default(0)

  // Creator
  createdBy     String?        // clerkUserId
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  activities    CRMEmailActivity[]
  sequences     CRMEmailSequence[]

  @@index([status])
  @@index([scheduledAt])
  @@index([createdBy])
  @@map("crm_email_campaigns")
}

// CRM Email Sequence (automated drip campaigns)
model CRMEmailSequence {
  id            String    @id @default(cuid())
  campaignId    String?   // Optional: part of a larger campaign
  name          String
  description   String?   @db.Text

  // Sequence settings
  isActive      Boolean   @default(false)
  triggerEvent  String    // "contact_created", "stage_changed", "tag_added", etc.
  triggerDelay  Int       @default(0) // Minutes to wait before first email

  // Email steps (stored as JSON array)
  steps         Json      // [{ subject, body, delayMinutes }, ...]

  // Performance
  enrolledCount Int       @default(0)
  completedCount Int      @default(0)

  // Creator
  createdBy     String?   // clerkUserId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  campaign      CRMEmailCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([isActive])
  @@index([triggerEvent])
  @@map("crm_email_sequences")
}

// CRM Email Activity (track individual email interactions)
model CRMEmailActivity {
  id          String    @id @default(cuid())
  contactId   String
  campaignId  String?

  // Email details
  subject     String
  emailId     String?   @unique // Resend email ID
  messageId   String?   // SMTP message ID

  // Status
  status      EmailActivityStatus @default(SENT) // SENT, DELIVERED, OPENED, CLICKED, BOUNCED, FAILED

  // Tracking
  sentAt      DateTime  @default(now())
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  bouncedAt   DateTime?

  // Click tracking
  clickedUrls Json?     // Array of clicked URLs with timestamps

  // Error handling
  errorMessage String?  @db.Text

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  contact     CRMContact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  campaign    CRMEmailCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([contactId])
  @@index([campaignId])
  @@index([status])
  @@index([sentAt])
  @@map("crm_email_activities")
}

// CRM Lead Score (historical tracking of lead scores)
model CRMLeadScore {
  id          String   @id @default(cuid())
  contactId   String
  score       Int      // 0-100 score

  // Score breakdown (JSON with component scores)
  breakdown   Json?    // { email_engagement: 20, interactions: 30, stage: 25, recency: 15, ... }

  // Reason for score change
  reason      String?  @db.Text
  changedBy   String?  // "system" or clerkUserId if manually adjusted

  // Metadata
  createdAt   DateTime @default(now())

  // Relations
  contact     CRMContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId, createdAt(sort: Desc)])
  @@index([score])
  @@map("crm_lead_scores")
}

// ============ Content Restrictions (Role-Based Access Control) ============

// Page/Route level restrictions
model PageRestriction {
  id                    String   @id @default(cuid())
  routePath             String   @unique // e.g., '/admin/users', '/dashboard/client/*'

  // Role-based access
  allowedRoles          String[] // Roles that CAN access (empty = all)
  blockedRoles          String[] // Roles that CANNOT access (takes priority)

  // Username-based access (highest priority)
  allowedUsernames      String[] // Usernames that always have access
  blockedUsernames      String[] // Usernames that are always blocked

  // Behavior settings
  allowNonLoggedIn      Boolean  @default(false) // Allow unauthenticated users
  redirectUrl           String?  // Custom redirect URL on block
  hideFromNav           Boolean  @default(false) // Hide from navigation menus
  showInNavOverride     Boolean  @default(false) // Force show in nav even if restricted

  // Custom blocking content
  customHtmlOnBlock     String?  @db.Text // Custom HTML/React to show when blocked

  // Priority and Status (NEW - for pattern matching & rule ordering)
  priority              Int      @default(0) // Higher = checked first (for wildcard patterns)
  isActive              Boolean  @default(true) // Enable/disable rule without deleting

  // Metadata
  description           String?  @db.Text // Admin note about this restriction
  createdBy             String?  // Clerk user ID who created this
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([routePath])
  @@index([isActive])
  @@index([priority])
  @@map("page_restrictions")
}

// Content/Component level restrictions (for sections within pages)
model ContentRestriction {
  id                    String   @id @default(cuid())
  contentType           String   // 'section', 'component', 'widget', 'feature'
  contentIdentifier     String   // Unique ID for the content piece

  // Role-based access
  allowedRoles          String[]
  blockedRoles          String[]

  // Username-based access (highest priority)
  allowedUsernames      String[]
  blockedUsernames      String[]

  // Visibility controls
  hideFromFrontend      Boolean  @default(false) // Hide but keep in API/data
  hideConditions        Json?    // Complex conditional hiding rules

  // Metadata
  description           String?  @db.Text
  createdBy             String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([contentType, contentIdentifier])
  @@index([contentType])
  @@index([contentIdentifier])
  @@map("content_restrictions")
}

// Dynamic route configuration (database-driven route protection)
model RouteConfig {
  id                    String   @id @default(cuid())
  routePattern          String   @unique // Pattern matching: '/admin/*', '/dashboard/:role/*'

  // Access control
  requiresAuth          Boolean  @default(true)
  allowedRoles          String[] // Empty = all authenticated users

  // Behavior
  redirectOnUnauth      String?  // Redirect unauthenticated users
  redirectOnForbidden   String?  // Redirect unauthorized (wrong role) users
  priority              Int      @default(0) // Higher priority patterns checked first

  // Settings
  enabled               Boolean  @default(true)
  description           String?  @db.Text

  // Metadata
  createdBy             String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([routePattern])
  @@index([priority])
  @@map("route_configs")
}

// Audit log for unauthorized access attempts
model AccessAttemptLog {
  id                    String   @id @default(cuid())

  // User info
  clerkUserId           String?  // Null if unauthenticated
  userEmail             String?
  userRole              String?
  username              String?

  // Attempt details
  attemptedRoute        String
  attemptedAction       String?  // 'view', 'edit', 'delete', etc.
  restrictionType       String   // 'page', 'content', 'route'
  restrictionId         String?  // ID of the restriction that blocked

  // Result
  wasBlocked            Boolean  @default(true)
  blockReason           String?  // 'role', 'username', 'not_authenticated'
  redirectedTo          String?

  // Request metadata
  ipAddress             String?
  userAgent             String?  @db.Text
  timestamp             DateTime @default(now())

  @@index([clerkUserId])
  @@index([attemptedRoute])
  @@index([timestamp])
  @@index([wasBlocked])
  @@map("access_attempt_logs")
}

// ============ Role Permission Templates ============

// Stores default permissions for each user role
// Allows super_admin to customize what each role gets by default
model RolePermissionTemplate {
  id          String   @id @default(cuid())
  role        String   @unique // 'super_admin', 'admin', 'tax_preparer', 'affiliate', 'lead', 'client'
  permissions Json     // JSON object of Permission -> boolean mapping

  // Audit trail
  updatedBy   String?  // Clerk user ID of super_admin who last updated
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([role])
  @@map("role_permission_templates")
}

// ============ Tax Assistant (OpenAI Integration) ============

// Stores OpenAI conversation threads for tax form assistance
model TaxAssistantThread {
  id                String   @id @default(cuid())

  // User identification
  clerkUserId       String   // Clerk user ID of tax preparer

  // OpenAI thread information
  openaiThreadId    String   @unique // OpenAI thread ID
  openaiAssistantId String   // OpenAI assistant ID used

  // Thread metadata
  title             String?  // Optional user-provided title
  lastMessage       String?  @db.Text // Preview of last message
  messageCount      Int      @default(0) // Number of messages in thread

  // Status
  isActive          Boolean  @default(true) // Is thread still active

  // Usage tracking
  tokensUsed        Int      @default(0) // Total tokens used in this thread
  costInCents       Int      @default(0) // Total cost in cents

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastMessageAt     DateTime @default(now()) // Last activity

  // Relations
  messages          TaxAssistantMessage[]

  @@index([clerkUserId])
  @@index([openaiThreadId])
  @@index([lastMessageAt])
  @@index([isActive])
  @@map("tax_assistant_threads")
}

// Stores individual messages within threads for history/analytics
model TaxAssistantMessage {
  id                String   @id @default(cuid())

  // Thread relationship
  threadId          String
  thread            TaxAssistantThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  // OpenAI message information
  openaiMessageId   String   @unique // OpenAI message ID

  // Message content
  role              String   // 'user' or 'assistant'
  content           String   @db.Text // Message content

  // Form references (extracted from assistant responses)
  formReferences    String[] // Array of form numbers mentioned (e.g., ["1040", "Schedule C"])

  // Usage tracking
  tokensUsed        Int      @default(0) // Tokens used for this message

  // Timestamps
  createdAt         DateTime @default(now())

  @@index([threadId, createdAt])
  @@index([openaiMessageId])
  @@map("tax_assistant_messages")
}

// ============ Mobile Hub Link Tracking ============

// Tracks clicks on shared links from mobile hub
model MobileHubLinkClick {
  id          String   @id @default(cuid())

  // User who shared the link
  clerkUserId String   // Clerk user ID of person who shared
  userRole    String   // Role at time of share (tax_preparer, affiliate, etc)

  // Link information
  linkType    String   // "intake", "lead", "referral", "tracking"
  linkUrl     String   @db.Text // Full URL that was shared
  trackingId  String   // Unique tracking identifier

  // Click information
  clickedAt   DateTime @default(now())
  ipAddress   String?  // IP of clicker (optional, for fraud detection)
  userAgent   String?  @db.Text // Browser/device info
  referrer    String?  @db.Text // Where they came from

  // Conversion tracking
  converted   Boolean  @default(false) // Did they complete the form/action?
  convertedAt DateTime? // When conversion happened

  @@index([clerkUserId, clickedAt])
  @@index([trackingId])
  @@index([linkType, clickedAt])
  @@map("mobile_hub_link_clicks")
}

// Tracks when users share links (not clicks, but share actions)
model MobileHubShare {
  id          String   @id @default(cuid())

  // User who shared
  clerkUserId String   // Clerk user ID
  userRole    String   // Role at time of share

  // Share information
  linkType    String   // "intake", "lead", "referral", "tracking"
  linkUrl     String   @db.Text
  trackingId  String   // Unique tracking identifier
  shareMethod String   // "native_share", "copy", "sms", "email", "whatsapp"

  // Metadata
  sharedAt    DateTime @default(now())

  @@index([clerkUserId, sharedAt])
  @@index([trackingId])
  @@map("mobile_hub_shares")
}

// Aggregated stats for quick dashboard display (updated via cron/triggers)
model MobileHubStats {
  id              String   @id @default(cuid())

  // User identification
  clerkUserId     String   @unique // Clerk user ID
  userRole        String   // Current role

  // Link tracking stats
  linkShares      Int      @default(0) // How many times they shared
  linkViews       Int      @default(0) // How many times links were viewed (estimate)
  linkClicks      Int      @default(0) // How many clicks on their links

  // Conversion stats
  formsStarted    Int      @default(0) // Forms opened from their links
  formsCompleted  Int      @default(0) // Forms completed from their links

  // Affiliate specific
  referrals       Int      @default(0) // Total referrals
  conversions     Int      @default(0) // Conversions (paid)
  earningsCents   Int      @default(0) // Total earnings in cents

  // Timestamps
  lastCalculated  DateTime @default(now()) // Last time stats were recalculated
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clerkUserId])
  @@map("mobile_hub_stats")
}
