// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ Authentication & Users ============

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  hashedPassword String?
  emailVerified  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  sessions      Session[]
  profile       Profile?
  oauthAccounts OAuthAccount[]
  magicLinks    MagicLink[]

  @@map("users")
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model OAuthAccount {
  providerId     String
  providerUserId String
  userId         String
  user           User   @relation(references: [id], fields: [userId], onDelete: Cascade)

  @@id([providerId, providerUserId])
  @@index([userId])
  @@map("oauth_accounts")
}

model MagicLink {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@map("magic_links")
}

// ============ User Profiles ============

enum UserRole {
  CLIENT
  REFERRER
  PREPARER
  ADMIN
}

model Profile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(references: [id], fields: [userId], onDelete: Cascade)
  role        UserRole
  firstName   String?
  lastName    String?
  phone       String?
  vanitySlug  String?  @unique // For referrers: TaxGenius.com/YourName
  avatarUrl   String?
  bio         String?
  companyName String?  // For preparers
  licenseNo   String?  // For preparers
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Encrypted sensitive data
  ssn           String? // Encrypted
  dateOfBirth   String? // Encrypted
  address       Json?   // Encrypted JSON
  bankDetails   Json?   // Encrypted JSON for commission payments

  // Relations
  referrerReferrals  Referral[]           @relation("ReferrerReferrals")
  clientReferrals    Referral[]           @relation("ClientReferrals")
  preparerClients    ClientPreparer[]    @relation("PreparerClients")
  clientPreparers    ClientPreparer[]    @relation("ClientPreparers")
  notifications      Notification[]
  contestParticipant ContestParticipant[]
  documents          Document[]
  taxReturns         TaxReturn[]
  payments           Payment[]
  commissions        Commission[]

  @@index([role])
  @@index([vanitySlug])
  @@map("profiles")
}

// ============ Referral System ============

enum ReferralStatus {
  PENDING
  ACTIVE
  COMPLETED
  INACTIVE
}

model Referral {
  id               String         @id @default(cuid())
  referrerId       String
  referrer         Profile        @relation("ReferrerReferrals", references: [id], fields: [referrerId], onDelete: Cascade)
  clientId         String
  client           Profile        @relation("ClientReferrals", references: [id], fields: [clientId], onDelete: Cascade)
  referralCode     String         @unique
  signupDate       DateTime       @default(now())
  status           ReferralStatus @default(PENDING)
  returnFiledDate  DateTime?
  commissionEarned Decimal        @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  analytics   ReferralAnalytics[]
  commissions Commission[]

  @@index([referrerId])
  @@index([clientId])
  @@index([referralCode])
  @@map("referrals")
}

enum AnalyticsEventType {
  LINK_CLICK
  SIGNUP
  RETURN_FILED
  COMMISSION_EARNED
}

model ReferralAnalytics {
  id             String             @id @default(cuid())
  referralId     String?
  referral       Referral?          @relation(references: [id], fields: [referralId], onDelete: Cascade)
  eventType      AnalyticsEventType
  eventDate      DateTime           @default(now())
  ipAddress      String?
  userAgent      String?
  referralSource String?
  metadata       Json?
  createdAt      DateTime           @default(now())

  @@index([referralId])
  @@index([eventType])
  @@map("referral_analytics")
}

// ============ Contest System ============

enum ContestType {
  MOST_REFERRALS
  MOST_RETURNS
  HIGHEST_EARNINGS
}

model Contest {
  id               String               @id @default(cuid())
  title            String
  description      String?
  startDate        DateTime
  endDate          DateTime
  contestType      ContestType
  prizeDescription String?
  rules            Json?
  isActive         Boolean              @default(true)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  // Relations
  participants ContestParticipant[]
  leaderboard  ContestLeaderboard[]

  @@index([isActive])
  @@index([startDate, endDate])
  @@map("contests")
}

model ContestParticipant {
  id        String   @id @default(cuid())
  contestId String
  contest   Contest  @relation(references: [id], fields: [contestId], onDelete: Cascade)
  profileId String
  profile   Profile  @relation(references: [id], fields: [profileId], onDelete: Cascade)
  score     Decimal  @default(0)
  rank      Int?
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([contestId, profileId])
  @@index([contestId])
  @@index([profileId])
  @@map("contest_participants")
}

model ContestLeaderboard {
  id             String   @id @default(cuid())
  contestId      String
  contest        Contest  @relation(references: [id], fields: [contestId], onDelete: Cascade)
  rank           Int
  profileId      String
  score          Decimal
  lastCalculated DateTime @default(now())

  @@unique([contestId, rank])
  @@index([contestId])
  @@map("contest_leaderboards")
}

// ============ Marketing Materials ============

enum MaterialType {
  IMAGE
  TEXT
  VIDEO
  TEMPLATE
}

model MarketingMaterial {
  id           String       @id @default(cuid())
  title        String
  description  String?
  materialType MaterialType
  imageUrl     String?
  adCopy       String?      @db.Text
  templateHtml String?      @db.Text
  tags         String[]
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([isActive])
  @@index([materialType])
  @@map("marketing_materials")
}

// ============ Notifications ============

enum NotificationType {
  TRIP_REWARD
  CONTEST_WIN
  MILESTONE
  GENERAL
  PAYMENT_RECEIVED
  RETURN_STATUS
  NEW_MESSAGE
}

model Notification {
  id          String           @id @default(cuid())
  profileId   String
  profile     Profile          @relation(references: [id], fields: [profileId], onDelete: Cascade)
  type        NotificationType
  title       String
  message     String           @db.Text
  actionUrl   String?
  actionLabel String?
  isRead      Boolean          @default(false)
  isActioned  Boolean          @default(false)
  metadata    Json?
  createdAt   DateTime         @default(now())
  readAt      DateTime?
  actionedAt  DateTime?

  @@index([profileId])
  @@index([isRead])
  @@index([type])
  @@map("notifications")
}

// ============ Tax Preparation ============

model ClientPreparer {
  id         String   @id @default(cuid())
  clientId   String
  client     Profile  @relation("ClientPreparers", references: [id], fields: [clientId], onDelete: Cascade)
  preparerId String
  preparer   Profile  @relation("PreparerClients", references: [id], fields: [preparerId], onDelete: Cascade)
  assignedAt DateTime @default(now())
  isActive   Boolean  @default(true)

  @@unique([clientId, preparerId])
  @@index([clientId])
  @@index([preparerId])
  @@map("client_preparers")
}

enum TaxReturnStatus {
  DRAFT
  IN_REVIEW
  FILED
  ACCEPTED
  REJECTED
  AMENDED
}

model TaxReturn {
  id           String          @id @default(cuid())
  profileId    String
  profile      Profile         @relation(references: [id], fields: [profileId], onDelete: Cascade)
  taxYear      Int
  status       TaxReturnStatus @default(DRAFT)
  filedDate    DateTime?
  acceptedDate DateTime?
  refundAmount Decimal?
  oweAmount    Decimal?
  formData     Json            @db.JsonB // Encrypted tax form data
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  documents Document[]
  payments  Payment[]

  @@unique([profileId, taxYear])
  @@index([profileId])
  @@index([status])
  @@map("tax_returns")
}

// ============ Documents ============

enum DocumentType {
  W2
  FORM_1099
  RECEIPT
  TAX_RETURN
  OTHER
}

model Document {
  id          String       @id @default(cuid())
  profileId   String
  profile     Profile      @relation(references: [id], fields: [profileId], onDelete: Cascade)
  taxReturnId String?
  taxReturn   TaxReturn?   @relation(references: [id], fields: [taxReturnId], onDelete: Cascade)
  type        DocumentType
  fileName    String
  fileUrl     String       // R2 storage URL
  fileSize    Int
  mimeType    String
  isEncrypted Boolean      @default(true)
  metadata    Json?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([profileId])
  @@index([taxReturnId])
  @@map("documents")
}

// ============ Payments & Commissions ============

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentType {
  TAX_PREP_FEE
  COMMISSION
  REFUND
}

model Payment {
  id              String        @id @default(cuid())
  profileId       String
  profile         Profile       @relation(references: [id], fields: [profileId], onDelete: Cascade)
  taxReturnId     String?
  taxReturn       TaxReturn?    @relation(references: [id], fields: [taxReturnId], onDelete: SetNull)
  amount          Decimal
  type            PaymentType
  status          PaymentStatus @default(PENDING)
  squarePaymentId String?       @unique
  squareOrderId   String?
  metadata        Json?
  processedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([profileId])
  @@index([status])
  @@index([squarePaymentId])
  @@map("payments")
}

model Commission {
  id          String        @id @default(cuid())
  referrerId  String
  referrer    Profile       @relation(references: [id], fields: [referrerId], onDelete: Cascade)
  referralId  String
  referral    Referral      @relation(references: [id], fields: [referralId], onDelete: Cascade)
  amount      Decimal
  status      PaymentStatus @default(PENDING)
  paidAt      DateTime?
  paymentRef  String?       // Reference to payment transaction
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([referrerId])
  @@index([referralId])
  @@index([status])
  @@map("commissions")
}

// ============ Chat/Messages ============

model ChatRoom {
  id        String    @id @default(cuid())
  name      String?
  isGroup   Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  participants ChatParticipant[]
  messages     ChatMessage[]

  @@map("chat_rooms")
}

model ChatParticipant {
  id         String   @id @default(cuid())
  roomId     String
  room       ChatRoom @relation(references: [id], fields: [roomId], onDelete: Cascade)
  profileId  String
  joinedAt   DateTime @default(now())
  lastReadAt DateTime @default(now())

  @@unique([roomId, profileId])
  @@index([roomId])
  @@index([profileId])
  @@map("chat_participants")
}

model ChatMessage {
  id        String   @id @default(cuid())
  roomId    String
  room      ChatRoom @relation(references: [id], fields: [roomId], onDelete: Cascade)
  senderId  String
  content   String   @db.Text
  metadata  Json?    // For attachments, etc.
  createdAt DateTime @default(now())
  editedAt  DateTime?
  deletedAt DateTime?

  @@index([roomId])
  @@index([senderId])
  @@map("chat_messages")
}