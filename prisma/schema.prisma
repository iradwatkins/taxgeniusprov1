// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ Authentication & Users ============

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  hashedPassword String?
  emailVerified  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  sessions      Session[]
  profile       Profile?
  oauthAccounts OAuthAccount[]
  magicLinks    MagicLink[]

  // CRM Relations (Epic 7)
  crmContact     CRMContact?
  crmInteractions CRMInteraction[]

  @@map("users")
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model OAuthAccount {
  providerId     String
  providerUserId String
  userId         String
  user           User   @relation(references: [id], fields: [userId], onDelete: Cascade)

  @@id([providerId, providerUserId])
  @@index([userId])
  @@map("oauth_accounts")
}

model MagicLink {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@map("magic_links")
}

// ============ User Profiles ============

enum UserRole {
  SUPER_ADMIN
  ADMIN
  LEAD          // Default role for new signups (pending admin approval)
  CLIENT        // User who has completed tax preparation with Tax Genius
  TAX_PREPARER  // Tax professional
  AFFILIATE     // Referrer working for Tax Genius (hasn't done taxes with us)
}

model Profile {
  id          String   @id @default(cuid())
  userId      String?  @unique // Lucia auth user ID (legacy)
  user        User?    @relation(references: [id], fields: [userId], onDelete: Cascade)
  clerkUserId String?  @unique // Clerk user ID (current)
  role        UserRole
  firstName   String?
  lastName    String?
  phone       String?
  vanitySlug  String?  @unique // For referrers: TaxGenius.com/YourName
  avatarUrl   String?
  bio         String?
  companyName String? // For preparers
  licenseNo   String? // For preparers
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Universal Tracking System (Auto-generated on signup)
  trackingCode        String?  @unique // Auto-generated unique code (e.g., "TGP-123456")
  customTrackingCode  String?  @unique // One-time customizable vanity code
  trackingCodeChanged Boolean  @default(false) // Enforce one-time change rule
  trackingCodeQRUrl   String?  @db.Text // Pre-generated QR code data URL

  // Short Link System (NEW - Epic 6)
  shortLinkUsername        String?  @unique // Username for short links (e.g., "irawatkins")
  shortLinkUsernameChanged Boolean  @default(false) // One-time change enforcement

  // Affiliate Bonding (NEW - Epic 6)
  affiliateBondedToPreparerId String? // For affiliates: which preparer they're bonded to

  // Encrypted sensitive data
  ssn         String? // Encrypted
  dateOfBirth String? // Encrypted
  address     Json? // Encrypted JSON
  bankDetails Json? // Encrypted JSON for commission payments

  // Relations
  referrerReferrals   Referral[]           @relation("ReferrerReferrals")
  clientReferrals     Referral[]           @relation("ClientReferrals")
  preparerClients     ClientPreparer[]     @relation("PreparerClients")
  clientPreparers     ClientPreparer[]     @relation("ClientPreparers")
  notifications       Notification[]
  contestParticipant  ContestParticipant[]
  documents           Document[]
  taxReturns          TaxReturn[]
  payments            Payment[]
  commissions         Commission[]
  payoutRequests      PayoutRequest[]      @relation("PayoutRequests")
  orders              Order[]
  subscriptions       Subscription[]
  campaigns           MarketingCampaign[]
  affiliateBondings   AffiliateBonding[]   @relation("AffiliateBondings")
  preparerBondings    AffiliateBonding[]   @relation("PreparerBondings")
  taxIntakeLeads      TaxIntakeLead[]      // Leads converted to this profile

  @@index([role])
  @@index([vanitySlug])
  @@index([clerkUserId])
  @@index([trackingCode])
  @@index([customTrackingCode])
  @@index([shortLinkUsername])
  @@index([affiliateBondedToPreparerId])
  @@map("profiles")
}

// ============ Referral System ============

enum ReferralStatus {
  PENDING
  ACTIVE
  COMPLETED
  INACTIVE
}

model Referral {
  id               String         @id @default(cuid())
  referrerId       String
  referrer         Profile        @relation("ReferrerReferrals", references: [id], fields: [referrerId], onDelete: Cascade)
  clientId         String
  client           Profile        @relation("ClientReferrals", references: [id], fields: [clientId], onDelete: Cascade)
  referralCode     String         @unique
  signupDate       DateTime       @default(now())
  status           ReferralStatus @default(PENDING)
  returnFiledDate  DateTime?
  commissionEarned Decimal        @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  analytics   ReferralAnalytics[]
  commissions Commission[]

  @@index([referrerId])
  @@index([clientId])
  @@index([referralCode])
  @@map("referrals")
}

enum AnalyticsEventType {
  LINK_CLICK
  SIGNUP
  RETURN_FILED
  COMMISSION_EARNED
}

model ReferralAnalytics {
  id             String             @id @default(cuid())
  referralId     String?
  referral       Referral?          @relation(references: [id], fields: [referralId], onDelete: Cascade)
  eventType      AnalyticsEventType
  eventDate      DateTime           @default(now())
  ipAddress      String?
  userAgent      String?
  referralSource String?
  metadata       Json?
  createdAt      DateTime           @default(now())

  @@index([referralId])
  @@index([eventType])
  @@map("referral_analytics")
}

// ============ Contest System ============

enum ContestType {
  MOST_REFERRALS
  MOST_RETURNS
  HIGHEST_EARNINGS
}

model Contest {
  id               String      @id @default(cuid())
  title            String
  description      String?
  startDate        DateTime
  endDate          DateTime
  contestType      ContestType
  prizeDescription String?
  rules            Json?
  isActive         Boolean     @default(true)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Relations
  participants ContestParticipant[]
  leaderboard  ContestLeaderboard[]

  @@index([isActive])
  @@index([startDate, endDate])
  @@map("contests")
}

model ContestParticipant {
  id        String   @id @default(cuid())
  contestId String
  contest   Contest  @relation(references: [id], fields: [contestId], onDelete: Cascade)
  profileId String
  profile   Profile  @relation(references: [id], fields: [profileId], onDelete: Cascade)
  score     Decimal  @default(0)
  rank      Int?
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([contestId, profileId])
  @@index([contestId])
  @@index([profileId])
  @@map("contest_participants")
}

model ContestLeaderboard {
  id             String   @id @default(cuid())
  contestId      String
  contest        Contest  @relation(references: [id], fields: [contestId], onDelete: Cascade)
  rank           Int
  profileId      String
  score          Decimal
  lastCalculated DateTime @default(now())

  @@unique([contestId, rank])
  @@index([contestId])
  @@map("contest_leaderboards")
}

// ============ Landing Pages (Epic 4) ============

model LandingPage {
  id              String   @id @default(cuid())
  slug            String   @unique
  city            String
  state           String?
  headline        String
  bodyContent     String   @db.Text
  metaTitle       String
  metaDescription String
  qaAccordion     Json // Array of {question: string, answer: string}
  generatedBy     String? // Clerk user ID of admin who generated
  version         Int      @default(1)
  isPublished     Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
  @@index([isPublished])
  @@index([city])
  @@map("landing_pages")
}

// ============ Marketing Materials ============

enum MaterialType {
  IMAGE
  TEXT
  VIDEO
  TEMPLATE
}

model MarketingMaterial {
  id           String       @id @default(cuid())
  title        String
  description  String?
  materialType MaterialType
  imageUrl     String?
  adCopy       String?      @db.Text
  templateHtml String?      @db.Text
  tags         String[]
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([isActive])
  @@index([materialType])
  @@map("marketing_materials")
}

// ============ Notifications ============

enum NotificationType {
  TRIP_REWARD
  CONTEST_WIN
  MILESTONE
  GENERAL
  PAYMENT_RECEIVED
  RETURN_STATUS
  NEW_MESSAGE
}

model Notification {
  id          String           @id @default(cuid())
  profileId   String
  profile     Profile          @relation(references: [id], fields: [profileId], onDelete: Cascade)
  type        NotificationType
  title       String
  message     String           @db.Text
  actionUrl   String?
  actionLabel String?
  isRead      Boolean          @default(false)
  isActioned  Boolean          @default(false)
  metadata    Json?
  createdAt   DateTime         @default(now())
  readAt      DateTime?
  actionedAt  DateTime?

  @@index([profileId])
  @@index([isRead])
  @@index([type])
  @@map("notifications")
}

// ============ Tax Preparation ============

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

model PreparerApplication {
  id              String            @id @default(cuid())
  firstName       String
  middleName      String?
  lastName        String
  email           String            @unique
  phone           String
  languages       String
  smsConsent      Boolean           @default(false)
  experienceLevel String? // "NEW" | "INTERMEDIATE" | "SEASONED"
  taxSoftware     String[]          @default([]) // Array of tax software used
  status          ApplicationStatus @default(PENDING)
  interviewDate   DateTime?
  notes           String?           @db.Text
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([email])
  @@index([status])
  @@map("preparer_applications")
}

enum ReferrerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model ReferrerApplication {
  id           String         @id @default(cuid())
  firstName    String
  lastName     String
  email        String         @unique
  phone        String
  referralCode String         @unique
  status       ReferrerStatus @default(ACTIVE)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([email])
  @@index([referralCode])
  @@index([status])
  @@map("referrer_applications")
}

model ClientPreparer {
  id         String   @id @default(cuid())
  clientId   String
  client     Profile  @relation("ClientPreparers", references: [id], fields: [clientId], onDelete: Cascade)
  preparerId String
  preparer   Profile  @relation("PreparerClients", references: [id], fields: [preparerId], onDelete: Cascade)
  assignedAt DateTime @default(now())
  isActive   Boolean  @default(true)

  @@unique([clientId, preparerId])
  @@index([clientId])
  @@index([preparerId])
  @@map("client_preparers")
}

// ============ Affiliate Bonding System (NEW - Epic 6) ============

model AffiliateBonding {
  id          String   @id @default(cuid())
  affiliateId String
  affiliate   Profile  @relation("AffiliateBondings", references: [id], fields: [affiliateId], onDelete: Cascade)
  preparerId  String
  preparer    Profile  @relation("PreparerBondings", references: [id], fields: [preparerId], onDelete: Cascade)
  bondedAt    DateTime @default(now())
  isActive    Boolean  @default(true)

  // Tax preparer's custom commission structure for this affiliate
  commissionStructure Json? // Example: {"tier1": {"count": 5, "rate": 50}, "tier2": {"count": 10, "rate": 75}}

  @@unique([affiliateId, preparerId])
  @@index([affiliateId, isActive])
  @@index([preparerId, isActive])
  @@map("affiliate_bondings")
}

enum TaxReturnStatus {
  DRAFT
  IN_REVIEW
  FILED
  ACCEPTED
  REJECTED
  AMENDED
}

model TaxReturn {
  id           String          @id @default(cuid())
  profileId    String
  profile      Profile         @relation(references: [id], fields: [profileId], onDelete: Cascade)
  taxYear      Int
  status       TaxReturnStatus @default(DRAFT)
  filedDate    DateTime?
  acceptedDate DateTime?
  refundAmount Decimal?
  oweAmount    Decimal?
  formData     Json            @db.JsonB // Encrypted tax form data
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  documents      Document[]
  payments       Payment[]
  sourceLead     TaxIntakeLead[] // If created from intake lead

  @@unique([profileId, taxYear])
  @@index([profileId])
  @@index([status])
  @@map("tax_returns")
}

// ============ Store & Marketing ============

model Product {
  id           String   @id @default(cuid())
  type         String   // "LANDING_PAGE", "MARKETING_MATERIAL", "EMAIL_ADDRESS", "DIGITAL_ASSET"
  name         String
  description  String?  @db.Text
  category     String?  // Product category for organization

  // Pricing
  price        Decimal  @db.Decimal(10, 2)
  recurring    Boolean  @default(false)
  interval     String?  // "MONTHLY", "6_MONTHS", "12_MONTHS"

  // Access control
  availableFor String[] // ["TAX_PREPARER", "AFFILIATE"]

  imageUrl     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  subscriptions Subscription[]

  @@index([type])
  @@index([isActive])
  @@index([category])
  @@map("products")
}

model Subscription {
  id          String   @id @default(cuid())
  profileId   String
  profile     Profile  @relation(references: [id], fields: [profileId], onDelete: Cascade)
  productId   String
  product     Product  @relation(references: [id], fields: [productId], onDelete: Cascade)

  status      String   // "ACTIVE", "CANCELLED", "EXPIRED"
  startDate   DateTime @default(now())
  endDate     DateTime?

  stripeSubId String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([profileId])
  @@index([status])
  @@map("subscriptions")
}

model MarketingCampaign {
  id            String   @id @default(cuid())
  creatorId     String
  creator       Profile  @relation(references: [id], fields: [creatorId], onDelete: Cascade)

  name          String
  type          String   // "QR_CODE", "SOCIAL_POST", "EMAIL", "LANDING_PAGE", "BUSINESS_CARD", "FLYER"

  // Customization (for tax preparers)
  isCustomized  Boolean  @default(false)
  customName    String?
  customPhoto   String?
  customPhone   String?
  customLicense String?

  // Tracking
  trackingCode  String   @unique
  landingUrl    String?
  qrCodeUrl     String?

  // Analytics
  views         Int      @default(0)
  clicks        Int      @default(0)
  signups       Int      @default(0)
  conversions   Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([creatorId])
  @@index([trackingCode])
  @@map("marketing_campaigns")
}

// ============ Documents ============

enum DocumentType {
  W2
  FORM_1099
  RECEIPT
  TAX_RETURN
  OTHER
}

enum DocumentStatus {
  PENDING        // Uploaded, waiting for review
  REVIEWED       // Reviewed by preparer
  APPROVED       // Approved for filing
  REJECTED       // Rejected, needs reupload
  PROCESSING     // Being processed
}

model Document {
  id          String          @id @default(cuid())
  profileId   String
  profile     Profile         @relation(references: [id], fields: [profileId], onDelete: Cascade)
  taxReturnId String?
  taxReturn   TaxReturn?      @relation(references: [id], fields: [taxReturnId], onDelete: Cascade)
  type        DocumentType
  fileName    String
  fileUrl     String          // R2 storage URL
  fileSize    Int
  mimeType    String
  isEncrypted Boolean         @default(true)
  metadata    Json?

  // Tax year and status tracking
  taxYear     Int             // Tax year this document belongs to (2024, 2023, etc.)
  status      DocumentStatus  @default(PENDING)

  // Review information (for tax preparers)
  reviewedBy  String?         // Profile ID of preparer who reviewed
  reviewedAt  DateTime?       // When document was reviewed
  reviewNotes String?         @db.Text // Review notes from preparer

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([profileId])
  @@index([taxReturnId])
  @@index([taxYear])
  @@index([status])
  @@index([reviewedBy])
  @@map("documents")
}

// ============ Payments & Commissions ============

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentType {
  TAX_PREP_FEE
  COMMISSION
  REFUND
}

model Payment {
  id              String        @id @default(cuid())
  profileId       String
  profile         Profile       @relation(references: [id], fields: [profileId], onDelete: Cascade)
  taxReturnId     String?
  taxReturn       TaxReturn?    @relation(references: [id], fields: [taxReturnId], onDelete: SetNull)
  amount          Decimal
  type            PaymentType
  status          PaymentStatus @default(PENDING)
  squarePaymentId String?       @unique
  squareOrderId   String?
  metadata        Json?
  processedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([profileId])
  @@index([status])
  @@index([squarePaymentId])
  @@map("payments")
}

model Commission {
  id         String        @id @default(cuid())
  referrerId String
  referrer   Profile       @relation(references: [id], fields: [referrerId], onDelete: Cascade)
  referralId String
  referral   Referral      @relation(references: [id], fields: [referralId], onDelete: Cascade)
  amount     Decimal

  // Rate Locking (NEW - Epic 6)
  rateAtCreation   Decimal?  @db.Decimal(5, 2) // Commission rate when lead was created
  calculatedAmount Decimal?  @db.Decimal(10, 2) // Auto-calculated commission

  status     PaymentStatus @default(PENDING)
  paidAt     DateTime?
  paymentRef String? // Reference to payment transaction
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@index([referrerId])
  @@index([referralId])
  @@index([status])
  @@index([createdAt])
  @@map("commissions")
}

// Payout Request Model (Epic 5 - Story 5.2)
model PayoutRequest {
  id            String   @id @default(cuid())
  referrerId    String
  referrer      Profile  @relation("PayoutRequests", fields: [referrerId], references: [id], onDelete: Cascade)
  amount        Decimal  @db.Decimal(10, 2)
  commissionIds String[] // Array of commission IDs included in this payout
  status        String   @default("PENDING") // PENDING, APPROVED, PAID, REJECTED
  paymentMethod String   @default("BANK_TRANSFER") // BANK_TRANSFER, PAYPAL, SQUARE_CASH, etc.
  notes         String?  @db.Text
  requestedAt   DateTime @default(now())
  processedAt   DateTime?
  paymentRef    String? // Reference to payment transaction
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([referrerId])
  @@index([status])
  @@index([requestedAt])
  @@map("payout_requests")
}

// ============ Chat/Messages ============

model ChatRoom {
  id        String   @id @default(cuid())
  name      String?
  isGroup   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  participants ChatParticipant[]
  messages     ChatMessage[]

  @@map("chat_rooms")
}

model ChatParticipant {
  id         String   @id @default(cuid())
  roomId     String
  room       ChatRoom @relation(references: [id], fields: [roomId], onDelete: Cascade)
  profileId  String
  joinedAt   DateTime @default(now())
  lastReadAt DateTime @default(now())

  @@unique([roomId, profileId])
  @@index([roomId])
  @@index([profileId])
  @@map("chat_participants")
}

model ChatMessage {
  id        String    @id @default(cuid())
  roomId    String
  room      ChatRoom  @relation(references: [id], fields: [roomId], onDelete: Cascade)
  senderId  String
  content   String    @db.Text
  metadata  Json? // For attachments, etc.
  createdAt DateTime  @default(now())
  editedAt  DateTime?
  deletedAt DateTime?

  @@index([roomId])
  @@index([senderId])
  @@map("chat_messages")
}

// ============ Lead Generation ============

enum LeadType {
  CUSTOMER
  TAX_PREPARER
  AFFILIATE
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  DISQUALIFIED
}

model Lead {
  id        String     @id @default(cuid())
  type      LeadType
  status    LeadStatus @default(NEW)

  // Basic contact info (all types)
  firstName String
  lastName  String
  email     String
  phone     String

  // Customer-specific fields
  taxSituation    String? @db.Text
  estimatedIncome String?

  // Tax Preparer-specific fields
  ptin          String?
  certification String?
  experience    String?

  // Affiliate-specific fields
  marketingExperience String?
  audience            String?

  // Common optional fields
  message String? @db.Text

  // Metadata
  source        String? // URL/page where lead was captured
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  ipAddress     String?
  userAgent     String?

  // Attribution & Commission Locking (NEW - Epic 6)
  referrerUsername         String? // Username of referrer who brought this lead
  referrerType             String? // TAX_PREPARER, AFFILIATE, CLIENT, ADMIN
  commissionRate           Decimal?  @db.Decimal(5, 2) // Locked rate at lead creation
  commissionRateLockedAt   DateTime? // When rate was locked
  attributionMethod        String? // "cookie", "email_match", "phone_match", "direct"
  attributionCookieId      String? // Cookie ID used for attribution
  attributionConfidence    Int      @default(100) // 0-100 confidence score

  // Assignment & Follow-up tracking
  assignedPreparerId String? // Which preparer is handling this lead
  contactRequested   Boolean  @default(false) // Did they request a call/appointment?
  contactMethod      String? // "CALL", "APPOINTMENT", "EMAIL"
  lastContactedAt    DateTime? // When preparer last reached out
  contactNotes       String?  @db.Text // Notes from contact attempts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([email])
  @@index([createdAt])
  @@index([assignedPreparerId])
  @@index([contactRequested])
  @@index([referrerUsername])
  @@index([commissionRateLockedAt])
  @@index([attributionMethod])
  @@map("leads")
}

// ============ E-commerce / Store ============
// (Product model moved to Store & Marketing section above)

enum OrderStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Order {
  id              String      @id @default(cuid())
  userId          String
  profile         Profile     @relation(fields: [userId], references: [clerkUserId], onDelete: Cascade)
  stripeSessionId String      @unique
  items           Json // Array of { productId, name, quantity, price }
  total           Decimal     @db.Decimal(10, 2)
  status          OrderStatus @default(PENDING)
  email           String
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

// ============ Tax Intake Form Leads ============

model TaxIntakeLead {
  id            String   @id @default(cuid())

  // Personal Information
  first_name    String
  middle_name   String?
  last_name     String
  email         String   @unique
  phone         String
  country_code  String   @default("+1")

  // Address
  address_line_1 String?
  address_line_2 String?
  city           String?
  state          String?
  zip_code       String?

  // Full form data (JSON for remaining fields)
  full_form_data Json?    @db.JsonB

  // Tracking
  completed      Boolean  @default(false)

  // Attribution (NEW - Epic 6)
  referrerUsername  String? // Username who referred this intake
  referrerType      String? // TAX_PREPARER, AFFILIATE, CLIENT, ADMIN
  attributionMethod String? // "cookie", "email_match", "phone_match", "direct"

  // Assignment & Follow-up tracking
  assignedPreparerId String? // Which preparer is handling this intake
  contactRequested   Boolean  @default(false) // Did they request a call/appointment?
  contactMethod      String? // "CALL", "APPOINTMENT", "EMAIL"
  lastContactedAt    DateTime? // When preparer last reached out
  contactNotes       String?  @db.Text // Notes from contact attempts

  // Lead-to-Client Conversion (NEW - Auto-conversion)
  profileId         String?   // Link to Profile when user signs up
  profile           Profile?  @relation(fields: [profileId], references: [id], onDelete: SetNull)
  convertedToClient Boolean   @default(false) // Has this lead been converted to a client?
  taxReturnId       String?   // Track created TaxReturn
  taxReturn         TaxReturn? @relation(fields: [taxReturnId], references: [id], onDelete: SetNull)
  convertedAt       DateTime? // When conversion happened

  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  @@index([email])
  @@index([completed])
  @@index([created_at])
  @@index([assignedPreparerId])
  @@index([contactRequested])
  @@index([referrerUsername])
  @@index([attributionMethod])
  @@index([profileId])
  @@index([convertedToClient])
  @@index([taxReturnId])
  @@map("tax_intake_leads")
}

// ============ Page Analytics & Performance Tracking ============

model PageAnalytics {
  id             String   @id @default(cuid())
  path           String   // "/start-filing", "/services", etc
  views          Int      @default(0)
  uniqueVisitors Int      @default(0)
  bounceRate     Float?   // Percentage (0-100)
  avgTimeOnPage  Int?     // seconds
  conversions    Int      @default(0) // leads/signups from this page
  source         String?  // "organic", "direct", "referral", "social", "paid"
  referrer       String?  // Full referrer URL
  date           DateTime @default(now())
  createdAt      DateTime @default(now())

  @@index([path, date])
  @@index([date])
  @@index([source])
  @@map("page_analytics")
}

model ContentPerformance {
  id              String   @id @default(cuid())
  landingPageId   String?  // FK to LandingPage
  contentType     String   // "ai_generated", "manual", "template"
  title           String?  // Page/content title for identification
  views           Int      @default(0)
  clicks          Int      @default(0)
  conversions     Int      @default(0)
  ctr             Float?   // click-through rate (percentage)
  conversionRate  Float?   // conversion rate (percentage)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([landingPageId])
  @@index([contentType])
  @@index([createdAt])
  @@map("content_performance")
}

// ============ Client Intake Tracking ============

model ClientIntake {
  id        String   @id @default(cuid())

  // Client information
  firstName String
  lastName  String
  email     String
  phone     String

  // Assignment
  assignedPreparerId String? // Which preparer received this intake
  referredBy         String? // Referrer ID if came from referral link
  sourceLink         String? // Marketing link that brought them here

  // Form data
  formData  Json     @db.JsonB // Complete intake form data

  // Status tracking
  status    String   @default("SUBMITTED") // SUBMITTED, CONTACTED, IN_PROGRESS, COMPLETED

  // Conversion tracking
  convertedToClient Boolean  @default(false)
  convertedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assignedPreparerId])
  @@index([referredBy])
  @@index([status])
  @@index([createdAt])
  @@map("client_intakes")
}

// ============ Marketing Link Tracking ============

enum LinkType {
  REFERRAL
  LANDING_PAGE
  QR_CODE        // Keep for backward compatibility
  SOCIAL_MEDIA
  EMAIL_CAMPAIGN
  BUSINESS_CARD
  FLYER
  CUSTOM

  // NEW: Specific QR types (Epic 6 - Story 6.2)
  QR_POSTER
  QR_FLYER
  QR_BUSINESS_CARD
  QR_TABLE_TENT
  QR_BANNER
  DIGITAL_AD
  SMS_LINK
  WEBSITE_REFERRAL
}

model MarketingLink {
  id          String   @id @default(cuid())

  // Link ownership
  creatorId   String // Profile ID of preparer/referrer who created link
  creatorType String // "TAX_PREPARER", "REFERRER", "AFFILIATE", "ADMIN"

  // Link details
  linkType    LinkType
  code        String   @unique // Unique tracking code (e.g., "atlanta-taxes-john")
  url         String   // Full URL with tracking
  shortUrl    String?  // Shortened URL if applicable

  // Metadata
  title       String?  // Human-readable title ("John's Atlanta Flyer")
  description String?  @db.Text
  campaign    String?  // Campaign name for grouping

  // Destination
  targetPage  String   // Where the link goes ("/start-filing", "/services", etc)

  // Analytics (cached counts for performance)
  clicks      Int      @default(0)
  uniqueClicks Int     @default(0)
  conversions Int      @default(0) // Intake forms submitted
  signups     Int      @default(0) // Account creations
  returns     Int      @default(0) // Returns filed

  // NEW: Journey stage counters (Epic 6)
  intakeStarts    Int @default(0)
  intakeCompletes Int @default(0)
  returnsFiled    Int @default(0)

  // Performance metrics (calculated)
  conversionRate Float? // (conversions / clicks) * 100
  signupRate     Float? // (signups / clicks) * 100

  // NEW: Conversion rate caching (Epic 6)
  intakeConversionRate   Float? // (intakeStarts / clicks) * 100
  completeConversionRate Float? // (intakeCompletes / clicks) * 100
  filedConversionRate    Float? // (returnsFiled / clicks) * 100

  // NEW: Material-specific fields (Epic 6 - Story 6.2)
  location       String?  // Where material is placed/distributed
  notes          String?  @db.Text // Distribution notes, renewal dates
  qrCodeImageUrl String?  // Base64 data URL or storage URL of generated QR code
  qrCodeFormat   String?  @default("PNG") // PNG, SVG, PDF

  // NEW: Material lifecycle (Epic 6 - Story 6.2)
  dateActivated  DateTime? // When material was first distributed
  dateExpired    DateTime? // If material has expiration date
  printCount     Int @default(0) // How many times QR was downloaded

  // Status
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  linkClicks  LinkClick[]

  @@index([creatorId])
  @@index([code])
  @@index([linkType])
  @@index([isActive])
  @@index([createdAt])
  @@index([creatorId, isActive])
  @@index([linkType, isActive])
  // NEW: Performance indexes for Top 15 queries (Epic 6 - Story 6.3)
  @@index([creatorType, isActive, returnsFiled(sort: Desc)])
  @@index([isActive, returnsFiled(sort: Desc)])
  @@index([createdAt, isActive])
  @@map("marketing_links")
}

model LinkClick {
  id        String   @id @default(cuid())

  linkId    String
  link      MarketingLink @relation(references: [id], fields: [linkId], onDelete: Cascade)

  // Click metadata
  ipAddress String?
  userAgent String?
  referrer  String?  // Where they came from before clicking

  // Location (if tracked)
  city      String?
  state     String?
  country   String?

  // Conversion tracking
  converted Boolean  @default(false) // Did they submit intake form?
  signedUp  Boolean  @default(false) // Did they create account?
  clientId  String? // Profile ID if they converted

  clickedAt DateTime @default(now())

  // NEW: Journey stage timestamps (Epic 6)
  intakeStartedAt      DateTime?
  intakeCompletedAt    DateTime?
  taxReturnCompletedAt DateTime?

  // NEW: Enhanced UTM tracking (Epic 6)
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?

  // NEW: Cross-device attribution (Epic 6)
  userEmail              String? // Email entered in form (for device-agnostic attribution)
  userPhone              String? // Phone entered in form (for device-agnostic attribution)
  attributionConfidence  Int     @default(100) // 0-100 confidence score

  @@index([linkId])
  @@index([clickedAt])
  @@index([converted])
  @@index([intakeStartedAt])
  @@index([intakeCompletedAt])
  @@index([taxReturnCompletedAt])
  @@index([userEmail])
  @@index([userPhone])
  // NEW: Performance indexes for Top 15 Locations query (Epic 6 - Story 6.3)
  @@index([city, state, clickedAt])
  @@index([clickedAt, city, state])
  @@map("link_clicks")
}

// ============ Appointment Management ============

enum AppointmentStatus {
  REQUESTED      // Client requested appointment
  SCHEDULED      // Preparer scheduled it
  CONFIRMED      // Client confirmed
  COMPLETED      // Appointment happened
  CANCELLED      // Cancelled by either party
  NO_SHOW        // Client didn't show up
  RESCHEDULED    // Moved to different time
}

enum AppointmentType {
  PHONE_CALL
  VIDEO_CALL
  IN_PERSON
  CONSULTATION
  FOLLOW_UP
}

model Appointment {
  id          String            @id @default(cuid())

  // Who
  clientId    String // Profile ID or Lead ID
  clientName  String // For quick display
  clientEmail String
  clientPhone String

  preparerId  String // Profile ID of assigned preparer

  // What type
  type        AppointmentType
  status      AppointmentStatus @default(REQUESTED)

  // When
  requestedAt DateTime          @default(now()) // When client requested
  scheduledFor DateTime?        // When it's scheduled
  duration    Int?              // Minutes
  timezone    String?           // Client timezone

  // Details
  subject     String?           // "Initial Consultation", "Tax Review", etc
  notes       String?           @db.Text // Preparer notes
  clientNotes String?           @db.Text // What client said in request

  // Meeting details
  meetingLink String?           // Zoom/Google Meet link
  location    String?           // Physical address if in-person

  // Reminders sent
  reminderSent Boolean          @default(false)
  reminderSentAt DateTime?

  // Completion
  completedAt DateTime?
  outcomeNotes String?          @db.Text // What happened in meeting

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([preparerId])
  @@index([clientId])
  @@index([status])
  @@index([scheduledFor])
  @@index([createdAt])
  @@map("appointments")
}

// ============ Follow-Up Log ============

enum FollowUpMethod {
  PHONE_CALL
  EMAIL
  TEXT_MESSAGE
  IN_PERSON
  VIDEO_CALL
}

enum FollowUpOutcome {
  CONNECTED     // Reached them
  NO_ANSWER     // No answer, left voicemail
  LEFT_MESSAGE  // Left voicemail/message
  EMAIL_SENT    // Email sent
  SCHEDULED     // Scheduled appointment
  CONVERTED     // They became a client
  NOT_INTERESTED // They declined
  UNREACHABLE   // Can't reach them
}

model FollowUpLog {
  id        String          @id @default(cuid())

  // Who
  clientId  String // Lead ID or Profile ID
  preparerId String // Who made the contact attempt

  // What happened
  method    FollowUpMethod
  outcome   FollowUpOutcome

  // Details
  notes     String?         @db.Text // What was discussed
  duration  Int?            // Minutes (for calls/meetings)

  // Next action
  nextFollowUp DateTime?    // When to follow up again
  nextAction   String?      // What to do next

  contactedAt DateTime      @default(now())
  createdAt   DateTime      @default(now())

  @@index([clientId])
  @@index([preparerId])
  @@index([contactedAt])
  @@index([nextFollowUp])
  @@map("follow_up_logs")
}

// ============ CRM System (Epic 7) ============

enum ContactType {
  CLIENT
  LEAD
  AFFILIATE
  PREPARER
}

enum PipelineStage {
  NEW
  CONTACTED
  DOCUMENTS
  PREPARING
  COMPLETE
}

enum InteractionType {
  EMAIL
  PHONE_CALL
  MEETING
  NOTE
  OTHER
}

enum Direction {
  INBOUND
  OUTBOUND
}

// CRM Contact (extends existing User/Client/Preparer/Affiliate)
model CRMContact {
  id                String    @id @default(cuid())
  userId            String?   @unique  // FK to User table (legacy Lucia) - nullable for leads without users
  clerkUserId       String?   @unique  // FK to Clerk user (current)
  contactType       ContactType        // CLIENT | LEAD | AFFILIATE | PREPARER

  // Contact metadata
  firstName         String
  lastName          String
  email             String    @unique
  phone             String?
  company           String?

  // Tax-specific fields
  filingStatus      String?   // Single, Married, etc.
  dependents        Int?
  previousYearAGI   Float?
  taxYear           Int?

  // CRM lifecycle
  stage             PipelineStage @default(NEW)
  stageEnteredAt    DateTime  @default(now())
  source            String?   // utm_source, referral code, etc.

  // Assignment
  assignedPreparerId String?
  assignedAt        DateTime?

  // Lead Attribution (Epic 6 integration)
  referrerUsername         String? // Username of referrer who brought this lead
  referrerType             String? // TAX_PREPARER, AFFILIATE, CLIENT, ADMIN
  commissionRate           Decimal?  @db.Decimal(5, 2) // Locked rate at lead creation
  commissionRateLockedAt   DateTime? // When rate was locked
  attributionMethod        String? // "cookie", "email_match", "phone_match", "direct"
  attributionConfidence    Int      @default(100) // 0-100 confidence score

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastContactedAt   DateTime?

  // Relations
  user              User?     @relation(fields: [userId], references: [id])
  interactions      CRMInteraction[]
  stageHistory      CRMStageHistory[]

  @@index([email])
  @@index([userId])
  @@index([clerkUserId])
  @@index([assignedPreparerId])
  @@index([stage])
  @@index([contactType])
  @@index([lastContactedAt])
  @@index([referrerUsername])
  @@map("crm_contacts")
}

// CRM Interaction (phone, email, meeting, note)
model CRMInteraction {
  id                String    @id @default(cuid())
  contactId         String
  userId            String?   // Who logged this interaction (legacy Lucia)
  clerkUserId       String?   // Who logged this interaction (current Clerk)

  // Interaction details
  type              InteractionType
  direction         Direction @default(OUTBOUND) // INBOUND | OUTBOUND
  subject           String?
  body              String?   @db.Text
  duration          Int?      // minutes (for calls/meetings)

  // Email-specific (for Resend sync)
  emailId           String?   @unique // Resend email ID
  emailThreadId     String?   // For Gmail-style threading
  emailTo           String[]
  emailCc           String[]
  emailBcc          String[]

  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  occurredAt        DateTime  @default(now()) // When interaction happened

  // Attachments
  attachments       Json?     // Array of MinIO file keys

  // Relations
  contact           CRMContact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user              User?     @relation(fields: [userId], references: [id])

  @@index([contactId, occurredAt(sort: Desc)])
  @@index([emailThreadId])
  @@index([type])
  @@index([userId])
  @@index([clerkUserId])
  @@map("crm_interactions")
}

// Stage history tracking (for reporting)
model CRMStageHistory {
  id                String    @id @default(cuid())
  contactId         String
  fromStage         PipelineStage?
  toStage           PipelineStage
  changedBy         String?   // userId (legacy Lucia)
  changedByClerk    String?   // clerkUserId (current)
  reason            String?   @db.Text
  createdAt         DateTime  @default(now())

  contact           CRMContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId, createdAt(sort: Desc)])
  @@index([changedByClerk])
  @@map("crm_stage_history")
}

// ============ Content Restrictions (Role-Based Access Control) ============

// Page/Route level restrictions
model PageRestriction {
  id                    String   @id @default(cuid())
  routePath             String   @unique // e.g., '/admin/users', '/dashboard/client/*'

  // Role-based access
  allowedRoles          String[] // Roles that CAN access (empty = all)
  blockedRoles          String[] // Roles that CANNOT access (takes priority)

  // Username-based access (highest priority)
  allowedUsernames      String[] // Usernames that always have access
  blockedUsernames      String[] // Usernames that are always blocked

  // Behavior settings
  allowNonLoggedIn      Boolean  @default(false) // Allow unauthenticated users
  redirectUrl           String?  // Custom redirect URL on block
  hideFromNav           Boolean  @default(false) // Hide from navigation menus
  showInNavOverride     Boolean  @default(false) // Force show in nav even if restricted

  // Custom blocking content
  customHtmlOnBlock     String?  @db.Text // Custom HTML/React to show when blocked

  // Priority and Status (NEW - for pattern matching & rule ordering)
  priority              Int      @default(0) // Higher = checked first (for wildcard patterns)
  isActive              Boolean  @default(true) // Enable/disable rule without deleting

  // Metadata
  description           String?  @db.Text // Admin note about this restriction
  createdBy             String?  // Clerk user ID who created this
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([routePath])
  @@index([isActive])
  @@index([priority])
  @@map("page_restrictions")
}

// Content/Component level restrictions (for sections within pages)
model ContentRestriction {
  id                    String   @id @default(cuid())
  contentType           String   // 'section', 'component', 'widget', 'feature'
  contentIdentifier     String   // Unique ID for the content piece

  // Role-based access
  allowedRoles          String[]
  blockedRoles          String[]

  // Username-based access (highest priority)
  allowedUsernames      String[]
  blockedUsernames      String[]

  // Visibility controls
  hideFromFrontend      Boolean  @default(false) // Hide but keep in API/data
  hideConditions        Json?    // Complex conditional hiding rules

  // Metadata
  description           String?  @db.Text
  createdBy             String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([contentType, contentIdentifier])
  @@index([contentType])
  @@index([contentIdentifier])
  @@map("content_restrictions")
}

// Dynamic route configuration (database-driven route protection)
model RouteConfig {
  id                    String   @id @default(cuid())
  routePattern          String   @unique // Pattern matching: '/admin/*', '/dashboard/:role/*'

  // Access control
  requiresAuth          Boolean  @default(true)
  allowedRoles          String[] // Empty = all authenticated users

  // Behavior
  redirectOnUnauth      String?  // Redirect unauthenticated users
  redirectOnForbidden   String?  // Redirect unauthorized (wrong role) users
  priority              Int      @default(0) // Higher priority patterns checked first

  // Settings
  enabled               Boolean  @default(true)
  description           String?  @db.Text

  // Metadata
  createdBy             String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([routePattern])
  @@index([priority])
  @@map("route_configs")
}

// Audit log for unauthorized access attempts
model AccessAttemptLog {
  id                    String   @id @default(cuid())

  // User info
  clerkUserId           String?  // Null if unauthenticated
  userEmail             String?
  userRole              String?
  username              String?

  // Attempt details
  attemptedRoute        String
  attemptedAction       String?  // 'view', 'edit', 'delete', etc.
  restrictionType       String   // 'page', 'content', 'route'
  restrictionId         String?  // ID of the restriction that blocked

  // Result
  wasBlocked            Boolean  @default(true)
  blockReason           String?  // 'role', 'username', 'not_authenticated'
  redirectedTo          String?

  // Request metadata
  ipAddress             String?
  userAgent             String?  @db.Text
  timestamp             DateTime @default(now())

  @@index([clerkUserId])
  @@index([attemptedRoute])
  @@index([timestamp])
  @@index([wasBlocked])
  @@map("access_attempt_logs")
}
